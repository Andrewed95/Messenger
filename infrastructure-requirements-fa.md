# نیازمندی‌های زیرساختی برای راه‌اندازی پیام‌رسان

---

## ۱. ایجاد رکوردهای DNS

لطفاً ۷ رکورد DNS از نوع A روی دامنه `nilva.dev` ایجاد کنید. تمام این رکوردها باید به آدرس IP گیت‌وی یعنی `93.114.108.72` اشاره کنند.

| رکورد | نوع | مقدار |
|-------|-----|-------|
| matrix.nilva.dev | A | 93.114.108.72 |
| chat.nilva.dev | A | 93.114.108.72 |
| turn.nilva.dev | A | 93.114.108.72 |
| grafana.nilva.dev | A | 93.114.108.72 |
| chat-li.nilva.dev | A | 93.114.108.72 |
| admin-li.nilva.dev | A | 93.114.108.72 |
| keyvault.nilva.dev | A | 93.114.108.72 |

همچنین برای هر ۷ ساب‌دامین بالا، گواهی SSL/TLS نیاز است. می‌توانید از Let's Encrypt استفاده کنید یا یک گواهی Wildcard برای `*.nilva.dev` تهیه کنید.

---

## ۲. رزرو آدرس‌های IP داخلی (انجام شد ✅)

رنج IP زیر برای سرویس‌های Kubernetes رزرو شده است:

**رنج رزرو شده:** `192.168.10.190` تا `192.168.10.200` (۱۱ آدرس IP)

| IP | کاربرد |
|----|--------|
| 192.168.10.190 | Main Ingress (Synapse, Element Web, Grafana) |
| 192.168.10.191 | LI Ingress (سرویس‌های LI) |
| 192.168.10.192-200 | رزرو برای استفاده آینده |

---

## ۳. تنظیمات Reverse Proxy روی گیت‌وی nginx

گیت‌وی nginx روی سرور `93.114.108.72` باید ترافیک HTTPS را به سرورهای داخلی هدایت کند.

**آدرس‌های IP داخلی برای تنظیمات:**

| درخواست‌های ورودی برای | هدایت به IP داخلی | پورت |
|------------------------|-------------------|------|
| matrix.nilva.dev | 192.168.10.190 | 443 |
| chat.nilva.dev | 192.168.10.190 | 443 |
| grafana.nilva.dev | 192.168.10.190 | 443 |
| turn.nilva.dev | 192.168.10.244 | 3478/5349 |
| chat-li.nilva.dev | 192.168.10.191 | 443 |
| admin-li.nilva.dev | 192.168.10.191 | 443 |
| keyvault.nilva.dev | 192.168.10.191 | 443 |

نکات فنی:
- پشتیبانی از WebSocket برای `matrix.nilva.dev` لازم است (برای پیام‌رسانی real-time)
- حداکثر حجم آپلود باید حداقل ۱۰۰ مگابایت باشد
- برای `turn.nilva.dev` فقط Port Forwarding لازم است (نه Reverse Proxy)

---

## ۴. باز کردن پورت‌ها و Port Forwarding روی گیت‌وی

برای عملکرد تماس صوتی و تصویری، پورت‌های زیر باید روی گیت‌وی (`93.114.108.72`) باز شده و به سرور تماس (`192.168.10.244`) فوروارد شوند:

| پورت | پروتکل | مقصد |
|------|--------|------|
| 3478 | TCP | 192.168.10.244 |
| 3478 | UDP | 192.168.10.244 |
| 5349 | TCP | 192.168.10.244 |
| 49152 تا 65535 | UDP | 192.168.10.244 |

توضیح پورت‌ها:
- **پورت 3478**: پروتکل TURN/STUN برای برقراری ارتباط تماس
- **پورت 5349**: نسخه رمزگذاری شده TURN با TLS
- **پورت‌های 49152 تا 65535**: انتقال داده‌های صوتی و تصویری در حین تماس

اگر باز کردن کل رنج 49152-65535 ممکن نیست، حداقل رنج 49152 تا 49252 (۱۰۰ پورت) کافی است.

---

## ۵. عدم وجود فایروال بین سرورهای داخلی

تمام ۱۷ سرور مجازی (با IPهای `192.168.10.231` تا `192.168.10.247`) باید بتوانند بدون هیچ محدودیتی با یکدیگر ارتباط برقرار کنند.

لطفاً تأیید کنید که هیچ فایروالی بین این سرورها وجود ندارد و تمام پورت‌ها (TCP و UDP) بین آن‌ها باز است.

---

## ۶. تنظیمات DNS داخلی (اختیاری)

اگر امکان دارد، رکوردهای DNS زیر را روی سرور DNS داخلی (`192.168.10.1`) تنظیم کنید. این کار باعث می‌شود ترافیک داخلی نیازی به عبور از گیت‌وی خارجی نداشته باشد.

| دامنه | IP داخلی |
|-------|----------|
| matrix.nilva.dev | 192.168.10.190 |
| chat.nilva.dev | 192.168.10.190 |
| grafana.nilva.dev | 192.168.10.190 |
| chat-li.nilva.dev | 192.168.10.191 |
| admin-li.nilva.dev | 192.168.10.191 |
| keyvault.nilva.dev | 192.168.10.191 |
| turn.nilva.dev | 192.168.10.244 |

---

## سؤالاتی که نیاز به پاسخ دارند

~~۱. کدام ۱۱ آدرس IP متوالی در شبکه `192.168.10.x` آزاد و قابل استفاده هستند؟~~ ✅ پاسخ: 192.168.10.190-200

۲. آیا امکان فوروارد کردن رنج پورت UDP از 49152 تا 65535 وجود دارد؟ اگر نه، حداقل چه تعداد پورت امکان‌پذیر است؟

۳. گواهی SSL را چگونه تهیه می‌کنید؟ (Let's Encrypt یا Wildcard یا روش دیگر)

---

## وضعیت فعلی

- ✅ کلاستر Kubernetes راه‌اندازی شد (۱۷ نود)
- ✅ رنج IP رزرو شد (192.168.10.190-200)
- ⏳ در انتظار تنظیمات DNS، Reverse Proxy و Port Forwarding
