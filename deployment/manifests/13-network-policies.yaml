# Network Policies for Microsegmentation
# Implements defense-in-depth by restricting pod-to-pod communication
#
# REQUIREMENTS:
# - CNI plugin with NetworkPolicy support (Calico, Cilium, Weave Net)
# - This deployment uses Calico (see 00-KUBERNETES-INSTALLATION-DEBIAN-OVH.md)
#
# BEHAVIOR:
# - Once a NetworkPolicy selects a pod, that pod is in "default deny" mode
# - Only explicitly allowed traffic is permitted
# - No NetworkPolicy = all traffic allowed (current default)
#
# TESTING:
# - Deploy policies gradually
# - Test connectivity between components
# - Monitor logs for blocked connections
# - Can delete NetworkPolicy to restore full connectivity: kubectl delete netpol <name> -n matrix
#
# TROUBLESHOOTING:
# - If connectivity breaks, check: kubectl describe netpol <name> -n matrix
# - Temporarily disable: kubectl delete netpol --all -n matrix
# - Calico logs: kubectl logs -n kube-system -l k8s-app=calico-node

---
# ============================================================================
# SYNAPSE MAIN PROCESS - Network Policy
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-main
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: synapse
      component: main
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from HAProxy (client requests, federation)
  - from:
    - podSelector:
        matchLabels:
          app: haproxy
    ports:
    - protocol: TCP
      port: 8008  # HTTP API

  # Allow from all workers (replication protocol)
  - from:
    - podSelector:
        matchLabels:
          app: synapse
          component: sync-worker
    - podSelector:
        matchLabels:
          app: synapse
          component: generic-worker
    - podSelector:
        matchLabels:
          app: synapse
          component: event-persister
    - podSelector:
        matchLabels:
          app: synapse
          component: federation-sender
    ports:
    - protocol: TCP
      port: 9093  # Replication port

  # Allow from Prometheus (metrics scraping)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 9000  # Metrics port

  egress:
  # Allow to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow to Redis (both instances)
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379  # Sentinel port

  # Allow to MinIO (S3 media storage)
  - to:
    - podSelector:
        matchLabels:
          app: minio
    ports:
    - protocol: TCP
      port: 9000  # S3 API

  # Allow to workers (replication)
  - to:
    - podSelector:
        matchLabels:
          app: synapse
    ports:
    - protocol: TCP
      port: 9093

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # Allow outbound HTTPS (for federation, push notifications)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 8448  # Matrix federation port

---
# ============================================================================
# SYNAPSE WORKERS - Network Policies
# ============================================================================

# Sync Workers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-sync-worker
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: synapse
      component: sync-worker
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from HAProxy
  - from:
    - podSelector:
        matchLabels:
          app: haproxy
    ports:
    - protocol: TCP
      port: 8083  # Worker HTTP port

  # Allow from main process (replication)
  - from:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9000

  egress:
  # Allow to main process (replication)
  - to:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Generic Workers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-generic-worker
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: synapse
      component: generic-worker
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from HAProxy
  - from:
    - podSelector:
        matchLabels:
          app: haproxy
    ports:
    - protocol: TCP
      port: 8081

  # Allow from main process
  - from:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9000

  egress:
  # Allow to main process
  - to:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379

  # Allow to MinIO (media upload/download)
  - to:
    - podSelector:
        matchLabels:
          app: minio
    ports:
    - protocol: TCP
      port: 9000

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

  # Allow outbound HTTPS (for federation)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 8448

---
# Event Persisters
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-event-persister
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: synapse
      component: event-persister
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from main process
  - from:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9000

  egress:
  # Allow to main process
  - to:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow to PostgreSQL (primary function)
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
    ports:
    - protocol: TCP
      port: 6379

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Federation Senders
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-federation-sender
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: synapse
      component: federation-sender
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from main process
  - from:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9000

  egress:
  # Allow to main process
  - to:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 9093

  # Allow to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
    ports:
    - protocol: TCP
      port: 6379

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

  # Allow outbound HTTPS to other Matrix servers (federation)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 8448  # Matrix federation port

---
# ============================================================================
# HAPROXY - Network Policy
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: haproxy
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: haproxy
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from NGINX Ingress
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8008

  # Allow from anywhere for stats page (internal only via service)
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 8404  # Stats page

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 8404

  egress:
  # Allow to Synapse main
  - to:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 8008

  # Allow to all Synapse workers
  - to:
    - podSelector:
        matchLabels:
          app: synapse
    ports:
    - protocol: TCP
      port: 8081  # Generic workers
    - protocol: TCP
      port: 8083  # Sync workers

  # Allow DNS (for service discovery)
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# ============================================================================
# FRONTEND COMPONENTS - Network Policies
# ============================================================================

# Element Web
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: element-web
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: element-web
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from NGINX Ingress only
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80

  egress:
  # Element Web is static files only - no outbound needed
  # Allow DNS for health checks
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Synapse Admin
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-admin
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: synapse-admin
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from NGINX Ingress only
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80

  egress:
  # Synapse Admin is static files - no outbound needed
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# ============================================================================
# INFRASTRUCTURE COMPONENTS - Network Policies
# ============================================================================

# PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: matrix-postgresql
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from Synapse main
  - from:
    - podSelector:
        matchLabels:
          app: synapse
          component: main
    ports:
    - protocol: TCP
      port: 5432

  # Allow from all Synapse workers
  - from:
    - podSelector:
        matchLabels:
          app: synapse
    ports:
    - protocol: TCP
      port: 5432

  # Allow from MAS (optional SSO)
  - from:
    - namespaceSelector:
        matchLabels:
          name: matrix-auth
    - podSelector:
        matchLabels:
          app: mas
    ports:
    - protocol: TCP
      port: 5432

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9187  # PostgreSQL exporter

  # Allow PostgreSQL cluster communication (replication)
  - from:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  egress:
  # Allow to other PostgreSQL replicas
  - to:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow to MinIO (for backups)
  - to:
    - podSelector:
        matchLabels:
          app: minio
    ports:
    - protocol: TCP
      port: 9000

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# Redis
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-synapse
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
      app.kubernetes.io/instance: redis-synapse
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from Synapse main and workers
  - from:
    - podSelector:
        matchLabels:
          app: synapse
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379  # Sentinel

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9121  # Redis exporter

  # Allow Redis Sentinel communication
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
          app.kubernetes.io/instance: redis-synapse
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379

  egress:
  # Allow to other Redis instances (Sentinel)
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
          app.kubernetes.io/instance: redis-synapse
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# MinIO
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: minio
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: minio
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from Synapse (S3 media storage)
  - from:
    - podSelector:
        matchLabels:
          app: synapse
    ports:
    - protocol: TCP
      port: 9000  # S3 API

  # Allow from PostgreSQL (backups)
  - from:
    - podSelector:
        matchLabels:
          cnpg.io/cluster: matrix-postgresql
    ports:
    - protocol: TCP
      port: 9000

  # Allow from NGINX Ingress (console access)
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 9001  # Console

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9000

  # Allow MinIO cluster communication
  - from:
    - podSelector:
        matchLabels:
          app: minio
    ports:
    - protocol: TCP
      port: 9000

  egress:
  # Allow to other MinIO pods (distributed mode)
  - to:
    - podSelector:
        matchLabels:
          app: minio
    ports:
    - protocol: TCP
      port: 9000

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

---
# ============================================================================
# COTURN - Network Policy
# ============================================================================

# coturn needs to accept connections from anywhere (NAT traversal)
# But we can still restrict egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: coturn
  namespace: matrix
spec:
  podSelector:
    matchLabels:
      app: coturn
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from anywhere (STUN/TURN must be publicly accessible)
  - from:
    - namespaceSelector: {}
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 3478  # STUN/TURN
    - protocol: UDP
      port: 3478
    - protocol: TCP
      port: 5349  # STUN/TURN over TLS
    - protocol: UDP
      port: 5349

  # Allow UDP port range for TURN relay
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 49152
      endPort: 65535

  egress:
  # Allow to anywhere (relay traffic)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 1
      endPort: 65535
    - protocol: UDP
      port: 1
      endPort: 65535

---
# ============================================================================
# LIVEKIT - Network Policy
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: livekit
  namespace: livekit
spec:
  podSelector:
    matchLabels:
      app: livekit
  policyTypes:
  - Ingress
  - Egress

  ingress:
  # Allow from NGINX Ingress
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 7880  # HTTP
    - protocol: TCP
      port: 7881  # RTC

  # Allow WebRTC from anywhere
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 7882  # WebRTC

  # Allow from Prometheus
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 6789  # Metrics

  egress:
  # Allow to Redis (in livekit namespace)
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: redis
          app.kubernetes.io/instance: redis-livekit
    ports:
    - protocol: TCP
      port: 6379

  # Allow to other LiveKit pods
  - to:
    - podSelector:
        matchLabels:
          app: livekit
    ports:
    - protocol: TCP
      port: 7880

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

  # Allow outbound for WebRTC
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 1
      endPort: 65535

---
# ============================================================================
# MONITORING NAMESPACE - Allow Prometheus to scrape all
# ============================================================================

# This policy allows Prometheus to scrape metrics from any pod
# Note: Individual component policies already allow from monitoring namespace
# This is a catch-all for any components we might have missed

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-scraper
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prometheus
  policyTypes:
  - Egress

  egress:
  # Allow to all namespaces for metrics scraping
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 9000  # Synapse metrics
    - protocol: TCP
      port: 9187  # PostgreSQL exporter
    - protocol: TCP
      port: 9121  # Redis exporter
    - protocol: TCP
      port: 8404  # HAProxy stats
    - protocol: TCP
      port: 6789  # LiveKit metrics

  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53

  # Allow to Kubernetes API (for service discovery)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# 1. GRADUAL ROLLOUT RECOMMENDED:
#    Apply policies one namespace at a time:
#    kubectl apply -f 13-network-policies.yaml --dry-run=server
#    kubectl apply -f 13-network-policies.yaml
#
# 2. VERIFY CONNECTIVITY:
#    After applying, test all critical paths:
#    - Element Web → HAProxy → Synapse
#    - Synapse → PostgreSQL
#    - Synapse → Redis
#    - Synapse → MinIO
#    - Federation (if enabled)
#
# 3. TROUBLESHOOTING BLOCKED CONNECTIONS:
#    # View all policies
#    kubectl get networkpolicies --all-namespaces
#
#    # Describe specific policy
#    kubectl describe networkpolicy <name> -n <namespace>
#
#    # Temporarily disable all policies in namespace
#    kubectl delete networkpolicies --all -n matrix
#
#    # Re-apply after fixing
#    kubectl apply -f 13-network-policies.yaml
#
# 4. CALICO-SPECIFIC COMMANDS:
#    # View Calico network policies
#    calicoctl get networkpolicy --all-namespaces
#
#    # View denied packets (if logging enabled)
#    calicoctl get felixconfiguration -o yaml | grep -A5 logging
#
# 5. TESTING CONNECTIVITY:
#    # From one pod to another
#    kubectl exec -it <pod-name> -n matrix -- curl http://<target-pod>:8008
#
#    # DNS resolution
#    kubectl exec -it <pod-name> -n matrix -- nslookup postgres-rw.matrix.svc.cluster.local
#
# 6. PERFORMANCE IMPACT:
#    NetworkPolicies have minimal performance overhead with Calico (~1-2%)
#    The security benefit far outweighs the minor performance cost
#
# 7. FEDERATION CONSIDERATIONS:
#    If you enable federation, ensure policies allow:
#    - Ingress to HAProxy from internet (already allowed via NGINX Ingress)
#    - Egress from Synapse workers to external Matrix servers (ports 443, 8448)
#
# ============================================================================
