# Ingress Routing Configuration
# Matrix/Synapse Production Deployment - Scale-aware (100 CCU to 20K CCU)
# Version: 3.0 - HAProxy Routing Architecture

# ============================================================================
# INGRESS ARCHITECTURE:
# ============================================================================
# Single domain with path-based routing through HAProxy intelligent routing layer:
#
# External Traffic (HTTPS)
#         ↓
# ┌───────────────────┐
# │ NGINX Ingress     │  ← TLS termination, DDoS protection, rate limiting
# │ Controller        │
# └─────────┬─────────┘
#           │ HTTP
#           ↓
# ┌───────────────────┐
# │ HAProxy Layer     │  ← Intelligent routing to specialized workers
# │                   │    - Token-based hashing for sync
# └─────────┬─────────┘    - Room-based hashing for events
#           │              - Health-aware load balancing
#           ↓              - Automatic fallback mechanisms
#   ┌───────┴───────────────────┬────────────────┐
#   │                           │                │
#   v                           v                v
# Sync Workers          Event Creators    Federation Workers
# Generic Workers       Media Workers     To-Device Workers
# (+ 8 more specialized worker types)
#
# Routing paths:
#   ├─ /                          → Element Web (web client)
#   ├─ /_matrix/client/*          → HAProxy → Specialized workers
#   ├─ /_matrix/media/*           → HAProxy → Media workers
#   ├─ /_matrix/federation/*      → HAProxy → Federation workers
#   ├─ /_synapse/admin/*          → HAProxy → Main process
#   ├─ /admin/*                   → Synapse Admin UI (direct)
#   └─ /.well-known/matrix/*      → HAProxy → Main process
#
# Benefits of HAProxy layer:
# - Specialized workers handle specific request types (better performance)
# - Advanced load balancing (consistent hashing by user, room, server)
# - Health-check aware routing (no requests to unhealthy workers)
# - Automatic fallback to main process if all workers down
# - Better observability (HAProxy metrics per backend)
#
# See HAPROXY-ARCHITECTURE.md for detailed documentation
# ============================================================================

---
# ============================================================================
# CERTIFICATE: Let's Encrypt TLS Certificate
# ============================================================================
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: matrix-tls
  namespace: matrix
spec:
  secretName: matrix-tls-secret
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - chat.z3r0d3v.com
  duration: 2160h  # 90 days
  renewBefore: 720h  # 30 days

---
# ============================================================================
# NOTE: Worker Load Balancing Now Handled by HAProxy
# ============================================================================
# Previous NGINX-based worker load balancing has been replaced by HAProxy
# routing layer for better performance and production-grade patterns.
#
# HAProxy provides:
# - Intelligent routing to specialized workers
# - Health-aware load balancing
# - Advanced hashing strategies (token, room, origin, URI)
# - Automatic fallback mechanisms
# - Service discovery via DNS SRV records
#
# See:
# - deployment/manifests/06-haproxy.yaml (HAProxy deployment)
# - deployment/config/haproxy.cfg (routing configuration)
# - deployment/docs/HAPROXY-ARCHITECTURE.md (detailed documentation)
# ============================================================================

---
# ============================================================================
# INGRESS: Main Matrix Routing
# ============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: matrix-ingress
  namespace: matrix
  labels:
    app: matrix
  annotations:
    # Cert-manager for TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # NGINX Ingress specific annotations
    kubernetes.io/ingress.class: "nginx"

    # Client IP preservation (already in NGINX controller config, but explicit here)
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"

    # Increase timeouts for long-polling /sync requests
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-body-size: "500m"  # Match Synapse max_upload_size

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";

    # Rate limiting (protect against abuse)
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # CORS for Matrix federation
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type"

spec:
  tls:
    - hosts:
        - chat.z3r0d3v.com
      secretName: matrix-tls-secret

  rules:
    - host: chat.z3r0d3v.com
      http:
        paths:
          # ============================================================
          # ALL MATRIX ENDPOINTS (/_matrix/*, /_synapse/*, /.well-known/matrix/*)
          # ============================================================
          # All Matrix traffic routes through HAProxy intelligent routing layer
          # HAProxy handles:
          # - Federation → federation-inbound workers
          # - Client /sync → sync workers (token-based hashing)
          # - Event creation → event-creator workers (room-based hashing)
          # - Media → media-repo workers
          # - To-device → to-device workers
          # - Generic → generic workers
          # - Admin API → main process
          # - With automatic fallback and health-aware routing

          - path: /_matrix
            pathType: Prefix
            backend:
              service:
                name: haproxy
                port:
                  number: 8008

          - path: /_synapse/admin
            pathType: Prefix
            backend:
              service:
                name: haproxy
                port:
                  number: 8008

          - path: /.well-known/matrix
            pathType: Prefix
            backend:
              service:
                name: haproxy
                port:
                  number: 8008

          # ============================================================
          # SYNAPSE ADMIN UI (/admin/*)
          # ============================================================
          # Web-based admin interface

          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: synapse-admin
                port:
                  number: 80

          # ============================================================
          # ELEMENT WEB (/)
          # ============================================================
          # Default route - web client
          # Must be LAST to avoid catching other paths

          - path: /
            pathType: Prefix
            backend:
              service:
                name: element-web
                port:
                  number: 80

---
# ============================================================================
# INGRESS: Admin UI with IP Whitelist (Optional Security)
# ============================================================================
# Separate Ingress for admin interface with stricter access control
# Comment out if you want admin accessible from everywhere

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: matrix-admin-ingress
  namespace: matrix
  labels:
    app: matrix
    component: admin
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    kubernetes.io/ingress.class: "nginx"

    # IP whitelist for admin access (CHANGE_TO_YOUR_ADMIN_IPS)
    # Example: Office IP, VPN IP, etc.
    nginx.ingress.kubernetes.io/whitelist-source-range: "0.0.0.0/0"  # CHANGE_ME: "10.0.0.0/8,192.168.1.0/24"

    # Basic auth (additional security layer)
    # Create secret: htpasswd -c auth admin && kubectl create secret generic synapse-admin-basic-auth --from-file=auth -n matrix
    # nginx.ingress.kubernetes.io/auth-type: basic
    # nginx.ingress.kubernetes.io/auth-secret: synapse-admin-basic-auth
    # nginx.ingress.kubernetes.io/auth-realm: "Matrix Admin Authentication Required"

spec:
  tls:
    - hosts:
        - chat.z3r0d3v.com
      secretName: matrix-tls-secret

  rules:
    - host: chat.z3r0d3v.com
      http:
        paths:
          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: synapse-admin
                port:
                  number: 80

          - path: /_synapse/admin
            pathType: Prefix
            backend:
              service:
                name: haproxy
                port:
                  number: 8008

---
# ============================================================================
# INGRESS: Federation Port 8448 (Optional)
# ============================================================================
# Matrix federation traditionally uses port 8448
# If you want to support this in addition to HTTPS federation:

# apiVersion: v1
# kind: Service
# metadata:
#   name: synapse-federation
#   namespace: matrix
# spec:
#   type: LoadBalancer
#   selector:
#     app: synapse
#     component: main
#   ports:
#     - name: federation
#       port: 8448
#       targetPort: 8008
#       protocol: TCP
#   loadBalancerIP: ""  # CHANGE_TO_YOUR_METALLB_IP

---
# ============================================================================
# USAGE NOTES
# ============================================================================
# After deployment:
#
# 1. Verify Ingress status:
#    kubectl get ingress -n matrix
#    kubectl describe ingress matrix-ingress -n matrix
#
# 2. Check certificate issuance:
#    kubectl get certificate -n matrix
#    kubectl describe certificate matrix-tls -n matrix
#
# 3. Test endpoints:
#    # Element Web
#    curl https://chat.z3r0d3v.com/
#
#    # Client API
#    curl https://chat.z3r0d3v.com/_matrix/client/versions
#
#    # Federation well-known
#    curl https://chat.z3r0d3v.com/.well-known/matrix/server
#
#    # Server version
#    curl https://chat.z3r0d3v.com/_matrix/federation/v1/version
#
# 4. DNS configuration required:
#    # Add A record
#    chat.z3r0d3v.com.  IN  A  <YOUR_LOADBALANCER_IP>
#
#    # Optional: Add SRV records for federation
#    _matrix._tcp.z3r0d3v.com. IN SRV 10 0 8448 chat.z3r0d3v.com.
#
# 5. Test federation (if enabled):
#    https://federationtester.matrix.org/
#    Enter: chat.z3r0d3v.com
#
# 6. Monitor Ingress logs:
#    kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
#
# 7. Common issues:
#    - Certificate not ready: Wait for cert-manager (can take 2-5 minutes)
#    - 502 Bad Gateway: Check backend services are running
#    - 504 Gateway Timeout: Increase timeout annotations
#    - 413 Request Entity Too Large: Increase proxy-body-size
#
# 8. Load balancer IP allocation (MetalLB):
#    kubectl get svc -n ingress-nginx
#    # Look for EXTERNAL-IP assigned to LoadBalancer service
#
# 9. Security hardening:
#    - Enable IP whitelist for admin endpoints
#    - Add basic auth for Synapse Admin UI
#    - Configure WAF rules if available
#    - Enable rate limiting per user/IP
#    - Monitor for suspicious patterns
#
# 10. Performance tuning:
#     - Enable HTTP/2 (default in NGINX Ingress)
#     - Enable connection keepalive
#     - Tune worker_processes in NGINX
#     - Monitor connection pool exhaustion
#
# ============================================================================
