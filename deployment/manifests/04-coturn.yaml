# coturn TURN/STUN Server
# Matrix/Synapse Production Deployment
# Version: 2.1 - Scale-aware configuration

# ============================================================================
# SCALING NOTICE: coturn Instances Depend on Your Scale
# ============================================================================
# ðŸ“Š See SCALING-GUIDE.md Section 9.6 for coturn sizing at your scale:
# - 100 CCU:  2 instances (HA minimum)
# - 1K CCU:   2 instances
# - 5K CCU:   3 instances
# - 10K CCU:  4 instances
# - 20K CCU:  5 instances
#
# CRITICAL: TURN/STUN server for WebRTC NAT traversal
# - Enables 1:1 voice/video calls
# - Uses hostNetwork for UDP performance
# - DaemonSet pattern for HA across nodes
# ============================================================================

---
# ============================================================================
# CONFIGMAP: coturn configuration
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: coturn-config
  namespace: coturn
data:
  turnserver.conf: |
    # Listening ports
    listening-port=3478
    tls-listening-port=5349

    # Relay ports for media
    min-port=49152
    max-port=65535

    # Listening IPs (0.0.0.0 = all interfaces)
    listening-ip=0.0.0.0
    relay-ip=0.0.0.0

    # External IP (will be auto-detected via hostNetwork)
    # external-ip will be set via EXTERNAL_IP env var in pod spec

    # Realm
    realm=turn.CHANGE_TO_YOUR_DOMAIN

    # Authentication
    use-auth-secret
    static-auth-secret=CHANGE_TO_SHARED_SECRET

    # Fingerprinting
    fingerprint

    # Logging
    verbose
    log-file=stdout

    # User quota (connections per user)
    user-quota=12
    total-quota=1200

    # Max bps (bandwidth per session)
    max-bps=1000000

    # Deny private IP ranges in relay
    no-multicast-peers
    denied-peer-ip=10.0.0.0-10.255.255.255
    denied-peer-ip=172.16.0.0-172.31.255.255
    denied-peer-ip=192.168.0.0-192.168.255.255

    # Mobility (for mobile clients)
    mobility

    # No TCP relay? NO! Many corporate networks require it
    # KEEP TCP RELAY ENABLED for maximum compatibility
    # no-tcp-relay  # DO NOT SET THIS

    # Prometheus metrics (if coturn compiled with prometheus support)
    # prometheus
    # prometheus-port=9641

---
# ============================================================================
# SECRET: coturn shared secret
# ============================================================================
# Generate with: openssl rand -base64 32
# This secret must match in Synapse configuration

apiVersion: v1
kind: Secret
metadata:
  name: coturn-secret
  namespace: coturn
type: Opaque
stringData:
  shared-secret: "CHANGE_TO_SHARED_SECRET"  # CRITICAL: Must match turnserver.conf

---
# ============================================================================
# DAEMONSET: coturn instances
# ============================================================================
# Uses DaemonSet with nodeSelector to deploy on specific nodes
# Requires hostNetwork for UDP performance

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: coturn
  namespace: coturn
  labels:
    app: coturn
spec:
  selector:
    matchLabels:
      app: coturn

  template:
    metadata:
      labels:
        app: coturn
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9641"
    spec:
      # CRITICAL: hostNetwork for direct UDP handling
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      # Node selector: only deploy on nodes labeled coturn=true
      # Label nodes: kubectl label node <node-name> coturn=true
      nodeSelector:
        coturn: "true"

      # Tolerations (if needed for control plane nodes)
      tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists

      containers:
        - name: coturn
          image: coturn/coturn:4.6.2-alpine  # CHANGE_TO_LATEST_STABLE
          imagePullPolicy: IfNotPresent

          # Security context
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
                - NET_BIND_SERVICE

          # Environment variables
          env:
            # Auto-detect external IP from node
            - name: NODE_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: EXTERNAL_IP
              value: "$(NODE_IP)"

            # Shared secret from Secret
            - name: SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: coturn-secret
                  key: shared-secret

          # Command override to set external-ip dynamically
          command:
            - /bin/sh
            - -c
            - |
              echo "external-ip=$(NODE_IP)" >> /etc/coturn/turnserver.conf
              exec turnserver -c /etc/coturn/turnserver.conf

          # Volume mounts
          volumeMounts:
            - name: config
              mountPath: /etc/coturn/turnserver.conf
              subPath: turnserver.conf

          # Ports
          ports:
            - name: turn-udp
              containerPort: 3478
              protocol: UDP
              hostPort: 3478

            - name: turn-tcp
              containerPort: 3478
              protocol: TCP
              hostPort: 3478

            - name: turns-tcp
              containerPort: 5349
              protocol: TCP
              hostPort: 5349

            - name: turns-udp
              containerPort: 5349
              protocol: UDP
              hostPort: 5349

            # Metrics port (if enabled)
            # - name: metrics
            #   containerPort: 9641
            #   protocol: TCP

          # Resources
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 4000m
              memory: 4Gi

          # Liveness probe
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "netstat -an | grep -q 3478"
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          # Readiness probe
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "netstat -an | grep -q 3478"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

      # Volumes
      volumes:
        - name: config
          configMap:
            name: coturn-config

---
# ============================================================================
# SERVICE: coturn (ClusterIP for internal reference)
# ============================================================================
# Note: External access is via hostNetwork, not via Service
# This service is for internal DNS resolution only

apiVersion: v1
kind: Service
metadata:
  name: coturn
  namespace: coturn
  labels:
    app: coturn
spec:
  type: ClusterIP
  clusterIP: None  # Headless service
  selector:
    app: coturn
  ports:
    - name: turn-udp
      port: 3478
      protocol: UDP
    - name: turn-tcp
      port: 3478
      protocol: TCP
    - name: turns-tcp
      port: 5349
      protocol: TCP
    - name: turns-udp
      port: 5349
      protocol: UDP

---
# ============================================================================
# SERVICEMONITOR: Prometheus monitoring (if metrics enabled)
# ============================================================================
# Uncomment if coturn compiled with Prometheus support

# apiVersion: monitoring.coreos.com/v1
# kind: ServiceMonitor
# metadata:
#   name: coturn
#   namespace: coturn
#   labels:
#     app: coturn
# spec:
#   selector:
#     matchLabels:
#       app: coturn
#   endpoints:
#     - port: metrics
#       interval: 30s
#       path: /metrics

---
# ============================================================================
# NODE LABELING INSTRUCTIONS
# ============================================================================
# Before deploying coturn, label N nodes based on your scale:
#
# For 100-1K CCU (2 instances - HA minimum):
# kubectl label node node1 coturn=true
# kubectl label node node2 coturn=true
#
# For 5K CCU (3 instances):
# kubectl label node node3 coturn=true
#
# For 10K CCU (4 instances):
# kubectl label node node4 coturn=true
#
# For 20K CCU (5 instances):
# kubectl label node node5 coturn=true
#
# See SCALING-GUIDE.md Section 9.6 for exact instance counts at your scale.
#
# To remove label:
# kubectl label node <node-name> coturn-
#
# To view labeled nodes:
# kubectl get nodes -l coturn=true
# ============================================================================

---
# ============================================================================
# FIREWALL REQUIREMENTS
# ============================================================================
# Required ports on coturn nodes:
# - 3478/UDP: STUN/TURN
# - 3478/TCP: TURN over TCP
# - 5349/TCP: TURNS (TLS)
# - 5349/UDP: DTLS
# - 49152-65535/UDP: Media relay
#
# These ports must be accessible from client networks (internet if public)
#
# Example iptables rules:
# iptables -A INPUT -p udp --dport 3478 -j ACCEPT
# iptables -A INPUT -p tcp --dport 3478 -j ACCEPT
# iptables -A INPUT -p tcp --dport 5349 -j ACCEPT
# iptables -A INPUT -p udp --dport 5349 -j ACCEPT
# iptables -A INPUT -p udp --dport 49152:65535 -j ACCEPT
# ============================================================================

---
# ============================================================================
# SYNAPSE CONFIGURATION REFERENCE
# ============================================================================
# In Synapse homeserver.yaml:
#
# turn_uris:
#   - "turn:NODE1_IP:3478?transport=udp"
#   - "turn:NODE1_IP:3478?transport=tcp"
#   - "turn:NODE2_IP:3478?transport=udp"
#   - "turn:NODE2_IP:3478?transport=tcp"
#   - "turns:NODE1_IP:5349?transport=tcp"  # If using TLS
#   - "turns:NODE2_IP:5349?transport=tcp"
#
# turn_shared_secret: "SAME_AS_COTURN_SHARED_SECRET"
# turn_user_lifetime: 86400000  # 24 hours in ms
# turn_allow_guests: true
#
# Get node IPs:
# kubectl get nodes -o wide
# ============================================================================

---
# ============================================================================
# TESTING coturn
# ============================================================================
# Test STUN functionality:
# apt-get install stun-client
# stunclient <NODE_IP> 3478
#
# Test TURN functionality:
# Use web tool: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
# Enter TURN server: turn:<NODE_IP>:3478
# Enter credentials: Use time-limited credentials generated by Synapse
#
# View coturn logs:
# kubectl logs -n coturn -l app=coturn --tail=100 -f
#
# Check connections:
# kubectl exec -n coturn <pod-name> -- netstat -an | grep 3478
#
# Monitor bandwidth:
# kubectl top pods -n coturn
# ============================================================================

---
# ============================================================================
# CAPACITY & SCALING
# ============================================================================
# Concurrent video calls by scale (~5-10% of CCU):
# - 100 CCU:   5-10 concurrent calls, 2 instances sufficient
# - 1K CCU:    50-100 concurrent calls, 2 instances sufficient
# - 5K CCU:    250-500 concurrent calls, 3 instances recommended
# - 10K CCU:   500-1000 concurrent calls, 4 instances recommended
# - 20K CCU:   1000-2000 concurrent calls, 5 instances recommended
#
# Per coturn instance capacity:
# - ~500-1000 concurrent TURN sessions
# - Each TURN connection: ~1-2 Mbps (video call)
#
# See SCALING-GUIDE.md Section 9.6 for detailed coturn sizing.
#
# Scaling indicators:
# - CPU >70%: Add more coturn instances
# - Bandwidth saturated: Add more instances
# - Connection failures: Check network capacity
#
# To add more instances:
# kubectl label node <new-node> coturn=true
# DaemonSet will automatically deploy coturn on new node
# ============================================================================
