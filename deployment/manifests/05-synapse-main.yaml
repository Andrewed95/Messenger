# Synapse Homeserver Main Process
# Matrix/Synapse Production Deployment - 20K CCU
# Version: 2.0

# ============================================================================
# This manifest contains the main Synapse process (non-worker)
# Worker configurations are in separate files for clarity
# ============================================================================

---
# ============================================================================
# SECRET: Synapse Signing Key
# ============================================================================
# Generate signing key:
# docker run -it --rm -v $(pwd):/data matrixdotorg/synapse:latest generate
# Or: python -c 'import signedjson.key; print(signedjson.key.generate_signing_key(0))'

apiVersion: v1
kind: Secret
metadata:
  name: synapse-signing-key
  namespace: matrix
type: Opaque
stringData:
  signing.key: |
    ed25519 a_AAAA CHANGE_TO_GENERATED_SIGNING_KEY

---
# ============================================================================
# SECRET: Synapse Secrets
# ============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: synapse-secrets
  namespace: matrix
type: Opaque
stringData:
  registration-shared-secret: "CHANGE_TO_RANDOM_SECRET"  # For creating users
  macaroon-secret-key: "CHANGE_TO_RANDOM_SECRET"  # For access tokens
  form-secret: "CHANGE_TO_RANDOM_SECRET"  # For forms

---
# ============================================================================
# SECRET: MinIO S3 Credentials (for Synapse media)
# ============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: synapse-s3-credentials
  namespace: matrix
type: Opaque
stringData:
  access-key: "CHANGE_TO_MINIO_ACCESS_KEY"
  secret-key: "CHANGE_TO_MINIO_SECRET_KEY"

---
# ============================================================================
# CONFIGMAP: Synapse Main Configuration
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-config
  namespace: matrix
data:
  homeserver.yaml: |
    # ==========================================================================
    # Synapse Main Homeserver Configuration
    # Matrix Production Deployment - 20K CCU
    # ==========================================================================

    # Server name (your Matrix domain)
    server_name: "chat.z3r0d3v.com"

    # Public base URL
    public_baseurl: "https://chat.z3r0d3v.com"

    # Serve server/client /.well-known metadata
    serve_server_wellknown: true

    # ==========================================================================
    # LISTENERS
    # ==========================================================================
    listeners:
      # Client API (for Element Web and mobile clients)
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        bind_addresses: ['0.0.0.0']
        resources:
          - names: [client]
            compress: true

      # HTTP replication port (for workers)
      - port: 9093
        type: http
        bind_addresses: ['0.0.0.0']
        resources:
          - names: [replication]

      # Metrics endpoint
      - port: 9000
        type: http
        bind_addresses: ['0.0.0.0']
        resources:
          - names: [metrics]

    # ==========================================================================
    # DATABASE
    # ==========================================================================
    database:
      name: psycopg2
      args:
        host: synapse-postgres-pooler-rw.matrix.svc.cluster.local
        port: 5432
        user: synapse
        password: "CHANGE_TO_POSTGRES_PASSWORD"
        database: synapse
        cp_min: 5
        cp_max: 50
        keepalives_idle: 10
        keepalives_interval: 10
        keepalives_count: 3

    # ==========================================================================
    # REDIS (for worker communication)
    # ==========================================================================
    redis:
      enabled: true
      host: redis-synapse-master.redis-synapse.svc.cluster.local
      port: 6379
      # password: "REDIS_PASSWORD"  # If Redis auth enabled
      dbid: 0

    # ==========================================================================
    # MEDIA STORAGE
    # ==========================================================================
    media_store_path: "/data/media"
    max_upload_size: "500M"
    max_image_pixels: "32M"
    url_preview_enabled: true
    url_preview_ip_range_blacklist:
      - '127.0.0.0/8'
      - '10.0.0.0/8'
      - '172.16.0.0/12'
      - '192.168.0.0/16'
      - '100.64.0.0/10'
      - '169.254.0.0/16'
      - '::1/128'
      - 'fe80::/64'
      - 'fc00::/7'

    # S3 storage provider configuration
    media_storage_providers:
      - module: s3_storage_provider.S3StorageProviderBackend
        store_local: true  # Store locally first, then async upload to S3
        store_remote: true
        store_synchronous: false
        config:
          bucket: synapse-media
          region_name: us-east-1
          endpoint_url: "http://minio-api.minio.svc.cluster.local:9000"
          access_key_id: "CHANGE_TO_MINIO_ACCESS_KEY"
          secret_access_key: "CHANGE_TO_MINIO_SECRET_KEY"
          # Path style (required for MinIO)
          addressing_style: path

    # ==========================================================================
    # FEDERATION
    # ==========================================================================
    # Federation disabled by default (enable via federation_enabled: true)
    federation_enabled: false
    federation_domain_whitelist: []
    # federation_domain_whitelist:  # Uncomment to whitelist specific domains
    #   - "matrix.org"
    #   - "trusted-domain.com"

    # ==========================================================================
    # REGISTRATION
    # ==========================================================================
    enable_registration: false
    enable_registration_captcha: false
    registration_shared_secret: "CHANGE_TO_REGISTRATION_SECRET"
    bcrypt_rounds: 12

    # ==========================================================================
    # TURN/STUN (for VoIP)
    # ==========================================================================
    turn_uris:
      - "turn:COTURN_NODE1_IP:3478?transport=udp"
      - "turn:COTURN_NODE1_IP:3478?transport=tcp"
      - "turn:COTURN_NODE2_IP:3478?transport=udp"
      - "turn:COTURN_NODE2_IP:3478?transport=tcp"
    turn_shared_secret: "CHANGE_TO_COTURN_SHARED_SECRET"
    turn_user_lifetime: 86400000  # 24 hours
    turn_allow_guests: true

    # ==========================================================================
    # SECURITY
    # ==========================================================================
    signing_key_path: "/keys/signing.key"
    trusted_key_servers:
      - server_name: "matrix.org"  # For key verification (if federation enabled)
    suppress_key_server_warning: true

    form_secret: "CHANGE_TO_FORM_SECRET"
    macaroon_secret_key: "CHANGE_TO_MACAROON_SECRET"

    # ==========================================================================
    # RATE LIMITING
    # ==========================================================================
    rc_message:
      per_second: 10
      burst_count: 50
    rc_registration:
      per_second: 0.17
      burst_count: 3
    rc_login:
      address:
        per_second: 0.17
        burst_count: 3
      account:
        per_second: 0.17
        burst_count: 3
      failed_attempts:
        per_second: 0.17
        burst_count: 3
    rc_admin_redaction:
      per_second: 1
      burst_count: 50
    rc_joins:
      local:
        per_second: 0.1
        burst_count: 10
      remote:
        per_second: 0.01
        burst_count: 10

    # ==========================================================================
    # CACHING
    # ==========================================================================
    caches:
      global_factor: 2.0  # Increase cache sizes for high-load
      per_cache_factors:
        get_users_who_share_room_with_user: 5.0
        get_rooms_for_user: 2.0

    # ==========================================================================
    # LOGGING
    # ==========================================================================
    log_config: "/config/log.config"

    # ==========================================================================
    # METRICS
    # ==========================================================================
    enable_metrics: true
    report_stats: false

    # ==========================================================================
    # WORKERS
    # ==========================================================================
    # Worker mode enabled (main process coordinates workers)
    worker_app: synapse.app.homeserver

    # Worker configuration (loaded from separate files)
    # Workers will be configured via their own config files

  # Logging configuration
  log.config: |
    version: 1

    formatters:
      precise:
        format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(request)s - %(message)s'

    handlers:
      console:
        class: logging.StreamHandler
        formatter: precise

    loggers:
      synapse:
        level: INFO
      synapse.storage.SQL:
        level: INFO

    root:
      level: INFO
      handlers: [console]

    disable_existing_loggers: false

---
# ============================================================================
# DEPLOYMENT: Synapse Main Process
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synapse-main
  namespace: matrix
  labels:
    app: synapse
    component: main
spec:
  replicas: 1  # Only 1 main process (workers scale horizontally)

  strategy:
    type: Recreate  # Main process should not have multiple replicas

  selector:
    matchLabels:
      app: synapse
      component: main

  template:
    metadata:
      labels:
        app: synapse
        component: main
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9000"
        prometheus.io/path: "/_synapse/metrics"

    spec:
      # Security context
      securityContext:
        runAsUser: 991
        runAsGroup: 991
        fsGroup: 991

      # Init container to set up data directory
      initContainers:
        - name: init-data
          image: busybox:latest
          command: ['sh', '-c', 'mkdir -p /data/media && chown -R 991:991 /data']
          volumeMounts:
            - name: data
              mountPath: /data

      containers:
        - name: synapse
          image: matrixdotorg/synapse:v1.102.0  # CHANGE_TO_LATEST_STABLE
          imagePullPolicy: IfNotPresent

          # Environment variables
          env:
            - name: SYNAPSE_SERVER_NAME
              value: "chat.z3r0d3v.com"
            - name: SYNAPSE_REPORT_STATS
              value: "no"

          # Ports
          ports:
            - name: http
              containerPort: 8008
              protocol: TCP
            - name: replication
              containerPort: 9093
              protocol: TCP
            - name: metrics
              containerPort: 9000
              protocol: TCP

          # Volume mounts
          volumeMounts:
            - name: config
              mountPath: /config/homeserver.yaml
              subPath: homeserver.yaml
            - name: config
              mountPath: /config/log.config
              subPath: log.config
            - name: signing-key
              mountPath: /keys
              readOnly: true
            - name: data
              mountPath: /data

          # Resources
          resources:
            requests:
              cpu: 2000m
              memory: 8Gi
            limits:
              cpu: 8000m
              memory: 32Gi

          # Liveness probe
          livenessProbe:
            httpGet:
              path: /health
              port: 8008
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # Readiness probe
          readinessProbe:
            httpGet:
              path: /health
              port: 8008
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

      # Volumes
      volumes:
        - name: config
          configMap:
            name: synapse-config
        - name: signing-key
          secret:
            secretName: synapse-signing-key
        - name: data
          persistentVolumeClaim:
            claimName: synapse-data

---
# ============================================================================
# PVC: Synapse Data (Media Store)
# ============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: synapse-data
  namespace: matrix
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: ""  # CHANGE_TO_YOUR_STORAGE_CLASS
  resources:
    requests:
      storage: 100Gi  # Local cache before S3 upload

---
# ============================================================================
# SERVICE: Synapse Main
# ============================================================================
apiVersion: v1
kind: Service
metadata:
  name: synapse-main
  namespace: matrix
  labels:
    app: synapse
    component: main
spec:
  type: ClusterIP
  selector:
    app: synapse
    component: main
  ports:
    - name: http
      port: 8008
      targetPort: 8008
      protocol: TCP
    - name: replication
      port: 9093
      targetPort: 9093
      protocol: TCP
    - name: metrics
      port: 9000
      targetPort: 9000
      protocol: TCP

---
# ============================================================================
# SERVICE MONITOR: Prometheus monitoring
# ============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: synapse-main
  namespace: matrix
  labels:
    app: synapse
    component: main
spec:
  selector:
    matchLabels:
      app: synapse
      component: main
  endpoints:
    - port: metrics
      interval: 30s
      path: /_synapse/metrics

---
# ============================================================================
# NOTES
# ============================================================================
# After deploying the main process:
#
# 1. Check status:
#    kubectl get pods -n matrix -l component=main
#    kubectl logs -n matrix -l component=main
#
# 2. Create admin user:
#    kubectl exec -n matrix <synapse-main-pod> -- \
#      register_new_matrix_user -c /config/homeserver.yaml \
#      -u admin -p <password> -a http://localhost:8008
#
# 3. Test health endpoint:
#    kubectl port-forward -n matrix svc/synapse-main 8008:8008
#    curl http://localhost:8008/health
#
# 4. View metrics:
#    curl http://localhost:8008/_synapse/metrics
#
# 5. Next steps:
#    - Deploy workers (05-synapse-workers.yaml)
#    - Deploy Element Web
#    - Deploy Synapse Admin
#    - Configure Ingress
# ============================================================================
