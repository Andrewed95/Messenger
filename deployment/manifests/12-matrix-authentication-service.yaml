# Matrix Authentication Service (MAS) Deployment
# Optional component for enterprise SSO integration with Keycloak
# Version: 1.0

# ============================================================================
# IMPORTANT: MAS is OPTIONAL
# ============================================================================
# Deploy this only when:
# - Enterprise customer requires SSO with Keycloak
# - Customer has OIDC-compliant identity provider
# - Synapse version is 1.136.0 or later
#
# DO NOT deploy if:
# - Simple password authentication is sufficient
# - Customer has <100 users with no SSO requirement
# - Customer cannot provide Keycloak or OIDC IdP
# ============================================================================

---
# ============================================================================
# NAMESPACE
# ============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: matrix-auth
  labels:
    app: matrix-authentication-service
    monitoring: enabled

---
# ============================================================================
# MAS SERVER DEPLOYMENT
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mas-server
  namespace: matrix-auth
  labels:
    app: mas
    component: server
spec:
  # Scale based on load (2 for 100-1K CCU, 4 for 20K CCU)
  replicas: 2

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: mas
      component: server

  template:
    metadata:
      labels:
        app: mas
        component: server
      annotations:
        # Config hash triggers restart when config changes
        prometheus.io/scrape: "true"
        prometheus.io/port: "8081"
        prometheus.io/path: "/metrics"

    spec:
      # Security context (non-root, read-only filesystem)
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

      containers:
      - name: mas-server
        image: ghcr.io/element-hq/matrix-authentication-service:v0.12.0
        imagePullPolicy: IfNotPresent

        # Server mode (HTTP server only, no background worker)
        args:
          - server
          - --config
          - /config/config.yaml
          - --no-worker

        # Security context for container
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

        # Ports
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: health
          containerPort: 8081
          protocol: TCP

        # Environment variables
        env:
        - name: RUST_LOG
          value: "info,mas_cli=debug"

        # Volume mounts
        volumeMounts:
        # Configuration file
        - name: config
          mountPath: /config
          readOnly: true

        # Secrets (database URI, encryption key, etc.)
        - name: database-secret
          mountPath: /secrets/database
          readOnly: true
        - name: mas-secrets
          mountPath: /secrets/mas
          readOnly: true
        - name: signing-key
          mountPath: /secrets/keys
          readOnly: true

        # Temporary directories (read-only root filesystem requires these)
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /.cache

        # Resource limits (adjust based on scale - see SCALING-GUIDE.md)
        resources:
          requests:
            cpu: 500m      # 100 CCU baseline
            memory: 512Mi
          limits:
            cpu: 2000m     # Allow burst
            memory: 1Gi

        # Liveness probe
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Readiness probe
        readinessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2

        # Startup probe (allow slow startup)
        startupProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30  # 150 seconds max startup time

      volumes:
      # Configuration
      - name: config
        configMap:
          name: mas-config

      # Secrets
      - name: database-secret
        secret:
          secretName: mas-database
      - name: mas-secrets
        secret:
          secretName: mas-secrets
      - name: signing-key
        secret:
          secretName: mas-signing-key

      # Temporary directories
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}

      # Pod anti-affinity (spread across nodes for HA)
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - mas
                - key: component
                  operator: In
                  values:
                  - server
              topologyKey: kubernetes.io/hostname

---
# ============================================================================
# MAS WORKER DEPLOYMENT
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mas-worker
  namespace: matrix-auth
  labels:
    app: mas
    component: worker
spec:
  # Usually 1-2 workers sufficient for all scales
  replicas: 1

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: mas
      component: worker

  template:
    metadata:
      labels:
        app: mas
        component: worker

    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

      containers:
      - name: mas-worker
        image: ghcr.io/element-hq/matrix-authentication-service:v0.12.0
        imagePullPolicy: IfNotPresent

        # Worker mode (background tasks only)
        args:
          - worker
          - --config
          - /config/config.yaml

        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

        env:
        - name: RUST_LOG
          value: "info,mas_cli=debug"

        volumeMounts:
        - name: config
          mountPath: /config
          readOnly: true
        - name: database-secret
          mountPath: /secrets/database
          readOnly: true
        - name: mas-secrets
          mountPath: /secrets/mas
          readOnly: true
        - name: signing-key
          mountPath: /secrets/keys
          readOnly: true
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /.cache

        resources:
          requests:
            cpu: 250m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 512Mi

        # Liveness probe (worker doesn't have HTTP endpoint, use exec)
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "pgrep -f 'mas-cli worker' || exit 1"
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

      volumes:
      - name: config
        configMap:
          name: mas-config
      - name: database-secret
        secret:
          secretName: mas-database
      - name: mas-secrets
        secret:
          secretName: mas-secrets
      - name: signing-key
        secret:
          secretName: mas-signing-key
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}

---
# ============================================================================
# MAS SERVICE
# ============================================================================
apiVersion: v1
kind: Service
metadata:
  name: mas
  namespace: matrix-auth
  labels:
    app: mas
    component: server
spec:
  type: ClusterIP
  selector:
    app: mas
    component: server
  ports:
  - name: http
    port: 8080
    targetPort: http
    protocol: TCP
  - name: health
    port: 8081
    targetPort: health
    protocol: TCP
  sessionAffinity: None

---
# ============================================================================
# MAS INGRESS
# ============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mas
  namespace: matrix-auth
  labels:
    app: mas
  annotations:
    # TLS certificate
    cert-manager.io/cluster-issuer: letsencrypt-prod

    # Nginx-specific annotations
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: interest-cohort=()";
spec:
  ingressClassName: nginx

  tls:
  - hosts:
    - account.example.com  # CHANGE_ME
    secretName: mas-tls

  rules:
  - host: account.example.com  # CHANGE_ME
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mas
            port:
              name: http

---
# ============================================================================
# SERVICE MONITOR (Prometheus Operator)
# ============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mas
  namespace: matrix-auth
  labels:
    app: mas
spec:
  selector:
    matchLabels:
      app: mas
      component: server
  endpoints:
  - port: health
    path: /metrics
    interval: 30s
    scrapeTimeout: 10s

---
# ============================================================================
# POD DISRUPTION BUDGET
# ============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mas-server
  namespace: matrix-auth
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: mas
      component: server
