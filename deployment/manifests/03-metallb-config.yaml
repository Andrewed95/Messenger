# MetalLB IP Address Pool Configuration
# Matrix/Synapse Production Deployment - 20K CCU
# Version: 2.0

# ============================================================================
# CRITICAL: Defines IP address pool for LoadBalancer services
# - Required for NGINX Ingress to get external IP
# - Uses L2 mode (ARP) for bare-metal Kubernetes
# ============================================================================

---
# ============================================================================
# IP ADDRESS POOL
# ============================================================================
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: main-pool
  namespace: metallb-system
spec:
  # IP address range for LoadBalancer services
  # CHANGE_TO_YOUR_IP_RANGE
  addresses:
    - 192.168.1.240-192.168.1.250  # 11 IP addresses

  # Alternative: CIDR notation
  # - 192.168.1.240/28  # 16 IP addresses

  # Auto-assign IPs from this pool to LoadBalancer services
  autoAssign: true

  # Avoid buggy IPs (optional)
  # avoidBuggyIPs: true

---
# ============================================================================
# L2 ADVERTISEMENT
# ============================================================================
# Announces IP addresses using ARP (Layer 2)

apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: main-l2-adv
  namespace: metallb-system
spec:
  # Advertise IPs from main-pool
  ipAddressPools:
    - main-pool

  # Optional: Limit to specific network interfaces
  # interfaces:
  #   - enp0s3
  #   - eth0

  # Optional: Limit to specific nodes
  # nodeSelectors:
  #   - matchLabels:
  #       kubernetes.io/hostname: node1

---
# ============================================================================
# ALTERNATIVE: BGP MODE (For advanced networking)
# ============================================================================
# If you have BGP-capable routers, use BGP mode instead of L2:
#
# apiVersion: metallb.io/v1beta1
# kind: BGPPeer
# metadata:
#   name: router-peer
#   namespace: metallb-system
# spec:
#   myASN: 64500  # Your ASN
#   peerASN: 64501  # Router ASN
#   peerAddress: 192.168.1.1  # Router IP
# ---
# apiVersion: metallb.io/v1beta1
# kind: BGPAdvertisement
# metadata:
#   name: main-bgp-adv
#   namespace: metallb-system
# spec:
#   ipAddressPools:
#     - main-pool
#   aggregationLength: 32  # /32 per service
#   localPref: 100

---
# ============================================================================
# IP ALLOCATION PLANNING
# ============================================================================
# Services that will consume LoadBalancer IPs:
#
# 1. NGINX Ingress Controller: 1 IP
#    - Handles HTTP/HTTPS traffic (ports 80, 443, 8448)
#    - Main entry point for web clients
#
# 2. Optional services: 2-5 IPs
#    - Grafana (if exposed externally)
#    - MinIO Console (if exposed externally)
#    - Other management interfaces
#
# IMPORTANT: coturn and LiveKit use hostNetwork DaemonSet pattern
# (not LoadBalancer services), so they don't consume IPs from pool
#
# Recommended pool size: 10-20 IPs for flexibility and future growth
# ============================================================================

---
# ============================================================================
# VERIFICATION COMMANDS
# ============================================================================
# After deploying MetalLB configuration:
#
# 1. Check IP pools:
#    kubectl get ipaddresspools -n metallb-system
#
# 2. Check L2 advertisements:
#    kubectl get l2advertisements -n metallb-system
#
# 3. View IP allocations:
#    kubectl get svc -A | grep LoadBalancer
#
# 4. Check MetalLB logs:
#    kubectl logs -n metallb-system -l component=controller
#    kubectl logs -n metallb-system -l component=speaker
#
# 5. Verify ARP announcements (from node):
#    ip neighbor show
#    arp -a
#
# 6. Test IP reachability:
#    ping <LOADBALANCER_IP>
#    curl http://<LOADBALANCER_IP>
# ============================================================================

---
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# Common issues:
#
# 1. LoadBalancer stuck in "Pending":
#    - Check MetalLB controller logs
#    - Verify IP pool addresses are correct
#    - Ensure IP range doesn't conflict with DHCP
#    - Check MetalLB speaker is running on all nodes
#
# 2. IP assigned but not reachable:
#    - Verify L2 advertisement is active
#    - Check firewall rules on nodes
#    - Verify network connectivity
#    - Check ARP table on client machine
#
# 3. IP conflicts:
#    - Use IP range outside DHCP scope
#    - Verify no other devices using IPs from pool
#    - Check for duplicate IP assignments
#
# 4. Multiple LoadBalancers sharing IP (not working):
#    - Requires metallb.universe.tf/allow-shared-ip annotation
#    - All services must have same external IP
#    - Services must use different ports
#
# 5. Node failure causing IP to move:
#    - Expected behavior in L2 mode
#    - Another node takes over ARP announcement
#    - Brief downtime (5-10 seconds) during transition
#    - Use BGP mode for faster failover
# ============================================================================

---
# ============================================================================
# NETWORK REQUIREMENTS
# ============================================================================
# For L2 mode to work:
#
# 1. All nodes must be on same Layer 2 network
#    - Same subnet/VLAN
#    - No routing between nodes and clients
#
# 2. IP range must be routable from client networks
#    - Typically same subnet as nodes
#    - Or routed via gateway
#
# 3. No IP conflicts with existing infrastructure
#    - Exclude range from DHCP
#    - Reserve IPs in network documentation
#
# 4. Firewall allows:
#    - ARP traffic (Layer 2)
#    - Traffic to/from LoadBalancer IPs
#
# For BGP mode:
#
# 1. BGP-capable router required
# 2. ASN assignment (private or public)
# 3. Router peering configuration
# 4. Route filtering and policies
# ============================================================================

---
# ============================================================================
# AIR-GAPPED DEPLOYMENT NOTES
# ============================================================================
# MetalLB works perfectly in air-gapped environments:
#
# 1. No external dependencies for L2 mode
# 2. Pure ARP-based IP announcement
# 3. All communication via Layer 2 (no internet required)
#
# Configuration steps:
# 1. Choose IP range from private network
# 2. Apply MetalLB configuration
# 3. LoadBalancer IPs work immediately within local network
#
# For intranet-only deployment:
# - LoadBalancer IPs only accessible from internal networks
# - Perfect for air-gapped Matrix deployment
# - No external exposure required
# ============================================================================
