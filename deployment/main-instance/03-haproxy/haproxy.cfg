# HAProxy Configuration for Matrix Synapse
# Routes requests to appropriate worker pools based on URL patterns
# Version: 2.8+

global
    log stdout format raw local0 info
    maxconn 50000

    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 32768
    tune.maxrewrite 8192

    # Security
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close

    timeout connect 10s
    timeout client 600s
    timeout server 600s
    timeout tunnel 3600s  # For long-polling /sync
    timeout client-fin 10s

    # Error handling
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Frontend - Client API
frontend matrix_client
    bind *:8008

    # Set headers
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-For %[src]

    # Health check endpoint
    acl is_health path /health
    use_backend health_check if is_health

    # Metrics endpoint (admin only)
    acl is_metrics path_beg /_synapse/metrics
    use_backend synapse_metrics if is_metrics

    # Route to appropriate backend based on URL pattern

    # Synchrotron workers - /sync endpoints (most critical)
    acl is_sync path_beg /_matrix/client/ path_end /sync
    acl is_events path_beg /_matrix/client/ path_end /events
    acl is_initial_sync path_beg /_matrix/client/ path_end /initialSync
    use_backend synchrotron_workers if is_sync or is_events or is_initial_sync

    # Media workers - media upload/download
    acl is_media path_beg /_matrix/media/
    acl is_upload path_beg /_matrix/client/ path_end /upload
    acl is_download path_beg /_matrix/client/ path_end /download
    acl is_thumbnail path_beg /_matrix/media/r0/thumbnail/

    # Route downloads and thumbnails through content scanner for antivirus
    use_backend content_scanner if is_download or is_thumbnail or is_media
    # Uploads go directly to media workers (scanned on download)
    use_backend media_workers if is_upload

    # Generic workers - most other client endpoints
    acl is_client path_beg /_matrix/client/
    use_backend generic_workers if is_client

    # Admin endpoints - always go to main process
    acl is_admin path_beg /_synapse/admin/
    use_backend synapse_main if is_admin

    # Fallback to main process
    default_backend synapse_main

# Frontend - Federation API
frontend matrix_federation
    bind *:8448

    # Set headers
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-For %[src]

    # All federation traffic goes to main process
    # (federation_sender workers handle outbound, main handles inbound)
    default_backend synapse_main

# Backend - Synchrotron Workers (/sync)
backend synchrotron_workers
    balance leastconn  # Best for long-polling connections
    option httpchk GET /health HTTP/1.1\r\nHost:\ matrix.example.com

    # Long timeout for /sync long-polling
    timeout server 3600s

    server-template synchrotron 16 synapse-synchrotron.matrix.svc.cluster.local:8008 check resolvers k8s init-addr none

# Backend - Content Scanner (antivirus proxy for media downloads)
backend content_scanner
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ matrix.example.com

    # Longer timeout for scanning large files
    timeout server 1800s

    # Content scanner will proxy to media workers after scanning
    server-template scanner 3 content-scanner.matrix.svc.cluster.local:8080 check resolvers k8s init-addr none

# Backend - Media Workers
backend media_workers
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ matrix.example.com

    # Longer timeout for large uploads
    timeout server 1800s

    server-template media 8 synapse-media-repository.matrix.svc.cluster.local:8008 check resolvers k8s init-addr none

# Backend - Generic Workers
backend generic_workers
    balance leastconn
    option httpchk GET /health HTTP/1.1\r\nHost:\ matrix.example.com

    server-template generic 16 synapse-generic-worker.matrix.svc.cluster.local:8008 check resolvers k8s init-addr none

# Backend - Synapse Main Process
backend synapse_main
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ matrix.example.com

    server main synapse-main-0.synapse-main.matrix.svc.cluster.local:8008 check

# Backend - Metrics (Prometheus)
backend synapse_metrics
    balance roundrobin

    server main synapse-main-0.synapse-main.matrix.svc.cluster.local:9090 check
    server-template generic 16 synapse-generic-worker.matrix.svc.cluster.local:9090 check resolvers k8s init-addr none
    server-template synchrotron 16 synapse-synchrotron.matrix.svc.cluster.local:9090 check resolvers k8s init-addr none
    server-template media 8 synapse-media-repository.matrix.svc.cluster.local:9090 check resolvers k8s init-addr none

# Backend - Health Check
backend health_check
    http-request return status 200 content-type text/plain string "OK\n"

# DNS Resolver for Kubernetes service discovery
# Reduced hold valid from 10s to 1s for faster backend discovery during scaling
resolvers k8s
    nameserver dns 10.96.0.10:53
    accepted_payload_size 8192
    hold valid 1s         # DNS cache time - reduced for faster HPA response
    hold obsolete 10s     # Keep old IPs briefly for connection draining (reduced from 30s)
    hold other 30s        # Cache other responses
    hold refused 30s      # Cache refused responses
    hold nx 30s
    hold timeout 30s

# HAProxy Statistics
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
