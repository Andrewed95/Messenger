# LiveKit Video/Voice Calling Deployment

LiveKit provides production-grade video and voice calling for Matrix via the MatrixRTC specification.

## Overview

**LiveKit** is a WebRTC SFU (Selective Forwarding Unit) that handles:
- Multi-party video calls (up to 100 participants)
- Screen sharing
- Audio conferencing
- Recording and streaming
- E2EE support

**Integration with Matrix**:
- Synapse creates LiveKit rooms dynamically
- JWT authentication (Synapse generates tokens)
- Automatic room cleanup
- Participant management via Matrix events

## Deployment Method

LiveKit is deployed via **Helm chart** (official LiveKit Helm charts).

### Installation

```bash
# Add LiveKit Helm repository
helm repo add livekit https://helm.livekit.io
helm repo update

# Install LiveKit using custom values
helm install livekit livekit/livekit-server \
  --namespace matrix \
  --values ../../values/livekit-values.yaml \
  --version 1.7.0
```

### Custom Values

The LiveKit configuration is defined in `values/livekit-values.yaml` (relative to deployment directory):

**Key Settings**:
- **Redis**: Uses Phase 1 Redis Sentinel cluster
- **TURN**: Integrates with coturn (Phase 2.4)
- **JWT**: Shared secret for Synapse integration
- **Resources**: Scaled based on concurrent call capacity
- **NodePort**: Exposes RTC ports for WebRTC media

### Synapse Integration

Update Synapse homeserver.yaml to enable LiveKit:

```yaml
experimental_features:
  msc3266_enabled: true  # MatrixRTC support

# LiveKit configuration
livekit:
  enabled: true
  livekit_url: "wss://livekit.matrix.example.com"
  livekit_api_key: "API_KEY_FROM_LIVEKIT_SECRETS"
  livekit_api_secret: "API_SECRET_FROM_LIVEKIT_SECRETS"
```

## Architecture

```
┌──────────────┐
│ Matrix Client│
│  (Element)   │
└──────┬───────┘
       │ MatrixRTC events
       ▼
┌──────────────┐
│   Synapse    │──── Generate JWT token
└──────┬───────┘
       │ WebRTC
       ▼
┌──────────────┐
│  LiveKit SFU │──── Media forwarding
│  (3 replicas)│
└──────┬───────┘
       │
   ┌───┴────┬─────────┐
   ▼        ▼         ▼
┌─────┐ ┌─────┐   ┌─────┐
│Peer1│ │Peer2│   │Peer3│
└─────┘ └─────┘   └─────┘
```

## Scaling

### By Concurrent Calls

**1-10 concurrent calls (10-50 participants)**:
```yaml
replicaCount: 1
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
```

**10-50 concurrent calls (50-200 participants)**:
```yaml
replicaCount: 2
resources:
  limits:
    cpu: 4000m
    memory: 8Gi
```

**50-100 concurrent calls (200-1000 participants)**:
```yaml
replicaCount: 3
resources:
  limits:
    cpu: 8000m
    memory: 16Gi
```

## Verification

```bash
# Check LiveKit deployment
kubectl get deployment -n matrix livekit

# Check LiveKit pods
kubectl get pods -n matrix -l app.kubernetes.io/name=livekit

# Check LiveKit logs
kubectl logs -n matrix -l app.kubernetes.io/name=livekit

# Test LiveKit API
kubectl port-forward -n matrix svc/livekit 7880:7880
curl http://localhost:7880/
```

## Troubleshooting

### LiveKit pods not starting

```bash
# Check events
kubectl describe pod -n matrix <livekit-pod>

# Verify Redis connection
kubectl exec -n matrix <livekit-pod> -- redis-cli -h redis ping
```

### WebRTC media not flowing

```bash
# Verify TURN server is accessible
kubectl get daemonset -n matrix coturn

# Check NodePort services are exposed
kubectl get svc -n matrix livekit

# Verify firewall allows UDP ports (30000-60000)
```

### Synapse can't create LiveKit rooms

```bash
# Check Synapse logs for LiveKit errors
kubectl logs -n matrix synapse-main-0 | grep -i livekit

# Verify JWT configuration matches
kubectl get secret -n matrix livekit-secrets -o yaml
```

## Security

**Network Isolation**:
- LiveKit can be accessed by: Synapse main, external WebRTC clients
- LiveKit can access: Redis
- Enforced by Phase 1 NetworkPolicies

**Authentication**:
- JWT tokens generated by Synapse
- Tokens include user_id and room_id
- Tokens expire after call ends

**Media Encryption**:
- DTLS-SRTP for media streams
- Optional E2EE for maximum security

## Monitoring

LiveKit exposes Prometheus metrics:

```bash
# Port-forward metrics
kubectl port-forward -n matrix svc/livekit 9090:9090

# View metrics
curl http://localhost:9090/metrics | grep livekit
```

**Key Metrics**:
- `livekit_room_total`: Active rooms
- `livekit_participant_total`: Active participants
- `livekit_packet_total`: Media packets flowing
- `livekit_participant_join_total`: Participant join rate

## References

- [LiveKit Documentation](https://docs.livekit.io/)
- [LiveKit Helm Chart](https://github.com/livekit/livekit-helm)
- [MatrixRTC Specification](https://github.com/matrix-org/matrix-spec-proposals/pull/3266)
