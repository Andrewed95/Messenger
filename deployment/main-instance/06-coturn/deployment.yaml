# coturn TURN/STUN Server Deployment
# Provides NAT traversal for WebRTC voice/video calls
# Required for P2P calls when clients are behind NAT/firewalls
#
# Runs as DaemonSet with hostNetwork for optimal connectivity
#
# ============================================================================
# INTRANET DEPLOYMENT
# ============================================================================
# For intranet deployments where users access the messenger from within the
# organization's network (not via internet):
#
# - EXTERNAL_IP is automatically set to the Kubernetes node IP (status.hostIP)
# - This is CORRECT for intranet deployments - clients reach the server via
#   the same internal network, so node IP is the reachable IP
# - No internet access is required for coturn to function
# - NAT traversal works between clients on the intranet
#
# When to manually set EXTERNAL_IP:
# - If nodes have multiple network interfaces and coturn should advertise a
#   specific one (e.g., dedicated VLAN for voice/video traffic)
# - If there's a NAT between coturn nodes and clients (unusual for intranet)
#
# To manually set EXTERNAL_IP (if needed):
# Change the EXTERNAL_IP env var in init container from fieldRef to:
#   - name: EXTERNAL_IP
#     value: "YOUR_IP_ADDRESS"
# ============================================================================

---
# Secret for coturn configuration
apiVersion: v1
kind: Secret
metadata:
  name: coturn-secrets
  namespace: matrix
  labels:
    app.kubernetes.io/name: coturn
    app.kubernetes.io/component: turn-server
    matrix.instance: main
type: Opaque
stringData:
  # Shared secret for TURN credential generation
  # MUST match turn_shared_secret in Synapse homeserver.yaml
  TURN_SHARED_SECRET: "CHANGEME_SECURE_TURN_SECRET"

  # Static auth (alternative to shared secret)
  TURN_USERNAME: "matrix"
  TURN_PASSWORD: "CHANGEME_TURN_PASSWORD"

---
# ConfigMap for coturn configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: coturn-config
  namespace: matrix
  labels:
    app.kubernetes.io/name: coturn
    app.kubernetes.io/component: turn-server
    matrix.instance: main
data:
  turnserver.conf: |
    # coturn TURN/STUN Server Configuration
    # For Matrix Synapse WebRTC NAT traversal

    # Listener port for TURN/STUN (UDP and TCP)
    listening-port=3478

    # TLS listener port (for TURNS)
    tls-listening-port=5349

    # Relay ports for media
    min-port=49152
    max-port=65535

    # External IP (will be set via environment variable)
    # external-ip=AUTO_DETECTED

    # Realm for TURN authentication
    realm=turn.matrix.example.com

    # Use shared secret for dynamic credentials (matches Synapse)
    use-auth-secret
    # static-auth-secret will be set via environment variable

    # Server name
    server-name=turn.matrix.example.com

    # Logging
    verbose
    log-file=stdout

    # Deny loopback and private IPs from being relayed
    no-loopback-peers
    no-multicast-peers

    # Allowed peer IPs (allow all by default)
    # Uncomment to restrict:
    # denied-peer-ip=0.0.0.0-0.255.255.255
    # denied-peer-ip=10.0.0.0-10.255.255.255
    # denied-peer-ip=172.16.0.0-172.31.255.255
    # denied-peer-ip=192.168.0.0-192.168.255.255

    # Quota and limits
    total-quota=100
    bps-capacity=0
    stale-nonce=600

    # TLS certificates (mounted from Secret)
    cert=/etc/coturn/certs/tls.crt
    pkey=/etc/coturn/certs/tls.key

    # Security
    fingerprint
    lt-cred-mech
    no-tlsv1
    no-tlsv1_1

    # Mobility
    mobility

    # CLI access (disabled for security)
    no-cli

---
# coturn DaemonSet (runs on all nodes for optimal connectivity)
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: coturn
  namespace: matrix
  labels:
    app.kubernetes.io/name: coturn
    app.kubernetes.io/component: turn-server
    app.kubernetes.io/version: "4.6"
    matrix.instance: main
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: coturn
      app.kubernetes.io/component: turn-server

  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

  template:
    metadata:
      labels:
        app.kubernetes.io/name: coturn
        app.kubernetes.io/component: turn-server
        app.kubernetes.io/version: "4.6"
        matrix.instance: main
      annotations:
        prometheus.io/scrape: "false"  # coturn doesn't expose Prometheus metrics

    spec:
      # CRITICAL: Use host network for TURN to work properly
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      # Security context
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      # Tolerate all taints to run on all nodes
      tolerations:
        - operator: Exists

      # Init container to generate complete coturn config with secrets
      initContainers:
        - name: generate-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # Determine external IP address
              # For intranet deployments:
              # - The node IP (status.hostIP) is the correct value
              # - Clients reach coturn via internal network, so node IP is correct

              if [ -n "$EXTERNAL_IP" ]; then
                echo "Using EXTERNAL_IP: $EXTERNAL_IP"
                echo "INFO: This is the IP address coturn will advertise to clients"
                echo "INFO: Clients must be able to reach this IP for TURN to work"
              else
                # Fall back to hostname IP (unlikely to be reached for DaemonSet)
                EXTERNAL_IP=$(hostname -i | awk '{print $1}')
                echo "EXTERNAL_IP not set via env - using hostname IP: $EXTERNAL_IP"
              fi

              # Copy base config and append runtime values
              cp /config-template/turnserver.conf /tmp/turnserver.conf

              # Add external IP
              echo "" >> /tmp/turnserver.conf
              echo "# Runtime configuration (generated by init container)" >> /tmp/turnserver.conf
              echo "external-ip=$EXTERNAL_IP" >> /tmp/turnserver.conf

              # Add shared secret for authentication
              # CRITICAL: use-auth-secret requires static-auth-secret to be set
              echo "static-auth-secret=$TURN_SHARED_SECRET" >> /tmp/turnserver.conf

              echo "Config generation complete"
          env:
            - name: TURN_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: coturn-secrets
                  key: TURN_SHARED_SECRET
            # CRITICAL: Set EXTERNAL_IP for NAT traversal
            # Options:
            # 1. Static IP: Use 'value: "YOUR_EXTERNAL_IP"'
            # 2. Node IP: Use fieldRef to get node's external IP (see below)
            # 3. Leave empty: Falls back to pod IP (not recommended for production)
            - name: EXTERNAL_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP  # Uses Kubernetes node IP
          volumeMounts:
            - name: config-template
              mountPath: /config-template
            - name: tmp
              mountPath: /tmp
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

      containers:
        - name: coturn
          image: coturn/coturn:4.6-alpine
          imagePullPolicy: IfNotPresent

          command:
            - turnserver
            - -c
            - /tmp/turnserver.conf

          ports:
            # TURN/STUN UDP
            - name: turn-udp
              containerPort: 3478
              protocol: UDP
              hostPort: 3478
            # TURN/STUN TCP
            - name: turn-tcp
              containerPort: 3478
              protocol: TCP
              hostPort: 3478
            # TURNS (TLS) TCP
            - name: turns-tcp
              containerPort: 5349
              protocol: TCP
              hostPort: 5349
            # Media relay ports (49152-65535)
            # Note: These are allocated dynamically by coturn

          env:
            - name: TURN_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: coturn-secrets
                  key: TURN_SHARED_SECRET
            - name: TURN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: coturn-secrets
                  key: TURN_USERNAME
            - name: TURN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: coturn-secrets
                  key: TURN_PASSWORD

          volumeMounts:
            # Config is generated in /tmp by init container
            - name: tmp
              mountPath: /tmp
            - name: tls
              mountPath: /etc/coturn/certs
              readOnly: true

          # Resource limits
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

          # Liveness probe (check if turnserver is running)
          livenessProbe:
            exec:
              command:
                - pgrep
                - turnserver
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          # Readiness probe (check TURN/STUN ports)
          readinessProbe:
            tcpSocket:
              port: 3478
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 2

          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              drop:
                - ALL
              # NET_BIND_SERVICE not needed - ports 3478 and 5349 are > 1024

      volumes:
        - name: config-template
          configMap:
            name: coturn-config
        - name: tmp
          emptyDir: {}
        - name: tls
          secret:
            secretName: coturn-tls
            optional: true  # Will use self-signed if not provided

---
# Service for coturn (for Kubernetes DNS)
apiVersion: v1
kind: Service
metadata:
  name: coturn
  namespace: matrix
  labels:
    app.kubernetes.io/name: coturn
    app.kubernetes.io/component: turn-server
spec:
  type: NodePort  # Expose on all nodes
  selector:
    app.kubernetes.io/name: coturn
    app.kubernetes.io/component: turn-server
  ports:
    - name: turn-udp
      port: 3478
      targetPort: 3478
      protocol: UDP
      nodePort: 30478
    - name: turn-tcp
      port: 3478
      targetPort: 3478
      protocol: TCP
      nodePort: 30478
    - name: turns-tcp
      port: 5349
      targetPort: 5349
      protocol: TCP
      nodePort: 30549

---
# Certificate for TURNS (TLS) - optional, can use self-signed
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: coturn-tls
  namespace: matrix
  labels:
    app.kubernetes.io/name: coturn
    app.kubernetes.io/component: turn-server
spec:
  secretName: coturn-tls
  # Uses letsencrypt-prod for initial deployment (per CLAUDE.md 4.5)
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - turn.matrix.example.com
  usages:
    - digital signature
    - key encipherment
    - server auth
