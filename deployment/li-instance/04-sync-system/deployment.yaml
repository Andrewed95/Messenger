# Sync System for LI Instance
# ⭐ CRITICAL: Bridge between main and LI instances ⭐
#
# Handles two types of synchronization:
# 1. PostgreSQL Logical Replication: Real-time database sync from main to LI
# 2. MinIO/rclone Media Sync: Periodic media file sync between buckets
#
# IMPORTANT: This is the ONLY component with access to BOTH main and LI resources
# Enforced by sync-system-access NetworkPolicy

---
# ConfigMap for sync system
apiVersion: v1
kind: ConfigMap
metadata:
  name: sync-system-config
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: replication
    matrix.instance: sync
data:
  # PostgreSQL replication setup script
  setup-replication.sql: |
    -- Run this on MAIN PostgreSQL cluster to set up logical replication
    -- NOTE: This must be run as PostgreSQL superuser (postgres)

    -- 1. Create publication on main database (if not exists)
    DO $$
    BEGIN
      IF NOT EXISTS (
        SELECT 1 FROM pg_publication WHERE pubname = 'matrix_li_publication'
      ) THEN
        CREATE PUBLICATION matrix_li_publication FOR ALL TABLES;
      END IF;
    END $$;

    -- 2. Grant permissions for replication
    -- The postgres user already has replication privileges in CloudNativePG
    -- We just need to ensure tables are accessible
    GRANT SELECT ON ALL TABLES IN SCHEMA public TO postgres;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO postgres;

    -- 3. CloudNativePG automatically configures pg_hba.conf for replication
    -- No manual configuration needed

  # PostgreSQL subscription setup script (run on LI)
  setup-subscription.sql: |
    -- Run this on LI PostgreSQL cluster to subscribe to main
    -- NOTE: Connection string uses postgres user for replication privileges

    -- 1. Create subscription (if not exists)
    DO $$
    DECLARE
      conn_string TEXT;
    BEGIN
      -- Build connection string for replication
      -- Using postgres superuser which has replication privileges
      conn_string := format(
        'host=%s port=%s dbname=%s user=%s password=%s',
        '${MAIN_DB_HOST}',
        '${MAIN_DB_PORT}',
        '${MAIN_DB_NAME}',
        'postgres',  -- Must use postgres for replication
        '${POSTGRES_PASSWORD}'
      );

      IF NOT EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'matrix_li_subscription'
      ) THEN
        EXECUTE format('CREATE SUBSCRIPTION matrix_li_subscription CONNECTION %L PUBLICATION matrix_li_publication', conn_string);
      END IF;
    END $$;

    -- 2. Monitor replication lag
    SELECT
      subname,
      received_lsn,
      latest_end_lsn,
      pg_wal_lsn_diff(latest_end_lsn, received_lsn) AS replication_lag_bytes
    FROM pg_subscription_rel
    JOIN pg_subscription ON subrelid = srrelid;

  # rclone configuration for MinIO sync
  rclone.conf: |
    [minio-main]
    type = s3
    provider = Minio
    env_auth = false
    access_key_id = ${S3_ACCESS_KEY}
    secret_access_key = ${S3_SECRET_KEY}
    endpoint = http://minio.matrix.svc.cluster.local:9000

    [minio-li]
    type = s3
    provider = Minio
    env_auth = false
    access_key_id = ${S3_ACCESS_KEY}
    secret_access_key = ${S3_SECRET_KEY}
    endpoint = http://minio.matrix.svc.cluster.local:9000

  # Sync script
  sync.sh: |
    #!/bin/bash
    set -e

    echo "Starting sync at $(date)"

    # Sync media from main bucket to LI bucket
    echo "Syncing media files..."
    rclone sync \
      minio-main:synapse-media \
      minio-li:synapse-media-li \
      --config /config/rclone.conf \
      --progress \
      --stats 10s \
      --transfers 10 \
      --checkers 20 \
      --fast-list \
      --no-update-modtime \
      --checksum

    echo "Media sync completed at $(date)"

    # Note: PostgreSQL replication lag monitoring is handled separately
    # The database replication is managed by CloudNativePG logical replication

    echo "Sync completed successfully at $(date)"

---
# Secret for sync system
apiVersion: v1
kind: Secret
metadata:
  name: sync-system-secrets
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: replication
type: Opaque
stringData:
  # Main PostgreSQL (for replication - using postgres superuser)
  # NOTE: For logical replication setup only, not for regular queries
  MAIN_DB_HOST: "matrix-postgresql-rw.matrix.svc.cluster.local"
  MAIN_DB_PORT: "5432"
  MAIN_DB_NAME: "matrix"
  MAIN_DB_USER: "postgres"  # Must use postgres for replication privileges
  MAIN_DB_PASSWORD: "CHANGEME_POSTGRES_SUPERUSER_PASSWORD"  # From matrix-postgresql-superuser secret

  # LI PostgreSQL (for subscription setup - using postgres superuser)
  # NOTE: For logical replication setup only, not for regular queries
  LI_DB_HOST: "matrix-postgresql-li-rw.matrix.svc.cluster.local"
  LI_DB_PORT: "5432"
  LI_DB_NAME: "matrix_li"
  LI_DB_USER: "postgres"  # Must use postgres for creating subscription
  LI_DB_PASSWORD: "CHANGEME_LI_POSTGRES_SUPERUSER_PASSWORD"  # From matrix-postgresql-li-superuser secret

  # S3/MinIO credentials
  S3_ACCESS_KEY: "synapse-s3-user"
  S3_SECRET_KEY: "CHANGEME_SECURE_S3_PASSWORD"

---
# Job to set up PostgreSQL replication (run once)
apiVersion: batch/v1
kind: Job
metadata:
  name: sync-system-setup-replication
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: setup
spec:
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        runAsNonRoot: true
      containers:
        - name: setup-replication
          image: postgres:16-alpine
          command:
            - sh
            - -c
            - |
              echo "Setting up logical replication..."

              # Set up publication on main (needs superuser access)
              echo "Creating publication on main database..."
              # Using postgres superuser for setup
              PGPASSWORD="${POSTGRES_PASSWORD}" psql \
                -h "$MAIN_DB_HOST" \
                -U postgres \
                -d "$MAIN_DB_NAME" \
                -f /config/setup-replication.sql

              echo "Waiting 10 seconds for publication to be ready..."
              sleep 10

              # Set up subscription on LI
              echo "Creating subscription on LI database..."
              # Using postgres superuser for subscription creation
              # First substitute environment variables in the SQL script
              sed -e "s|\${MAIN_DB_HOST}|$MAIN_DB_HOST|g" \
                  -e "s|\${MAIN_DB_PORT}|$MAIN_DB_PORT|g" \
                  -e "s|\${MAIN_DB_NAME}|$MAIN_DB_NAME|g" \
                  -e "s|\${POSTGRES_PASSWORD}|$POSTGRES_PASSWORD|g" \
                  /config/setup-subscription.sql > /tmp/setup-subscription.sql

              PGPASSWORD="$LI_POSTGRES_PASSWORD" psql \
                -h "$LI_DB_HOST" \
                -U postgres \
                -d "$LI_DB_NAME" \
                -f /tmp/setup-subscription.sql

              echo "Logical replication setup complete!"
              echo "Checking replication status..."
              PGPASSWORD="$LI_POSTGRES_PASSWORD" psql \
                -h "$LI_DB_HOST" \
                -U postgres \
                -d "$LI_DB_NAME" \
                -c "SELECT subname, subenabled, subslotname FROM pg_subscription;"
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-postgresql-superuser
                  key: password  # CloudNativePG creates this secret automatically
            - name: LI_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-postgresql-li-superuser
                  key: password  # CloudNativePG creates this secret automatically
            - name: MAIN_DB_HOST
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_HOST
            - name: MAIN_DB_USER
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_USER
            - name: MAIN_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_PASSWORD
            - name: MAIN_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_NAME
            - name: LI_DB_HOST
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_HOST
            - name: LI_DB_USER
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_USER
            - name: LI_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_PASSWORD
            - name: LI_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_NAME
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          configMap:
            name: sync-system-config

---
# CronJob for periodic media sync
apiVersion: batch/v1
kind: CronJob
metadata:
  name: sync-system-media
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: media-sync
spec:
  schedule: "*/15 * * * *"  # Every 15 minutes
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # Don't run multiple sync jobs simultaneously

  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: sync-system
            app.kubernetes.io/component: media-sync
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            runAsNonRoot: true

          containers:
            - name: rclone-sync
              # rclone for media synchronization
              image: rclone/rclone:1.65-alpine
              command:
                - sh
                - -c
                - |
                  # Run sync script (media sync only, replication lag check removed)
                  sh /config/sync.sh
              env:
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: sync-system-secrets
                      key: S3_ACCESS_KEY
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: sync-system-secrets
                      key: S3_SECRET_KEY
                - name: LI_DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: sync-system-secrets
                      key: LI_DB_HOST
                - name: LI_DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: sync-system-secrets
                      key: LI_DB_USER
                - name: LI_DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: sync-system-secrets
                      key: LI_DB_PASSWORD
                - name: LI_DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: sync-system-secrets
                      key: LI_DB_NAME
              volumeMounts:
                - name: config
                  mountPath: /config
                - name: tmp
                  mountPath: /tmp
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "250m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"

          volumes:
            - name: config
              configMap:
                name: sync-system-config
                defaultMode: 0755
            - name: tmp
              emptyDir: {}

---
# Service for monitoring sync system (optional)
apiVersion: v1
kind: Service
metadata:
  name: sync-system
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: replication
spec:
  clusterIP: None
  selector:
    app.kubernetes.io/name: sync-system
  ports:
    - name: metrics
      port: 9090
      protocol: TCP
