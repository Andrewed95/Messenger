# Sync System for LI Instance
# ⭐ CRITICAL: Bridge between main and LI instances ⭐
#
# Handles database synchronization:
# - PostgreSQL Logical Replication: Real-time database sync from main to LI
#
# NOTE: Media sync is NOT needed - LI uses main MinIO directly via S3 API
#
# IMPORTANT: This is the ONLY component with access to BOTH main and LI PostgreSQL
# Enforced by sync-system-access NetworkPolicy

---
# ConfigMap for sync system
apiVersion: v1
kind: ConfigMap
metadata:
  name: sync-system-config
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: replication
    matrix.instance: sync
data:
  # PostgreSQL replication setup script
  setup-replication.sql: |
    -- Run this on MAIN PostgreSQL cluster to set up logical replication
    -- NOTE: This must be run as PostgreSQL superuser (postgres)

    -- 1. Create publication on main database (if not exists)
    DO $$
    BEGIN
      IF NOT EXISTS (
        SELECT 1 FROM pg_publication WHERE pubname = 'matrix_li_publication'
      ) THEN
        CREATE PUBLICATION matrix_li_publication FOR ALL TABLES;
      END IF;
    END $$;

    -- 2. Grant permissions for replication
    -- The postgres user already has replication privileges in CloudNativePG
    -- We just need to ensure tables are accessible
    GRANT SELECT ON ALL TABLES IN SCHEMA public TO postgres;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO postgres;

    -- 3. CloudNativePG automatically configures pg_hba.conf for replication
    -- No manual configuration needed

  # PostgreSQL subscription setup script (run on LI)
  setup-subscription.sql: |
    -- Run this on LI PostgreSQL cluster to subscribe to main
    -- NOTE: Connection string uses postgres user for replication privileges

    -- 1. Create subscription (if not exists)
    DO $$
    DECLARE
      conn_string TEXT;
    BEGIN
      -- Build connection string for replication
      -- Using postgres superuser which has replication privileges
      conn_string := format(
        'host=%s port=%s dbname=%s user=%s password=%s',
        '${MAIN_DB_HOST}',
        '${MAIN_DB_PORT}',
        '${MAIN_DB_NAME}',
        'postgres',  -- Must use postgres for replication
        '${POSTGRES_PASSWORD}'
      );

      IF NOT EXISTS (
        SELECT 1 FROM pg_subscription WHERE subname = 'matrix_li_subscription'
      ) THEN
        EXECUTE format('CREATE SUBSCRIPTION matrix_li_subscription CONNECTION %L PUBLICATION matrix_li_publication', conn_string);
      END IF;
    END $$;

    -- 2. Monitor replication lag
    SELECT
      subname,
      received_lsn,
      latest_end_lsn,
      pg_wal_lsn_diff(latest_end_lsn, received_lsn) AS replication_lag_bytes
    FROM pg_subscription_rel
    JOIN pg_subscription ON subrelid = srrelid;

  # ARCHITECTURE NOTE:
  # - LI instance uses MAIN MinIO directly (no separate LI MinIO)
  # - Media sync is NOT needed - LI reads from main MinIO via S3 API
  # - Only PostgreSQL logical replication is used for database sync
  # - This simplifies architecture and reduces storage requirements
  #
  # rclone configuration removed - media sync no longer needed

---
# Secret for sync system
# NOTE: PostgreSQL superuser passwords are NOT stored here.
# The setup Job uses CloudNativePG-managed secrets:
# - matrix-postgresql-superuser (main cluster)
# - matrix-postgresql-li-superuser (LI cluster)
# This is more secure and follows CloudNativePG best practices.
apiVersion: v1
kind: Secret
metadata:
  name: sync-system-secrets
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: replication
type: Opaque
stringData:
  # Main PostgreSQL connection info (for replication setup)
  # Passwords come from CloudNativePG-managed secrets, not here
  MAIN_DB_HOST: "matrix-postgresql-rw.matrix.svc.cluster.local"
  MAIN_DB_PORT: "5432"
  MAIN_DB_NAME: "matrix"

  # LI PostgreSQL connection info (for subscription setup)
  # Passwords come from CloudNativePG-managed secrets, not here
  LI_DB_HOST: "matrix-postgresql-li-rw.matrix.svc.cluster.local"
  LI_DB_PORT: "5432"
  LI_DB_NAME: "matrix_li"

  # Sync system handles PostgreSQL replication only
  # LI Synapse accesses main MinIO directly (credentials in synapse-li-secrets)

---
# Job to set up PostgreSQL logical replication (run once)
#
# WHY SUPERUSER IS REQUIRED:
# PostgreSQL logical replication requires superuser privileges because:
# 1. CREATE SUBSCRIPTION creates background workers (walsender on publisher)
# 2. CREATE SUBSCRIPTION creates replication slots (privileged operation)
# 3. The subscription needs to connect with REPLICATION privilege
#
# While PostgreSQL 15+ allows non-superuser subscriptions, it requires
# complex permission setup (REPLICATION privilege, SET ROLE to table owners).
# Using CloudNativePG-managed superuser secrets is simpler and more reliable.
#
# The superuser passwords are managed securely by CloudNativePG:
# - matrix-postgresql-superuser (main cluster)
# - matrix-postgresql-li-superuser (LI cluster)
#
# This Job runs ONCE during initial deployment to configure replication.
# After setup, PostgreSQL handles replication automatically.
apiVersion: batch/v1
kind: Job
metadata:
  name: sync-system-setup-replication
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: setup
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: sync-system
        app.kubernetes.io/component: setup
        matrix.instance: sync
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
        runAsNonRoot: true

      # CLAUDE.md Section 7.1: All LI services must run on one server
      # Sync system is an LI component that runs on the LI node
      # Note: It needs network access to BOTH main and LI PostgreSQL
      nodeSelector:
        node-role.kubernetes.io/li: "true"

      # Tolerate LI node taints (if the node is dedicated to LI workloads)
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "li"
          effect: "NoSchedule"

      containers:
        - name: setup-replication
          image: postgres:16-alpine
          command:
            - sh
            - -c
            - |
              echo "Setting up logical replication..."

              # Set up publication on main (needs superuser access)
              echo "Creating publication on main database..."
              # Using postgres superuser for setup
              PGPASSWORD="${POSTGRES_PASSWORD}" psql \
                -h "$MAIN_DB_HOST" \
                -U postgres \
                -d "$MAIN_DB_NAME" \
                -f /config/setup-replication.sql

              echo "Waiting 10 seconds for publication to be ready..."
              sleep 10

              # Set up subscription on LI
              echo "Creating subscription on LI database..."
              # Using postgres superuser for subscription creation
              # First substitute environment variables in the SQL script
              sed -e "s|\${MAIN_DB_HOST}|$MAIN_DB_HOST|g" \
                  -e "s|\${MAIN_DB_PORT}|$MAIN_DB_PORT|g" \
                  -e "s|\${MAIN_DB_NAME}|$MAIN_DB_NAME|g" \
                  -e "s|\${POSTGRES_PASSWORD}|$POSTGRES_PASSWORD|g" \
                  /config/setup-subscription.sql > /tmp/setup-subscription.sql

              PGPASSWORD="$LI_POSTGRES_PASSWORD" psql \
                -h "$LI_DB_HOST" \
                -U postgres \
                -d "$LI_DB_NAME" \
                -f /tmp/setup-subscription.sql

              echo "Logical replication setup complete!"
              echo "Checking replication status..."
              PGPASSWORD="$LI_POSTGRES_PASSWORD" psql \
                -h "$LI_DB_HOST" \
                -U postgres \
                -d "$LI_DB_NAME" \
                -c "SELECT subname, subenabled, subslotname FROM pg_subscription;"
          env:
            # PostgreSQL superuser passwords from CloudNativePG-managed secrets
            # These are the ONLY database passwords we use - no duplicates elsewhere
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-postgresql-superuser
                  key: password
            - name: LI_POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-postgresql-li-superuser
                  key: password
            # Connection info from sync-system-secrets (passwords NOT stored there)
            - name: MAIN_DB_HOST
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_HOST
            - name: MAIN_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_NAME
            - name: MAIN_DB_PORT
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: MAIN_DB_PORT
            - name: LI_DB_HOST
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_HOST
            - name: LI_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_NAME
            - name: LI_DB_PORT
              valueFrom:
                secretKeyRef:
                  name: sync-system-secrets
                  key: LI_DB_PORT
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          configMap:
            name: sync-system-config

---
# Service for monitoring sync system (optional)
apiVersion: v1
kind: Service
metadata:
  name: sync-system
  namespace: matrix
  labels:
    app.kubernetes.io/name: sync-system
    app.kubernetes.io/component: replication
spec:
  clusterIP: None
  selector:
    app.kubernetes.io/name: sync-system
  ports:
    - name: metrics
      port: 9090
      protocol: TCP
