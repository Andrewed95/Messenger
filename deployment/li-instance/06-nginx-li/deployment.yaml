# NGINX Reverse Proxy for LI Instance
# ============================================================================
# CRITICAL: This is the dedicated reverse proxy for the LI instance.
# It operates INDEPENDENTLY of the main instance's ingress controller.
# If the main instance goes down, this nginx continues to serve LI traffic.
# ============================================================================
#
# This nginx handles:
# - TLS termination for all LI domains
# - Routing to synapse-li, element-web-li, synapse-admin-li, key_vault
# - External access via LoadBalancer (or NodePort)
#
# DNS Requirements (LI admins must configure):
# - matrix.example.com     → LI LoadBalancer IP (same homeserver URL as main)
# - chat-li.example.com    → LI LoadBalancer IP
# - admin-li.example.com   → LI LoadBalancer IP
# - keyvault.example.com   → LI LoadBalancer IP
#
# TLS Certificates:
# - You must provide TLS certificates for all domains
# - Create secrets before deploying this nginx
# - See instructions at bottom of file

---
# ConfigMap for NGINX configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-li-config
  namespace: matrix
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/component: reverse-proxy
    app.kubernetes.io/instance: li
    matrix.instance: li
data:
  nginx.conf: |
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /tmp/nginx.pid;

    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
        access_log /var/log/nginx/access.log main;

        # Performance
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        # Temp paths (for read-only root filesystem)
        client_body_temp_path /tmp/client_body;
        proxy_temp_path /tmp/proxy;
        fastcgi_temp_path /tmp/fastcgi;
        uwsgi_temp_path /tmp/uwsgi;
        scgi_temp_path /tmp/scgi;

        # SSL settings
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # Client body size for file uploads
        client_max_body_size 100m;

        # Resolver for Kubernetes DNS
        resolver kube-dns.kube-system.svc.cluster.local valid=30s;

        # =========================================================================
        # SYNAPSE LI (Homeserver - SAME domain as main)
        # =========================================================================
        # CRITICAL: This uses the SAME homeserver URL as main (matrix.example.com)
        # LI admins must configure their DNS to resolve this to the LI LoadBalancer IP
        server {
            listen 443 ssl http2;
            # CHANGEME: Replace with your homeserver domain (same as main)
            server_name matrix.example.com;

            # TLS certificate (must match homeserver domain)
            ssl_certificate /etc/nginx/certs/synapse-li/tls.crt;
            ssl_certificate_key /etc/nginx/certs/synapse-li/tls.key;

            # Proxy to Synapse LI
            location / {
                proxy_pass http://synapse-li-client.matrix.svc.cluster.local:8008;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # WebSocket support for /sync
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                # Timeouts for long-polling /sync
                proxy_read_timeout 600s;
                proxy_send_timeout 600s;
            }

            # Health check endpoint
            location /nginx-health {
                return 200 'OK';
                add_header Content-Type text/plain;
            }
        }

        # =========================================================================
        # ELEMENT WEB LI (Different domain from main)
        # =========================================================================
        server {
            listen 443 ssl http2;
            # CHANGEME: Replace with your Element Web LI domain
            server_name chat-li.example.com;

            ssl_certificate /etc/nginx/certs/element-web-li/tls.crt;
            ssl_certificate_key /etc/nginx/certs/element-web-li/tls.key;

            location / {
                proxy_pass http://element-web-li.matrix.svc.cluster.local:80;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }

        # =========================================================================
        # SYNAPSE ADMIN LI (Different domain from main)
        # =========================================================================
        server {
            listen 443 ssl http2;
            # CHANGEME: Replace with your Synapse Admin LI domain
            server_name admin-li.example.com;

            ssl_certificate /etc/nginx/certs/synapse-admin-li/tls.crt;
            ssl_certificate_key /etc/nginx/certs/synapse-admin-li/tls.key;

            location / {
                proxy_pass http://synapse-admin-li.matrix.svc.cluster.local:80;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }

        # =========================================================================
        # KEY_VAULT (Different domain - LI network only)
        # =========================================================================
        server {
            listen 443 ssl http2;
            # CHANGEME: Replace with your key_vault domain
            server_name keyvault.example.com;

            ssl_certificate /etc/nginx/certs/key-vault/tls.crt;
            ssl_certificate_key /etc/nginx/certs/key-vault/tls.key;

            location / {
                proxy_pass http://key-vault.matrix.svc.cluster.local:8000;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Django static files
            location /static/ {
                proxy_pass http://key-vault.matrix.svc.cluster.local:8000/static/;
            }
        }

        # =========================================================================
        # HTTP to HTTPS redirect (port 80)
        # =========================================================================
        server {
            listen 80 default_server;
            server_name _;

            # Health check endpoint (for Kubernetes probes)
            # Must be before the redirect to avoid 301 response
            location /nginx-health {
                return 200 'OK';
                add_header Content-Type text/plain;
            }

            # Redirect all other traffic to HTTPS
            location / {
                return 301 https://$host$request_uri;
            }
        }
    }

---
# NGINX Deployment for LI
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-li
  namespace: matrix
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/component: reverse-proxy
    app.kubernetes.io/instance: li
    matrix.instance: li
spec:
  replicas: 1  # Single replica (LI doesn't need HA)

  selector:
    matchLabels:
      app.kubernetes.io/name: nginx
      app.kubernetes.io/component: reverse-proxy
      app.kubernetes.io/instance: li

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app.kubernetes.io/name: nginx
        app.kubernetes.io/component: reverse-proxy
        app.kubernetes.io/instance: li
        matrix.instance: li
      annotations:
        prometheus.io/scrape: "false"

    spec:
      securityContext:
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      # Schedule on LI server nodes
      nodeSelector:
        node-role.kubernetes.io/li: "true"

      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "li"
          effect: "NoSchedule"

      containers:
        - name: nginx
          image: nginx:1.25-alpine
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 80
              protocol: TCP
            - name: https
              containerPort: 443
              protocol: TCP

          volumeMounts:
            - name: config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
              readOnly: true
            # TLS certificates for each service
            - name: synapse-li-tls
              mountPath: /etc/nginx/certs/synapse-li
              readOnly: true
            - name: element-web-li-tls
              mountPath: /etc/nginx/certs/element-web-li
              readOnly: true
            - name: synapse-admin-li-tls
              mountPath: /etc/nginx/certs/synapse-admin-li
              readOnly: true
            - name: key-vault-tls
              mountPath: /etc/nginx/certs/key-vault
              readOnly: true
            # Temp directories
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /var/cache/nginx
            - name: run
              mountPath: /var/run
            - name: log
              mountPath: /var/log/nginx

          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"

          # Health probes use HTTP port 80 (not HTTPS) for simplicity
          # The /nginx-health endpoint is defined in the HTTP server block
          livenessProbe:
            httpGet:
              path: /nginx-health
              port: 80
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /nginx-health
              port: 80
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 2

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 101
            runAsGroup: 101
            capabilities:
              drop:
                - ALL

      volumes:
        - name: config
          configMap:
            name: nginx-li-config
        # TLS certificate secrets - must be created before deploying
        - name: synapse-li-tls
          secret:
            secretName: nginx-li-synapse-tls
            optional: false
        - name: element-web-li-tls
          secret:
            secretName: nginx-li-element-tls
            optional: false
        - name: synapse-admin-li-tls
          secret:
            secretName: nginx-li-admin-tls
            optional: false
        - name: key-vault-tls
          secret:
            secretName: nginx-li-keyvault-tls
            optional: false
        - name: tmp
          emptyDir: {}
        - name: cache
          emptyDir: {}
        - name: run
          emptyDir: {}
        - name: log
          emptyDir: {}

---
# NGINX LI Service - LoadBalancer for external access
apiVersion: v1
kind: Service
metadata:
  name: nginx-li
  namespace: matrix
  labels:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/component: reverse-proxy
    app.kubernetes.io/instance: li
    matrix.instance: li
  annotations:
    # If using MetalLB, specify the address pool for LI
    # metallb.universe.tf/address-pool: li-pool
    description: |
      LI Instance reverse proxy - INDEPENDENT of main ingress.
      Handles HTTPS for all LI services.
spec:
  type: LoadBalancer  # Use NodePort if LoadBalancer not available
  selector:
    app.kubernetes.io/name: nginx
    app.kubernetes.io/component: reverse-proxy
    app.kubernetes.io/instance: li
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: https
      port: 443
      targetPort: 443
      protocol: TCP

  # OPTIONAL: If you need a specific IP address
  # loadBalancerIP: 10.0.2.100

---
# ============================================================================
# TLS CERTIFICATE SECRETS
# ============================================================================
# You must create TLS certificate secrets before deploying this nginx.
# Each LI service needs its own certificate.
#
# Option 1: Self-signed certificates (for testing or internal deployments)
# --------------------------------------------------------------------------
# Generate self-signed certificates:
#
# # Synapse LI (homeserver - same domain as main)
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout synapse-li-tls.key -out synapse-li-tls.crt \
#   -subj "/CN=matrix.example.com"
# kubectl create secret tls nginx-li-synapse-tls \
#   --cert=synapse-li-tls.crt --key=synapse-li-tls.key -n matrix
#
# # Element Web LI
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout element-li-tls.key -out element-li-tls.crt \
#   -subj "/CN=chat-li.example.com"
# kubectl create secret tls nginx-li-element-tls \
#   --cert=element-li-tls.crt --key=element-li-tls.key -n matrix
#
# # Synapse Admin LI
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout admin-li-tls.key -out admin-li-tls.crt \
#   -subj "/CN=admin-li.example.com"
# kubectl create secret tls nginx-li-admin-tls \
#   --cert=admin-li-tls.crt --key=admin-li-tls.key -n matrix
#
# # key_vault
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#   -keyout keyvault-tls.key -out keyvault-tls.crt \
#   -subj "/CN=keyvault.example.com"
# kubectl create secret tls nginx-li-keyvault-tls \
#   --cert=keyvault-tls.crt --key=keyvault-tls.key -n matrix
#
# Option 2: Organization-provided certificates
# --------------------------------------------------------------------------
# If your organization provides certificates:
#
# kubectl create secret tls nginx-li-synapse-tls \
#   --cert=/path/to/matrix.example.com.crt \
#   --key=/path/to/matrix.example.com.key -n matrix
#
# (Repeat for each service domain)
#
# Option 3: Wildcard certificate
# --------------------------------------------------------------------------
# If you have a wildcard certificate for *.example.com:
#
# kubectl create secret tls nginx-li-wildcard-tls \
#   --cert=/path/to/wildcard.crt \
#   --key=/path/to/wildcard.key -n matrix
#
# Then update the volume mounts above to use this single secret for all services.
#
# ============================================================================
# VERIFICATION
# ============================================================================
# After deploying, verify nginx-li is working:
#
# # Check pods
# kubectl get pods -n matrix -l app.kubernetes.io/name=nginx,app.kubernetes.io/instance=li
#
# # Check service and get LoadBalancer IP
# kubectl get svc nginx-li -n matrix
#
# # Test HTTPS (from a machine with DNS configured to point to LI)
# curl -k https://matrix.example.com/_matrix/client/versions
# curl -k https://chat-li.example.com/
# curl -k https://admin-li.example.com/
# curl -k https://keyvault.example.com/admin
#
# ============================================================================
# DNS CONFIGURATION FOR LI ADMINS
# ============================================================================
# LI administrators must configure their DNS to resolve domains to the LI
# LoadBalancer IP, NOT the main instance IP.
#
# Option 1: /etc/hosts on admin workstation
# --------------------------------------------------------------------------
# Add to /etc/hosts (Linux/Mac) or C:\Windows\System32\drivers\etc\hosts (Windows):
#
# <LI-LoadBalancer-IP>  matrix.example.com
# <LI-LoadBalancer-IP>  chat-li.example.com
# <LI-LoadBalancer-IP>  admin-li.example.com
# <LI-LoadBalancer-IP>  keyvault.example.com
#
# Option 2: LI Network DNS Server
# --------------------------------------------------------------------------
# Configure a DNS server in the LI network that resolves these domains
# to the LI LoadBalancer IP.
#
# Option 3: Split-horizon DNS
# --------------------------------------------------------------------------
# Configure your organization's DNS to return different IPs based on
# the requesting network (main network vs LI network).
#
# ============================================================================
