# Synapse LI (Lawful Intercept) Instance Configuration
# ⭐ Writable instance for law enforcement access ⭐
#
# Key Differences from Main Instance:
# - Writable database (LI admin can reset user passwords)
# - Changes overwritten on next sync (pg_dump/pg_restore)
# - No federation (no outbound connections)
# - No registration (users synced from main)
# - No worker support (single process only)
# - Separate PostgreSQL cluster (matrix-postgresql-li)
# - Shared MinIO bucket (synapse-media - same as main, read-only access)
# - Displays ALL messages including soft-deleted (redaction_retention_period: null synced from main)

# CRITICAL: Both server_name and public_baseurl MUST match main instance
# LI uses replicated data from main - different URLs break Matrix protocol
# (signatures, tokens, user IDs all reference the same server_name)
# Access to LI is controlled via network isolation, NOT different URLs
server_name: "matrix.example.com"
public_baseurl: "https://matrix.example.com"
pid_file: /data/homeserver.pid

# ==================== LISTENERS ====================

listeners:
  # Client API ONLY (no federation listener)
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client]  # Only client API, no federation
        compress: false

  # Metrics endpoint
  - port: 9090
    type: metrics
    bind_addresses: ['0.0.0.0']

# ==================== DATABASE ====================

database:
  name: psycopg2
  args:
    user: synapse_li
    password: ${DB_PASSWORD}
    database: matrix_li
    host: matrix-postgresql-li-rw.matrix.svc.cluster.local
    port: 5432
    sslmode: require
    cp_min: 5
    cp_max: 20  # Lower than main (LI has fewer concurrent users)

# ==================== REDIS ====================

# Redis for caching only (no workers, so no replication needed)
# IMPORTANT: LI uses separate Redis instance (redis-li), NOT main Redis
redis:
  enabled: true
  host: redis-li.matrix.svc.cluster.local
  port: 6379
  password: ${REDIS_PASSWORD}

# ==================== MEDIA STORAGE ====================

# LI instance uses MAIN MinIO directly (same bucket as main Synapse)
# This provides real-time media access without sync lag
# WARNING: LI admins must NOT modify/delete media - changes affect main instance!
enable_media_repo: true
media_store_path: "/data/media_store"

media_storage_providers:
  - module: s3_storage_provider.S3StorageProviderBackend
    store_local: true
    store_remote: true
    store_synchronous: true
    config:
      bucket: synapse-media  # SHARED bucket - same as main instance
      endpoint_url: http://minio.matrix.svc.cluster.local:9000
      access_key_id: ${S3_ACCESS_KEY}
      secret_access_key: ${S3_SECRET_KEY}

max_upload_size: 100M
max_image_pixels: 32M

# ==================== LAWFUL INTERCEPT ====================

# CRITICAL: Infinite retention (synced from main)
redaction_retention_period: null
forgotten_room_retention_period: null

# NO recovery key module for LI instance
# Recovery keys are ONLY stored on main instance via key_vault
# LI cannot access key_vault (enforced by organization's network isolation per CLAUDE.md 7.4)

# ==================== FEDERATION ====================

# CRITICAL: NO federation for LI instance
# LI is isolated from the federation network
federation_domain_whitelist: []  # Empty list = no federation allowed
send_federation: false

# Disable federation receiver
federation_ip_range_blacklist:
  - '0.0.0.0/0'
  - '::/0'

# ==================== SECURITY & SECRETS ====================

macaroon_secret_key: "${MACAROON_SECRET}"
registration_shared_secret: "${REGISTRATION_SECRET}"
form_secret: "${FORM_SECRET}"
signing_key_path: "/config/signing.key"

# Trusted key servers (for federation key verification)
# NOTE: This setting is ONLY used when federation is enabled.
# LI has federation disabled, so matrix.org is never contacted.
# Safe to keep as-is for intranet deployments.
trusted_key_servers:
  - server_name: "matrix.org"

# ==================== REGISTRATION & USERS ====================

# CRITICAL: NO registration on LI instance
# Users are synced from main database via pg_dump/pg_restore
enable_registration: false
enable_registration_without_verification: false

# LI admin can reset user passwords for lawful intercept
# Password changes are overwritten on next sync
enable_set_displayname: false
enable_set_avatar_url: false
enable_3pid_changes: false
enable_password_reset: true  # Enable for LI admin to reset passwords

# User directory (read-only)
user_directory:
  enabled: true
  search_all_users: true

# ==================== RATE LIMITING ====================

# More permissive rate limits for LI investigators
rc_message:
  per_second: 1.0
  burst_count: 50

rc_login:
  address:
    per_second: 1.0
    burst_count: 10
  account:
    per_second: 1.0
    burst_count: 10

# ==================== PERFORMANCE ====================

event_cache_size: "20K"  # Smaller than main
caches:
  global_factor: 1.0  # Smaller cache for read-only workload

# ==================== FEATURES ====================

# Disable features not needed for LI
presence:
  enabled: false

# Enable room statistics (useful for forensics)
stats:
  enabled: true

# Disable push notifications (LI is read-only)
push:
  enabled: false

# Disable TURN/STUN (no real-time calls from LI)
turn_uris: []

# ==================== MONITORING ====================

enable_metrics: true
report_stats: false

# ==================== LOGGING ====================

log_config: "/config/log.yaml"

# ==================== READ-ONLY FEATURES ====================

# Allow viewing public rooms
allow_public_rooms_without_auth: true
allow_public_rooms_over_federation: false  # No federation

# Enable URL previews (for forensics)
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '169.254.0.0/16'
  - '::1/128'
  - 'fe80::/64'
  - 'fc00::/7'

# ==================== ADMIN API ====================

# Admin API enabled for Synapse Admin interface
# Access controlled by admin user permissions in database

# ==================== EXPERIMENTAL ====================

# Disable all experimental features (LI should be stable)
experimental_features: {}
