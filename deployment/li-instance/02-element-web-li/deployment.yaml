# Element Web LI (Lawful Intercept)
# Modified Matrix web client for law enforcement access
# Shows ALL messages including soft-deleted (redacted) content
#
# Key Features:
# - Displays redacted/deleted messages with strikethrough or special formatting
# - Read-only interface (no message sending from LI)
# - Connects to Synapse LI instance
#
# Access Control:
# Access is controlled via NETWORK ISOLATION, not IP whitelisting.
# The LI instance runs on a separate private network that only authorized
# LI administrators can access. The organization's network infrastructure
# team is responsible for controlling physical and network-level access
# to the LI network. This approach is:
# - More secure (defense at network layer, not application layer)
# - Simpler to maintain (no IP lists to update)
# - Standard for sensitive systems (law enforcement, forensics)

---
# ConfigMap for Element Web LI
apiVersion: v1
kind: ConfigMap
metadata:
  name: element-web-li-config
  namespace: matrix
  labels:
    app.kubernetes.io/name: element-web
    app.kubernetes.io/component: webclient
    matrix.instance: li
data:
  config.json: |
    {
        "default_server_config": {
            "m.homeserver": {
                "base_url": "https://matrix.example.com",
                "server_name": "matrix.example.com"
            }
        },
        "default_server_name": "matrix.example.com",
        "disable_custom_urls": true,
        "disable_guests": true,
        "disable_login_language_selector": false,
        "disable_3pid_login": false,
        "brand": "Element LI (Lawful Intercept)",
        "integrations_ui_url": null,
        "integrations_rest_url": null,
        "integrations_widgets_urls": [],
        "bug_report_endpoint_url": null,
        "default_country_code": "US",
        "show_labs_settings": false,
        "features": {},
        "default_theme": "light",
        "room_directory": {
            "servers": [
                "matrix.example.com"
            ]
        },
        "enable_presence_by_hs_url": {
            "https://matrix.example.com": false
        },
        "setting_defaults": {
            "breadcrumbs": true,
            "UIFeature.urlPreviews": true,
            "UIFeature.feedback": false,
            "UIFeature.voip": false,
            "UIFeature.widgets": false,
            "UIFeature.flair": false,
            "UIFeature.communities": false,
            "UIFeature.advancedSettings": true,
            "UIFeature.shareQrCode": false,
            "UIFeature.shareSocial": false,
            "MessageComposerInput.showStickersButton": false
        },
        "jitsi": null,
        "element_call": null,
        "permalink_prefix": "https://matrix.example.com"
    }

  # Custom CSS to show redacted messages (injected via nginx)
  custom.css: |
    /* Show redacted messages with strikethrough */
    .mx_EventTile_redacted {
        text-decoration: line-through !important;
        opacity: 0.7 !important;
        background-color: #fff3cd !important;
    }

    /* Add "DELETED" badge to redacted messages */
    .mx_EventTile_redacted::after {
        content: " [DELETED]";
        color: red;
        font-weight: bold;
        font-size: 0.8em;
    }

    /* Highlight message composer as read-only */
    .mx_MessageComposer {
        opacity: 0.5;
        pointer-events: none;
    }

    /* Add watermark */
    body::before {
        content: "LAWFUL INTERCEPT - RESTRICTED ACCESS";
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: #ff0000;
        color: white;
        padding: 5px 10px;
        font-weight: bold;
        font-size: 12px;
        z-index: 10000;
        border-radius: 3px;
    }

---
# Element Web LI Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: element-web-li
  namespace: matrix
  labels:
    app.kubernetes.io/name: element-web
    app.kubernetes.io/component: webclient
    app.kubernetes.io/version: "v1.11.96"
    matrix.instance: li
spec:
  # CLAUDE.md Section 3.4 & 7.1: LI does NOT require HA - single replica
  replicas: 1

  selector:
    matchLabels:
      app.kubernetes.io/name: element-web
      app.kubernetes.io/component: webclient
      matrix.instance: li

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app.kubernetes.io/name: element-web
        app.kubernetes.io/component: webclient
        app.kubernetes.io/version: "v1.11.96"
        matrix.instance: li  # CRITICAL label for NetworkPolicy (allow-from-nginx-li)

    spec:
      securityContext:
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      # CLAUDE.md Section 7.1: All LI services must run on one server
      # This ensures Element Web LI runs on the designated LI node
      nodeSelector:
        node-role.kubernetes.io/li: "true"

      # Tolerate LI node taints (if the node is dedicated to LI workloads)
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "li"
          effect: "NoSchedule"

      containers:
        - name: element-web
          image: vectorim/element-web:v1.11.96
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 80
              protocol: TCP

          volumeMounts:
            - name: config
              mountPath: /app/config.json
              subPath: config.json
              readOnly: true
            # Custom CSS must be loaded via modified index.html or nginx config
            # To use: Add <link rel="stylesheet" href="/custom.css"> to index.html
            # Or configure nginx to inject it
            - name: custom-css
              mountPath: /app/custom.css
              subPath: custom.css
              readOnly: true
            - name: cache
              mountPath: /var/cache/nginx
            - name: run
              mountPath: /var/run

          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"

          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 2

          startupProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 10

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 101
            runAsGroup: 101
            capabilities:
              drop:
                - ALL

      volumes:
        - name: config
          configMap:
            name: element-web-li-config
        - name: custom-css
          configMap:
            name: element-web-li-config
        - name: cache
          emptyDir: {}
        - name: run
          emptyDir: {}

---
# Element Web LI Service
apiVersion: v1
kind: Service
metadata:
  name: element-web-li
  namespace: matrix
  labels:
    app.kubernetes.io/name: element-web
    app.kubernetes.io/component: webclient
    matrix.instance: li
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: element-web
    app.kubernetes.io/component: webclient
    matrix.instance: li
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP

# Access: Via nginx-li reverse proxy at https://chat-li.example.com
# See: li-instance/06-nginx-li/deployment.yaml
