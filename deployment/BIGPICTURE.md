# The Big Picture: Your Complete Matrix/Synapse Deployment Journey

**This document provides the 10,000-foot view of your entire deployment journey from start to finish.**

---

## ğŸ“– Table of Contents

1. [What Are You Building?](#what-are-you-building)
2. [The Complete Journey (Step by Step)](#the-complete-journey)
3. [Architecture & Component Diagrams](#architecture--component-diagrams)
4. [Directory Structure Explained](#directory-structure-explained)
5. [Configuration Files Deep Dive](#configuration-files-deep-dive)
6. [The Data Flow](#the-data-flow)
7. [Why Each Component Exists](#why-each-component-exists)
8. [Final Topology Diagram](#final-topology-diagram)

---

## What Are You Building?

You're building a **production-grade Matrix homeserver** with these capabilities:

### ğŸ¯ Core Features
- **Secure messaging**: End-to-end encrypted chat
- **Federation**: Connect with other Matrix servers
- **Voice/Video calls**: Built-in calling with LiveKit
- **Push notifications**: Mobile app notifications via Sygnal
- **Media storage**: Images, videos, files via MinIO S3
- **Web interface**: Element Web client

### ğŸ”’ Enterprise Features
- **Lawful Intercept (LI)**: Separate read-only instance for compliance
- **Message retention**: Deleted messages preserved for legal requirements
- **Key recovery**: E2EE backup key storage
- **Audit trail**: Complete monitoring and logging

### ğŸ—ï¸ Infrastructure Features
- **High Availability**: Automatic failover for database, cache, storage
- **Scalable**: From 100 to 20,000+ concurrent users
- **Secure**: Zero-trust networking, TLS everywhere, antivirus scanning
- **Observable**: Prometheus metrics, Grafana dashboards, Loki logs

---

## The Complete Journey

Here's your path from zero to a running production Matrix homeserver:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR DEPLOYMENT JOURNEY                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“š PHASE 0: UNDERSTAND & PREPARE (1-2 hours)
   â”œâ”€ Read this document (BIGPICTURE.md)
   â”œâ”€ Understand what you're building
   â””â”€ Gather prerequisites (servers, domains, etc.)
        â†“
ğŸ”§ PHASE 1: SETUP FOUNDATION (2-4 hours)
   â”œâ”€ Setup management node (docs/00-WORKSTATION-SETUP.md)
   â”œâ”€ Deploy Kubernetes cluster (docs/00-KUBERNETES-INSTALLATION-DEBIAN-OVH.md)
   â””â”€ Determine resource requirements (docs/SCALING-GUIDE.md)
        â†“
âš™ï¸ PHASE 2: CONFIGURATION (1-2 hours)
   â”œâ”€ Generate secrets
   â”œâ”€ Update YAML files with secrets
   â”œâ”€ Configure domains
   â”œâ”€ Verify storage class
   â””â”€ Review all parameters
        â†“
ğŸš€ PHASE 3: INFRASTRUCTURE DEPLOYMENT (30-60 min)
   â”œâ”€ PostgreSQL (main + LI databases)
   â”œâ”€ Redis Sentinel (caching + workers)
   â”œâ”€ MinIO (S3-compatible object storage)
   â””â”€ Networking (ingress, TLS, network policies)
        â†“
ğŸ’¬ PHASE 4: MAIN INSTANCE DEPLOYMENT (30-60 min)
   â”œâ”€ Synapse main process
   â”œâ”€ Synapse workers (5 types for horizontal scaling)
   â”œâ”€ HAProxy (load balancer)
   â”œâ”€ Element Web (chat interface)
   â”œâ”€ coturn (NAT traversal for calls)
   â”œâ”€ Sygnal (push notifications)
   â”œâ”€ key_vault (E2EE recovery)
   â””â”€ LiveKit (optional video/voice)
        â†“
ğŸ” PHASE 5: LI INSTANCE DEPLOYMENT (20-40 min)
   â”œâ”€ Sync system (DB replication + media sync)
   â”œâ”€ Synapse LI (read-only instance)
   â”œâ”€ Element Web LI (shows deleted messages)
   â””â”€ Synapse Admin LI (forensics interface)
        â†“
ğŸ“Š PHASE 6: MONITORING DEPLOYMENT (20-30 min)
   â”œâ”€ Prometheus (metrics collection)
   â”œâ”€ Grafana (dashboards)
   â””â”€ Loki (log aggregation)
        â†“
ğŸ›¡ï¸ PHASE 7: ANTIVIRUS DEPLOYMENT (15-30 min)
   â”œâ”€ ClamAV (virus scanner)
   â””â”€ Content Scanner (media proxy with AV)
        â†“
âœ… PHASE 8: VERIFICATION & TESTING (30 min)
   â”œâ”€ Verify all pods running
   â”œâ”€ Create first user
   â”œâ”€ Test login via Element Web
   â”œâ”€ Test federation
   â””â”€ Check monitoring dashboards
        â†“
ğŸ‰ PRODUCTION READY!
```

---

## Architecture & Component Diagrams

### 1. **The Foundation Layer** (What you deploy in Phase 3)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INFRASTRUCTURE LAYER                            â”‚
â”‚                  (Foundation for Everything)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: PostgreSQL (CloudNativePG)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Main Cluster (HA)   â”‚          â”‚   LI Cluster         â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”â”‚          â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”      â”‚       â”‚
â”‚  â”‚  â”‚ P  â”‚â”€â”‚ R  â”‚â”€â”‚ R  â”‚â”‚          â”‚  â”‚ P  â”‚â”€â”‚ R  â”‚      â”‚       â”‚
â”‚  â”‚  â”‚RI  â”‚ â”‚ EP â”‚ â”‚ EP â”‚â”‚          â”‚  â”‚RI  â”‚ â”‚ EP â”‚      â”‚       â”‚
â”‚  â”‚  â”‚ MA â”‚ â”‚ LI â”‚ â”‚ LI â”‚â”‚          â”‚  â”‚ MA â”‚ â”‚ LI â”‚      â”‚       â”‚
â”‚  â”‚  â”‚ RY â”‚ â”‚ CA â”‚ â”‚ CA â”‚â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ RY â”‚ â”‚ CA â”‚      â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜â”‚Replicationâ”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚  â”‚  Auto-failover       â”‚          â”‚  Read-only           â”‚       â”‚
â”‚  â”‚  Sync replication    â”‚          â”‚  Streaming replica   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  Files: infrastructure/01-postgresql/                              â”‚
â”‚  Purpose: Store all messages, users, rooms, state                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CACHE & QUEUE: Redis Sentinel                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚        â”‚
â”‚  â”‚  â”‚ Redis  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Redis  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Redis  â”‚          â”‚        â”‚
â”‚  â”‚  â”‚ Master â”‚      â”‚ Replicaâ”‚      â”‚ Replicaâ”‚          â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚        â”‚
â”‚  â”‚      â”‚                                                 â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
â”‚  â”‚  â”‚  Sentinel (monitors + auto-failover)     â”‚        â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Files: infrastructure/02-redis/                                   â”‚
â”‚  Purpose: Cache hot data, worker communication, presence           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OBJECT STORAGE: MinIO (S3-compatible)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Distributed MinIO - EC:4 (Erasure Coding)            â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”             â”‚        â”‚
â”‚  â”‚  â”‚ Node â”‚  â”‚ Node â”‚  â”‚ Node â”‚  â”‚ Node â”‚             â”‚        â”‚
â”‚  â”‚  â”‚  1   â”‚  â”‚  2   â”‚  â”‚  3   â”‚  â”‚  4   â”‚             â”‚        â”‚
â”‚  â”‚  â”‚ 2 TB â”‚  â”‚ 2 TB â”‚  â”‚ 2 TB â”‚  â”‚ 2 TB â”‚             â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜             â”‚        â”‚
â”‚  â”‚  Total: 8 TB raw = 4 TB usable (50% efficiency)      â”‚        â”‚
â”‚  â”‚  Fault tolerance: Can lose ANY 4 drives              â”‚        â”‚
â”‚  â”‚  Buckets: synapse-media, synapse-media-li, backups   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Files: infrastructure/03-minio/                                   â”‚
â”‚  Purpose: Store uploaded media (images, videos, files)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NETWORKING: Ingress + TLS + Security                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  NGINX Ingress Controller                             â”‚        â”‚
â”‚  â”‚  â”œâ”€ Routes external traffic                           â”‚        â”‚
â”‚  â”‚  â”œâ”€ TLS termination                                   â”‚        â”‚
â”‚  â”‚  â””â”€ Load balancing                                    â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚  cert-manager                                          â”‚        â”‚
â”‚  â”‚  â”œâ”€ Automatic TLS certificate generation              â”‚        â”‚
â”‚  â”‚  â””â”€ Let's Encrypt integration                         â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚  NetworkPolicies (13 policies)                        â”‚        â”‚
â”‚  â”‚  â”œâ”€ default-deny-all (zero-trust)                     â”‚        â”‚
â”‚  â”‚  â”œâ”€ Allow DNS                                         â”‚        â”‚
â”‚  â”‚  â”œâ”€ PostgreSQL access control                         â”‚        â”‚
â”‚  â”‚  â”œâ”€ Redis access control                              â”‚        â”‚
â”‚  â”‚  â”œâ”€ MinIO access control                              â”‚        â”‚
â”‚  â”‚  â”œâ”€ key_vault isolation (CRITICAL for LI)             â”‚        â”‚
â”‚  â”‚  â””â”€ LI instance isolation                             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Files: infrastructure/04-networking/                              â”‚
â”‚  Purpose: Secure routing, TLS, zero-trust security                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What you do in this phase:**
- **Directory**: `infrastructure/`
- **Action**: Run kubectl apply commands to deploy databases, cache, storage, networking
- **Configuration**: Minimal - mostly just secrets (already configured in Phase 2)
- **Result**: You now have a secure, highly-available data platform ready for Synapse

---

### 2. **The Main Instance** (What you deploy in Phase 4)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MAIN INSTANCE                              â”‚
â”‚                   (Your Production Homeserver)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            INTERNET
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  NGINX Ingress       â”‚
                    â”‚  (TLS termination)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HAProxy                                  â”‚
â”‚              (Intelligent Request Router)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Routes by URL pattern:                                â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/client/*/sync      â†’ Sync Workers         â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/client/* (other)   â†’ Generic Workers      â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/federation/*       â†’ Generic Workers      â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/media/*            â†’ Generic Workers      â”‚     â”‚
â”‚  â”‚  â€¢ /_synapse/admin/*           â†’ Generic Workers      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  Files: main-instance/03-haproxy/                               â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚                    â”‚                  â”‚                  â”‚
   â–¼                    â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Synapse  â”‚    â”‚   Sync      â”‚   â”‚   Generic    â”‚   â”‚  Event   â”‚
â”‚  Main    â”‚    â”‚  Workers    â”‚   â”‚   Workers    â”‚   â”‚Persistersâ”‚
â”‚ Process  â”‚    â”‚  (2 pods)   â”‚   â”‚   (2 pods)   â”‚   â”‚ (2 pods) â”‚
â”‚          â”‚    â”‚             â”‚   â”‚              â”‚   â”‚          â”‚
â”‚ Handles: â”‚    â”‚ Handles:    â”‚   â”‚ Handles:     â”‚   â”‚ Handles: â”‚
â”‚â€¢ Config  â”‚    â”‚â€¢ /sync      â”‚   â”‚â€¢ Client APIs â”‚   â”‚â€¢ Writes  â”‚
â”‚  loading â”‚    â”‚  requests   â”‚   â”‚â€¢ Media       â”‚   â”‚  to DB   â”‚
â”‚â€¢ Backgroundâ”‚   â”‚â€¢ Real-time  â”‚   â”‚â€¢ Federation  â”‚   â”‚â€¢ Batchingâ”‚
â”‚  tasks   â”‚    â”‚  updates    â”‚   â”‚â€¢ Admin       â”‚   â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                  â”‚                 â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Redis Sentinel    â”‚
                     â”‚ (Worker Replication)â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   PostgreSQL       â”‚
                     â”‚   (Main Cluster)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Files: main-instance/01-synapse/ and main-instance/02-workers/
Purpose: Handle all Matrix protocol operations

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SUPPORTING SERVICES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Element Web                  â”‚  Web-based Matrix client           â”‚
â”‚  Files: main-instance/02-element-web/                              â”‚
â”‚  Purpose: User interface for chat, accessible via browser          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  coturn (TURN/STUN)           â”‚  NAT traversal for calls           â”‚
â”‚  Files: main-instance/06-coturn/                                   â”‚
â”‚  Purpose: Enable voice/video calls through firewalls               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Sygnal                       â”‚  Push notification gateway         â”‚
â”‚  Files: main-instance/07-sygnal/                                   â”‚
â”‚  Purpose: Send mobile push notifications (APNs/FCM)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  key_vault                    â”‚  E2EE backup key storage           â”‚
â”‚  Files: main-instance/08-key-vault/                                â”‚
â”‚  Purpose: Store encryption key backups for recovery                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LiveKit (optional)           â”‚  Advanced video/voice              â”‚
â”‚  Files: main-instance/04-livekit/                                  â”‚
â”‚  Purpose: High-quality group calls, screen sharing                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What you do in this phase:**
- **Directory**: `main-instance/`
- **Action**: Deploy Synapse main, workers, HAProxy, and all supporting services
- **Configuration**: Already done in Phase 2 (secrets, domains)
- **Result**: You have a fully functional Matrix homeserver accepting chat, calls, media

---

### 3. **The LI (Lawful Intercept) Instance** (What you deploy in Phase 5)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAWFUL INTERCEPT INSTANCE                       â”‚
â”‚              (Compliance & Legal Requirements)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SYNC SYSTEM                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Component 1: PostgreSQL Replication                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  Main DB       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   LI DB        â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  (Primary)     â”‚ Stream  â”‚  (Read-only    â”‚          â”‚  â”‚
â”‚  â”‚  â”‚                â”‚ WAL     â”‚   Replica)     â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚  â€¢ Streaming replication (< 1 second lag)               â”‚  â”‚
â”‚  â”‚  â€¢ Deleted messages PRESERVED in LI DB                  â”‚  â”‚
â”‚  â”‚  â€¢ redaction_retention_period: null (infinite)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Component 2: Media Replication (rclone)                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  Main MinIO    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   LI MinIO     â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  Bucket        â”‚ Sync    â”‚   Bucket       â”‚          â”‚  â”‚
â”‚  â”‚  â”‚                â”‚ Every   â”‚                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚                â”‚ 1 hour  â”‚                â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚  â€¢ Deleted media files PRESERVED in LI bucket           â”‚  â”‚
â”‚  â”‚  â€¢ Full media history maintained                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: li-instance/04-sync-system/                            â”‚
â”‚  Purpose: Ensure LI instance has ALL data including deleted    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SYNAPSE LI INSTANCE                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Read-only Synapse instance                           â”‚  â”‚
â”‚  â”‚  â€¢ Points to LI database (replica)                      â”‚  â”‚
â”‚  â”‚  â€¢ Points to LI MinIO bucket                            â”‚  â”‚
â”‚  â”‚  â€¢ Cannot accept writes                                 â”‚  â”‚
â”‚  â”‚  â€¢ Shows ALL messages (including "deleted" ones)        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: li-instance/01-synapse-li/                             â”‚
â”‚  Purpose: Forensics access to complete message history         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   USER INTERFACES FOR LI                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Element Web LI                                          â”‚  â”‚
â”‚  â”‚  â€¢ Connects to Synapse LI                                â”‚  â”‚
â”‚  â”‚  â€¢ Shows deleted messages in UI                          â”‚  â”‚
â”‚  â”‚  â€¢ Read-only interface                                   â”‚  â”‚
â”‚  â”‚  Files: li-instance/02-element-web-li/                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Synapse Admin LI                                        â”‚  â”‚
â”‚  â”‚  â€¢ Admin interface for forensics                         â”‚  â”‚
â”‚  â”‚  â€¢ User search, room inspection                          â”‚  â”‚
â”‚  â”‚  â€¢ Full audit trail access                               â”‚  â”‚
â”‚  â”‚  Files: li-instance/03-synapse-admin-li/                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRITICAL SECURITY                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NetworkPolicy: key-vault-isolation                      â”‚  â”‚
â”‚  â”‚  â€¢ ONLY Synapse main can access key_vault                â”‚  â”‚
â”‚  â”‚  â€¢ LI instance CANNOT access encryption keys             â”‚  â”‚
â”‚  â”‚  â€¢ Prevents LI from decrypting E2EE messages             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NetworkPolicy: li-instance-isolation                    â”‚  â”‚
â”‚  â”‚  â€¢ LI instance CANNOT access main PostgreSQL             â”‚  â”‚
â”‚  â”‚  â€¢ LI instance CANNOT access main MinIO                  â”‚  â”‚
â”‚  â”‚  â€¢ Complete data separation                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: infrastructure/04-networking/networkpolicies.yaml      â”‚
â”‚  Purpose: Ensure LI cannot interfere with production           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What you do in this phase:**
- **Directory**: `li-instance/`
- **Action**: Deploy sync system, then Synapse LI, Element Web LI, Admin LI
- **Configuration**: Already done in Phase 2
- **Result**: You have a compliance-ready forensics system with complete message history

**Why this exists**: 
- Legal requirement for enterprise deployments
- Preserves deleted messages for law enforcement requests
- Cannot access E2EE keys (privacy preserved for encrypted rooms)
- Completely isolated from main production instance

---

### 4. **Monitoring Stack** (What you deploy in Phase 6)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONITORING STACK                              â”‚
â”‚                 (Observability & Alerting)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROMETHEUS (Metrics Collection)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Scrapes metrics from:                                   â”‚  â”‚
â”‚  â”‚  â€¢ Synapse (/_synapse/metrics)                           â”‚  â”‚
â”‚  â”‚  â€¢ PostgreSQL (CloudNativePG exporter)                   â”‚  â”‚
â”‚  â”‚  â€¢ Redis (redis-exporter)                                â”‚  â”‚
â”‚  â”‚  â€¢ MinIO (built-in metrics)                              â”‚  â”‚
â”‚  â”‚  â€¢ HAProxy (stats endpoint)                              â”‚  â”‚
â”‚  â”‚  â€¢ Kubernetes (node metrics, pod metrics)                â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Stores: 30 days of metrics history                      â”‚  â”‚
â”‚  â”‚  Alerts: PrometheusRules for critical conditions         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: monitoring/01-prometheus/                              â”‚
â”‚  Purpose: Collect and store time-series metrics                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GRAFANA (Visualization)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Dashboards:                                             â”‚  â”‚
â”‚  â”‚  â€¢ Synapse Overview (messages, users, rooms)             â”‚  â”‚
â”‚  â”‚  â€¢ Worker Performance (per-worker metrics)               â”‚  â”‚
â”‚  â”‚  â€¢ PostgreSQL Health (connections, replication lag)      â”‚  â”‚
â”‚  â”‚  â€¢ Redis Performance (cache hit rate, memory)            â”‚  â”‚
â”‚  â”‚  â€¢ MinIO Storage (usage, throughput)                     â”‚  â”‚
â”‚  â”‚  â€¢ LI Instance Status (replication lag, sync status)     â”‚  â”‚
â”‚  â”‚  â€¢ Federation (outbound/inbound federation health)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: monitoring/02-grafana/                                 â”‚
â”‚  Purpose: Visual dashboards for system health                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOKI (Log Aggregation)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Collects logs from:                                     â”‚  â”‚
â”‚  â”‚  â€¢ All Synapse pods (main + workers)                     â”‚  â”‚
â”‚  â”‚  â€¢ PostgreSQL pods                                       â”‚  â”‚
â”‚  â”‚  â€¢ All infrastructure components                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Retention: 30 days                                      â”‚  â”‚
â”‚  â”‚  Searchable via Grafana Explore                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: monitoring/03-loki/                                    â”‚
â”‚  Purpose: Centralized log search and analysis                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  You access via: â”‚
                    â”‚  Grafana UI      â”‚
                    â”‚  Port 3000       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What you do in this phase:**
- **Directory**: `monitoring/`
- **Action**: Install Prometheus/Grafana via Helm, deploy ServiceMonitors and dashboards
- **Configuration**: Minimal (already in values/ directory)
- **Result**: You have complete visibility into system health and performance

---

### 5. **Antivirus Protection** (What you deploy in Phase 7)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ANTIVIRUS SYSTEM                              â”‚
â”‚               (Malware Protection for Media)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLIENT UPLOADS MEDIA
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NGINX Ingress                                 â”‚
â”‚            Routes /_matrix/media/* to Content Scanner            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CONTENT SCANNER (Proxy + Scanner)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Receive media upload/download request               â”‚  â”‚
â”‚  â”‚  2. Check cache: Was this file already scanned?         â”‚  â”‚
â”‚  â”‚     â”œâ”€ Yes, Clean â†’ Serve immediately                   â”‚  â”‚
â”‚  â”‚     â”œâ”€ Yes, Infected â†’ Return HTTP 403                  â”‚  â”‚
â”‚  â”‚     â””â”€ No â†’ Continue to step 3                          â”‚  â”‚
â”‚  â”‚  3. Forward request to Synapse                          â”‚  â”‚
â”‚  â”‚  4. Scan file with ClamAV                               â”‚  â”‚
â”‚  â”‚  5. If clean: Serve + cache result                      â”‚  â”‚
â”‚  â”‚     If infected: Return HTTP 403 + cache result         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Replicas: 3 (horizontal scaling)                              â”‚
â”‚  Files: antivirus/02-scan-workers/                             â”‚
â”‚  Purpose: Intercept all media requests for scanning            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ClamAV DaemonSet                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ ClamAV daemon (clamd) - Virus scanning engine        â”‚  â”‚
â”‚  â”‚  â€¢ FreshClam - Auto-update virus definitions (hourly)   â”‚  â”‚
â”‚  â”‚  â€¢ 8M+ virus signatures                                 â”‚  â”‚
â”‚  â”‚  â€¢ Scans: executables, archives, PDFs, Office docs      â”‚  â”‚
â”‚  â”‚  â€¢ Deployed on EVERY application node (DaemonSet)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: antivirus/01-clamav/                                   â”‚
â”‚  Purpose: Actual virus scanning engine                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What you do in this phase:**
- **Directory**: `antivirus/`
- **Action**: Deploy ClamAV DaemonSet, then Content Scanner
- **Configuration**: Minimal (default settings work)
- **Result**: All uploaded media is automatically scanned for malware

**Why this exists**:
- Protect users from malware in uploaded files
- Prevent server from becoming malware distribution point
- Compliance requirement for many organizations

---

## Directory Structure Explained

Here's what each directory contains and WHY it exists:

```
deployment/
â”œâ”€â”€ README.md                    â† YOUR STARTING POINT
â”‚   Purpose: Complete deployment guide with all steps
â”‚   When: Read AFTER 00-WORKSTATION-SETUP and 00-KUBERNETES-INSTALLATION
â”‚
â”œâ”€â”€ BIGPICTURE.md               â† YOU ARE HERE
â”‚   Purpose: Understand the entire journey
â”‚   When: Read FIRST to get oriented
â”‚
â”œâ”€â”€ namespace.yaml              â† Creates "matrix" namespace
â”‚   Purpose: Kubernetes namespace where everything deploys
â”‚   When: Auto-applied by scripts, or manual first step
â”‚
â”œâ”€â”€ infrastructure/             â† PHASE 3: Foundation
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-postgresql/         
â”‚   â”‚   â”œâ”€â”€ main-cluster.yaml       â†’ Main database (3 replicas, HA)
â”‚   â”‚   â””â”€â”€ li-cluster.yaml         â†’ LI database (2 replicas, read-only)
â”‚   â”‚   Purpose: Store messages, users, rooms, events
â”‚   â”‚   Configuration: Secrets (already done), storage class
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-redis/
â”‚   â”‚   â””â”€â”€ redis-statefulset.yaml  â†’ Redis + Sentinel (3 pods, HA)
â”‚   â”‚   Purpose: Cache hot data, worker communication
â”‚   â”‚   Configuration: Password (already in secrets)
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-minio/
â”‚   â”‚   â”œâ”€â”€ tenant.yaml             â†’ MinIO cluster (4 nodes, EC:4)
â”‚   â”‚   â””â”€â”€ secrets.yaml            â†’ MinIO credentials
â”‚   â”‚   Purpose: S3-compatible object storage for media
â”‚   â”‚   Configuration: Access keys (you update secrets.yaml)
â”‚   â”‚
â”‚   â””â”€â”€ 04-networking/
â”‚       â”œâ”€â”€ networkpolicies.yaml    â†’ 13 security policies
â”‚       â”œâ”€â”€ cert-manager-install.yaml â†’ TLS certificates
â”‚       â””â”€â”€ sync-system-networkpolicy.yaml â†’ LI sync isolation
â”‚       Purpose: Ingress routing, TLS, zero-trust security
â”‚       Configuration: Domains (via Helm values)
â”‚
â”œâ”€â”€ main-instance/              â† PHASE 4: Your Homeserver
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-synapse/
â”‚   â”‚   â”œâ”€â”€ configmap.yaml          â†’ homeserver.yaml + log.yaml
â”‚   â”‚   â”œâ”€â”€ secrets.yaml            â†’ 12 Synapse secrets
â”‚   â”‚   â”œâ”€â”€ main-statefulset.yaml   â†’ Synapse main process (1 pod)
â”‚   â”‚   â”œâ”€â”€ services.yaml           â†’ Kubernetes services
â”‚   â”‚   â””â”€â”€ README.md               â†’ Technical architecture details
â”‚   â”‚   Purpose: Core Matrix homeserver process
â”‚   â”‚   Configuration: Secrets, domains (in configmap.yaml)
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-element-web/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Element Web UI (2 replicas)
â”‚   â”‚   Purpose: Web-based chat interface
â”‚   â”‚   Configuration: Domain, homeserver URL
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-workers/
â”‚   â”‚   â”œâ”€â”€ synchrotron-deployment.yaml    â†’ /sync workers (2 pods)
â”‚   â”‚   â”œâ”€â”€ generic-worker-deployment.yaml â†’ General APIs (2 pods)
â”‚   â”‚   â”œâ”€â”€ media-repository-deployment.yaml â†’ (future expansion)
â”‚   â”‚   â”œâ”€â”€ event-persister-deployment.yaml â†’ DB writes (2 pods)
â”‚   â”‚   â””â”€â”€ federation-sender-deployment.yaml â†’ Outbound federation (2 pods)
â”‚   â”‚   Purpose: Horizontal scaling for Matrix APIs
â”‚   â”‚   Configuration: Inherits from main configmap
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-haproxy/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ HAProxy (2 replicas) + config
â”‚   â”‚   Purpose: Intelligent routing to workers
â”‚   â”‚   Configuration: Embedded in deployment.yaml
â”‚   â”‚
â”‚   â”œâ”€â”€ 04-livekit/
â”‚   â”‚   â””â”€â”€ README.md               â†’ Helm reference only
â”‚   â”‚   Purpose: Optional high-quality video/voice calls
â”‚   â”‚   Configuration: values/livekit-values.yaml
â”‚   â”‚
â”‚   â”œâ”€â”€ 06-coturn/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ coturn (2 replicas)
â”‚   â”‚   Purpose: NAT traversal for voice/video calls
â”‚   â”‚   Configuration: Shared secret, domains
â”‚   â”‚
â”‚   â”œâ”€â”€ 07-sygnal/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Sygnal (1 replica)
â”‚   â”‚   Purpose: Push notifications to mobile apps
â”‚   â”‚   Configuration: APNs/FCM credentials (8 secrets)
â”‚   â”‚
â”‚   â””â”€â”€ 08-key-vault/
â”‚       â””â”€â”€ deployment.yaml         â†’ Django app (1 replica)
â”‚       Purpose: E2EE backup key storage
â”‚       Configuration: API key, Django secret, encryption key
â”‚
â”œâ”€â”€ li-instance/                â† PHASE 5: Compliance
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-synapse-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Read-only Synapse (1 pod)
â”‚   â”‚   Purpose: Forensics access to deleted messages
â”‚   â”‚   Configuration: Points to LI database/MinIO
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-element-web-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Element Web for LI (1 pod)
â”‚   â”‚   Purpose: UI showing deleted messages
â”‚   â”‚   Configuration: Domain, LI homeserver URL
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-synapse-admin-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Admin interface (1 pod)
â”‚   â”‚   Purpose: Forensics and user management
â”‚   â”‚   Configuration: LI homeserver URL
â”‚   â”‚
â”‚   â”œâ”€â”€ 04-sync-system/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Replication + sync (1 pod + job)
â”‚   â”‚   Purpose: Keep LI database and media in sync
â”‚   â”‚   Configuration: DB credentials, MinIO credentials
â”‚   â”‚
â”‚   â””â”€â”€ README.md               â†’ Complete LI architecture guide
â”‚       Purpose: Deep dive into LI design and compliance
â”‚
â”œâ”€â”€ monitoring/                 â† PHASE 6: Observability
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-prometheus/
â”‚   â”‚   â”œâ”€â”€ servicemonitors.yaml    â†’ Auto-discover metrics endpoints
â”‚   â”‚   â””â”€â”€ prometheusrules.yaml    â†’ Alert rules
â”‚   â”‚   Purpose: Metrics collection and alerting
â”‚   â”‚   Configuration: Via Helm (values/prometheus-stack-values.yaml)
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-grafana/
â”‚   â”‚   â””â”€â”€ dashboards-configmap.yaml â†’ Pre-built dashboards
â”‚   â”‚   Purpose: Visualization and dashboards
â”‚   â”‚   Configuration: Via Helm values
â”‚   â”‚
â”‚   â””â”€â”€ 03-loki/
â”‚       â””â”€â”€ README.md               â†’ Helm reference
â”‚       Purpose: Log aggregation
â”‚       Configuration: values/loki-values.yaml
â”‚
â”œâ”€â”€ antivirus/                  â† PHASE 7: Security
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-clamav/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ ClamAV DaemonSet
â”‚   â”‚   Purpose: Virus scanning engine on every node
â”‚   â”‚   Configuration: Auto-updates enabled
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-scan-workers/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Content Scanner (3 replicas)
â”‚   â”‚   Purpose: Media proxy with AV scanning
â”‚   â”‚   Configuration: ClamAV endpoint
â”‚   â”‚
â”‚   â””â”€â”€ README.md               â†’ Antivirus architecture
â”‚       Purpose: Understand AV integration
â”‚
â”œâ”€â”€ values/                     â† Helm Chart Values
â”‚   â”‚   All files here: Configuration for Helm-installed components
â”‚   â”‚
â”‚   â”œâ”€â”€ prometheus-stack-values.yaml â†’ Prometheus + Grafana config
â”‚   â”œâ”€â”€ loki-values.yaml             â†’ Loki config
â”‚   â”œâ”€â”€ cloudnativepg-values.yaml    â†’ PostgreSQL operator
â”‚   â”œâ”€â”€ minio-operator-values.yaml   â†’ MinIO operator
â”‚   â”œâ”€â”€ metallb-values.yaml          â†’ Load balancer IPs
â”‚   â”œâ”€â”€ nginx-ingress-values.yaml    â†’ Ingress controller
â”‚   â”œâ”€â”€ cert-manager-values.yaml     â†’ TLS certificate manager
â”‚   â”œâ”€â”€ redis-synapse-values.yaml    â†’ Redis for Synapse
â”‚   â”œâ”€â”€ redis-livekit-values.yaml    â†’ Redis for LiveKit
â”‚   â””â”€â”€ livekit-values.yaml          â†’ LiveKit media server
â”‚
â”œâ”€â”€ scripts/                    â† Automation Scripts
â”‚   â”œâ”€â”€ deploy-all.sh           â†’ Deploy all 5 phases automatically
â”‚   â”œâ”€â”€ validate-deployment.sh  â†’ Verify everything is healthy
â”‚   â””â”€â”€ README.md               â†’ Script documentation
â”‚
â””â”€â”€ docs/                       â† Reference Documentation
    â”‚
    â”œâ”€â”€ 00-WORKSTATION-SETUP.md        â†’ REQUIRED: Setup kubectl, helm
    â”œâ”€â”€ 00-KUBERNETES-INSTALLATION-DEBIAN-OVH.md â†’ REQUIRED: K8s cluster
    â”œâ”€â”€ SCALING-GUIDE.md               â†’ REQUIRED: Determine resources
    â”‚
    â”œâ”€â”€ CONFIGURATION-REFERENCE.md     â†’ Optional: All parameters explained
    â”œâ”€â”€ OPERATIONS-UPDATE-GUIDE.md     â†’ Optional: Updates and maintenance
    â”œâ”€â”€ SECRETS-MANAGEMENT.md          â†’ Optional: Advanced secrets (Vault)
    â”œâ”€â”€ HAPROXY-ARCHITECTURE.md        â†’ Optional: HAProxy routing details
    â””â”€â”€ MATRIX-AUTHENTICATION-SERVICE.md â†’ Optional: Enterprise SSO
```

---

## Configuration Files Deep Dive

### What Files You Actually Edit

During **Phase 2: Configuration**, you edit these files:

#### 1. **Secret Files** (Replace CHANGEME values)

| File | Secrets | Purpose |
|------|---------|---------|
| `main-instance/01-synapse/secrets.yaml` | 12 secrets | Synapse main passwords/keys |
| `li-instance/01-synapse-li/deployment.yaml` | 7 secrets | LI instance credentials |
| `main-instance/08-key-vault/deployment.yaml` | 4 secrets | Key vault API, Django, encryption |
| `main-instance/06-coturn/deployment.yaml` | 2 secrets | TURN shared secret |
| `main-instance/07-sygnal/deployment.yaml` | 8 secrets | APNs/FCM push credentials |
| `infrastructure/03-minio/secrets.yaml` | 2 secrets | MinIO root credentials |
| `li-instance/04-sync-system/deployment.yaml` | 5 secrets | Replication credentials |

**Total: 40 secrets to generate and update**

**How to update**:
1. Generate secret: `openssl rand -base64 32`
2. Find `CHANGEME_*` in file
3. Replace with generated value
4. Save file

#### 2. **Domain Files** (Replace example.com)

| File | What to Change |
|------|----------------|
| `main-instance/01-synapse/configmap.yaml` | `server_name`, `public_baseurl` |
| `main-instance/02-element-web/deployment.yaml` | `default_server_config.m.homeserver.base_url` |
| `li-instance/01-synapse-li/deployment.yaml` | `server_name`, `public_baseurl` |
| `li-instance/02-element-web-li/deployment.yaml` | homeserver URL |
| `main-instance/06-coturn/deployment.yaml` | realm |
| `infrastructure/04-networking/cert-manager-install.yaml` | certificate domains |
| All Ingress manifests | `spec.rules[].host` |

**Total: ~85 occurrences of example.com**

**How to update**:
Use find-and-replace:
```bash
find deployment/ -name "*.yaml" -exec sed -i 's/matrix\.example\.com/your-domain.com/g' {} +
```

#### 3. **Storage Class** (If not using "standard")

| File | Line | What to Change |
|------|------|----------------|
| `infrastructure/01-postgresql/main-cluster.yaml` | 33 | `storageClassName` |
| `infrastructure/01-postgresql/li-cluster.yaml` | 32 | `storageClassName` |
| `infrastructure/02-redis/redis-statefulset.yaml` | 312 | `storageClassName` |
| `main-instance/01-synapse/main-statefulset.yaml` | 35 | `storageClassName` |

#### 4. **Synapse Signing Key** (Generate once)

Generate:
```bash
docker run --rm matrixdotorg/synapse:latest generate_signing_key
```

Update:
- `main-instance/01-synapse/secrets.yaml` â†’ `signing.key`
- `li-instance/01-synapse-li/deployment.yaml` â†’ `SYNAPSE_SIGNING_KEY`

---

## The Data Flow

### How a Message Flows Through Your System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MESSAGE SEND FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER SENDS MESSAGE
   â””â”€ Element Web UI (browser)
        â”‚
        â–¼
2. HTTPS REQUEST
   â””â”€ POST /_matrix/client/r0/rooms/{roomId}/send/m.room.message
        â”‚
        â–¼
3. NGINX INGRESS
   â””â”€ TLS termination, forward to HAProxy
        â”‚
        â–¼
4. HAPROXY
   â””â”€ Check URL pattern
      â””â”€ /_matrix/client/* (not /sync) â†’ Generic Worker
        â”‚
        â–¼
5. GENERIC WORKER
   â””â”€ Validate request
   â””â”€ Check permissions (Redis cache first)
   â””â”€ Send event to Event Persister via Redis
        â”‚
        â–¼
6. EVENT PERSISTER WORKER
   â””â”€ Batch multiple events
   â””â”€ Write to PostgreSQL (main cluster)
        â”‚
        â–¼
7. POSTGRESQL MAIN
   â””â”€ Store event in events table
   â””â”€ Stream WAL to LI replica (immediately)
        â”‚
        â–¼
8. POSTGRESQL LI REPLICA
   â””â”€ Receive WAL stream (< 1 second lag)
   â””â”€ Apply to LI database
   â””â”€ Event now visible in LI instance
        â”‚
        â–¼
9. GENERIC WORKER
   â””â”€ Get event ID from Event Persister
   â””â”€ Return success to client
   â””â”€ Notify other clients via /sync endpoint
        â”‚
        â–¼
10. SYNC WORKERS
    â””â”€ Connected clients receive message update
    â””â”€ Element Web displays message

PARALLEL: If message has media attachment
    â””â”€ Media upload â†’ Content Scanner â†’ ClamAV scan â†’ MinIO storage
    â””â”€ MinIO replication (rclone) â†’ LI MinIO bucket (hourly)
```

### How a Voice Call Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VOICE/VIDEO CALL FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER INITIATES CALL
   â””â”€ Element Web requests TURN credentials
        â”‚
        â–¼
2. SYNAPSE MAIN
   â””â”€ Generate TURN credentials using shared secret
   â””â”€ Return credentials to client
        â”‚
        â–¼
3. CLIENTS ESTABLISH PEER CONNECTION
   â””â”€ Try direct connection (STUN)
   â””â”€ If NAT prevents direct: Use TURN relay
        â”‚
        â–¼
4. COTURN (TURN Server)
   â””â”€ Relay media packets between clients
   â””â”€ Authenticate using credentials from step 2
        â”‚
        â–¼
5. MEDIA STREAMING
   â””â”€ WebRTC peer-to-peer (or via TURN)
   â””â”€ Audio/video flows between clients
        â”‚
        â–¼
6. CALL EVENTS
   â””â”€ Call start/end sent as Matrix events
   â””â”€ Follows normal message flow (above)

OPTIONAL: If LiveKit enabled
   â””â”€ Group calls use LiveKit SFU
   â””â”€ Better performance for >2 participants
   â””â”€ Screen sharing support
```

---

## Why Each Component Exists

### Infrastructure Layer

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **PostgreSQL Main** | Store all messages, users, rooms | Nothing works - Synapse won't start |
| **PostgreSQL LI** | Compliance - preserve deleted data | LI instance won't work, compliance failure |
| **Redis Sentinel** | Cache hot data, worker communication | Slow performance, workers can't coordinate |
| **MinIO** | Store uploaded media (images/videos) | Can't upload files, media won't work |
| **NetworkPolicies** | Zero-trust security | Cluster-wide access, security risk |
| **NGINX Ingress** | TLS termination, external access | Can't access from internet |
| **cert-manager** | Automatic TLS certificates | Manual cert management, HTTPS breaks |

### Main Instance

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **Synapse Main** | Core process, config loading | Nothing works |
| **Sync Workers** | Handle /sync (long-polling) | Slow real-time updates, main process overloaded |
| **Generic Workers** | Handle client APIs | Main process overloaded, poor performance |
| **Event Persisters** | Batch DB writes | Slow message sending, DB contention |
| **Federation Senders** | Outbound federation | Can't send to other servers |
| **HAProxy** | Route requests to correct workers | Can't use workers, main process does everything |
| **Element Web** | User interface | Can use other clients, but no web UI |
| **coturn** | NAT traversal for calls | Calls won't work through firewalls |
| **Sygnal** | Mobile push notifications | Mobile apps won't get notifications |
| **key_vault** | E2EE key backup | Users lose keys if they lose device |

### LI Instance

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **Sync System** | Replicate data to LI | LI instance has no data |
| **Synapse LI** | Read-only access to all data | Can't access deleted messages |
| **Element Web LI** | UI for forensics | Can't view LI data easily |
| **Synapse Admin LI** | Admin/forensics tools | Limited search capabilities |
| **NetworkPolicy Isolation** | Prevent LI from affecting production | LI could disrupt main instance |

### Monitoring

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **Prometheus** | Metrics collection | No visibility into system health |
| **Grafana** | Dashboards | Can't visualize metrics |
| **Loki** | Log aggregation | Can't search logs across pods |

### Antivirus

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **ClamAV** | Virus scanning | Malware can be uploaded |
| **Content Scanner** | Intercept media requests | Media goes directly to storage unscanned |

---

## Final Topology Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              THE COMPLETE SYSTEM                                       â”‚
â”‚                         (All Components Connected)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    INTERNET
                                       â”‚
                                       â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                             â”‚
                  [Federation]                   [End Users]
                 (Other Matrix                 (Browsers,
                   Servers)                    Mobile Apps)
                        â”‚                             â”‚
                        â”‚                             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   NGINX Ingress Controller   â”‚
                        â”‚   (TLS Termination)          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                      â”‚                      â”‚
                â–¼                      â–¼                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Element Web  â”‚      â”‚   HAProxy    â”‚      â”‚Content Scannerâ”‚
        â”‚   (Main)     â”‚      â”‚ (Routing)    â”‚      â”‚   + ClamAV   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                    â”‚
                â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           SYNAPSE MAIN INSTANCE                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Synapse  â”‚  â”‚     Synapse Workers        â”‚ â”‚
    â”‚  â”‚   Main   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚
    â”‚  â”‚ Process  â”‚  â”‚  â”‚Sync â”‚  â”‚Genericâ”‚ â”‚Eventâ”‚ â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚Work â”‚  â”‚Worker â”‚ â”‚Pers â”‚ â”‚ â”‚
    â”‚       â”‚        â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚                                        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                â”‚                â”‚
            â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PostgreSQL  â”‚ â”‚    Redis     â”‚ â”‚    MinIO     â”‚
    â”‚     Main     â”‚ â”‚   Sentinel   â”‚ â”‚ (S3 Storage) â”‚
    â”‚  (3 nodes)   â”‚ â”‚  (3 nodes)   â”‚ â”‚  (4 nodes)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                  â”‚
           â”‚ WAL Streaming                   â”‚ rclone sync
           â”‚                                  â”‚
           â–¼                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PostgreSQL   â”‚                  â”‚   MinIO      â”‚
    â”‚     LI       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   Bucket LI  â”‚
    â”‚  (2 nodes)   â”‚  Sync System     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  Replication
           â”‚
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            LI INSTANCE (Forensics)             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Synapse  â”‚  â”‚ Element  â”‚  â”‚   Synapse    â”‚ â”‚
    â”‚  â”‚    LI    â”‚  â”‚  Web LI  â”‚  â”‚   Admin LI   â”‚ â”‚
    â”‚  â”‚(Read-Onlyâ”‚  â”‚(Shows    â”‚  â”‚  (Forensics) â”‚ â”‚
    â”‚  â”‚ Instance)â”‚  â”‚Deleted)  â”‚  â”‚              â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         MONITORING STACK (Separate NS)         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚Prometheusâ”‚  â”‚ Grafana  â”‚  â”‚     Loki     â”‚ â”‚
    â”‚  â”‚ (Metrics)â”‚â”€â–ºâ”‚(Dashboardâ”‚  â”‚    (Logs)    â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚       â”‚                               â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                               â”‚
            â”‚ Scrapes metrics               â”‚ Collects logs
            â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      ALL COMPONENTS (metrics + logs)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          SUPPORTING SERVICES                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ coturn   â”‚  â”‚ Sygnal   â”‚  â”‚  key_vault   â”‚ â”‚
    â”‚  â”‚ (TURN)   â”‚  â”‚  (Push)  â”‚  â”‚  (E2EE Keys) â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NETWORK SECURITY LAYER                      â”‚
â”‚  (NetworkPolicies - Zero-Trust Security)                       â”‚
â”‚                                                                â”‚
â”‚  Rules:                                                        â”‚
â”‚  â€¢ Default deny all traffic                                   â”‚
â”‚  â€¢ Synapse main â†’ PostgreSQL main, Redis, MinIO âœ“             â”‚
â”‚  â€¢ Synapse LI â†’ PostgreSQL LI, MinIO LI âœ“                     â”‚
â”‚  â€¢ Synapse LI â†’ PostgreSQL main âœ— (BLOCKED)                   â”‚
â”‚  â€¢ Synapse LI â†’ key_vault âœ— (BLOCKED - CRITICAL!)             â”‚
â”‚  â€¢ Workers â†’ Redis âœ“                                          â”‚
â”‚  â€¢ All â†’ DNS âœ“                                                â”‚
â”‚  â€¢ Ingress â†’ HAProxy, Element Web âœ“                           â”‚
â”‚  â€¢ Prometheus â†’ All (scrape metrics) âœ“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SECURITY HIGHLIGHTS:
ğŸ”’ LI instance CANNOT access encryption keys (key_vault isolated)
ğŸ”’ LI instance CANNOT access main database (read-only replica only)
ğŸ”’ All traffic TLS encrypted (cert-manager + Let's Encrypt)
ğŸ”’ All media scanned for malware (ClamAV)
ğŸ”’ Zero-trust networking (default deny, explicit allows)
```

---

## Your Actual Steps (Practical Walkthrough)

### Week 1: Preparation & Setup

**Day 1: Understand (2 hours)**
1. Read this document (BIGPICTURE.md)
2. Read README.md overview
3. Understand what you're building

**Day 2: Management Node (2-4 hours)**
1. Choose a machine for management (server/VM/laptop)
2. Follow `docs/00-WORKSTATION-SETUP.md`
3. Install kubectl, helm, git
4. Test: `kubectl version` works

**Day 3: Kubernetes Cluster (4-8 hours)**
1. Get access to your servers (SSH keys)
2. Follow `docs/00-KUBERNETES-INSTALLATION-DEBIAN-OVH.md`
3. Deploy Kubernetes cluster
4. Test: `kubectl get nodes` shows all nodes

**Day 4: Determine Resources (1 hour)**
1. Read `docs/SCALING-GUIDE.md`
2. Decide your scale (100 CCU? 1K CCU? 5K CCU?)
3. Adjust YAML files if > 100 CCU (optional)

**Day 5: Configuration (2-4 hours)**
1. Clone this repository to management node
2. Generate 40+ secrets (README Configuration section)
3. Update all secrets.yaml files
4. Update all domains (find-replace example.com)
5. Verify storage class exists
6. Generate Synapse signing key
7. Review README Configuration checklist

### Week 2: Deployment

**Day 6: Infrastructure (1 hour)**
```bash
# PostgreSQL
kubectl apply -f infrastructure/01-postgresql/main-cluster.yaml
kubectl apply -f infrastructure/01-postgresql/li-cluster.yaml
# Wait for ready...

# Redis
kubectl apply -f infrastructure/02-redis/redis-statefulset.yaml
# Wait for ready...

# MinIO (install operator first via Helm)
helm repo add minio-operator https://operator.min.io
helm install minio-operator minio-operator/operator --namespace minio-operator --create-namespace
kubectl apply -f infrastructure/03-minio/tenant.yaml
# Wait for ready...

# Networking
kubectl apply -f infrastructure/04-networking/networkpolicies.yaml
# Install Ingress + cert-manager via Helm...
```

**Day 7: Main Instance (1-2 hours)**
```bash
# Synapse
kubectl apply -f main-instance/01-synapse/configmap.yaml
kubectl apply -f main-instance/01-synapse/secrets.yaml
kubectl apply -f main-instance/01-synapse/main-statefulset.yaml
kubectl apply -f main-instance/01-synapse/services.yaml
# Wait for ready...

# Workers
kubectl apply -f main-instance/02-workers/synchrotron-deployment.yaml
kubectl apply -f main-instance/02-workers/generic-worker-deployment.yaml
kubectl apply -f main-instance/02-workers/event-persister-deployment.yaml
kubectl apply -f main-instance/02-workers/federation-sender-deployment.yaml
# Wait for ready...

# HAProxy
kubectl apply -f main-instance/03-haproxy/deployment.yaml
# Wait for ready...

# Clients
kubectl apply -f main-instance/02-element-web/deployment.yaml
kubectl apply -f main-instance/06-coturn/deployment.yaml
kubectl apply -f main-instance/07-sygnal/deployment.yaml
kubectl apply -f main-instance/08-key-vault/deployment.yaml
```

**Day 8: LI Instance (30 min)**
```bash
# Sync System
kubectl apply -f li-instance/04-sync-system/deployment.yaml
# Run replication setup job...

# LI Synapse + Clients
kubectl apply -f li-instance/01-synapse-li/deployment.yaml
kubectl apply -f li-instance/02-element-web-li/deployment.yaml
kubectl apply -f li-instance/03-synapse-admin-li/deployment.yaml
```

**Day 9: Monitoring (30 min)**
```bash
# Install Prometheus + Grafana via Helm
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring --values values/prometheus-stack-values.yaml

# Deploy ServiceMonitors
kubectl apply -f monitoring/01-prometheus/servicemonitors.yaml
kubectl apply -f monitoring/01-prometheus/prometheusrules.yaml
kubectl apply -f monitoring/02-grafana/dashboards-configmap.yaml
```

**Day 10: Antivirus (30 min)**
```bash
kubectl apply -f antivirus/01-clamav/deployment.yaml
kubectl apply -f antivirus/02-scan-workers/deployment.yaml
```

**Day 11: Testing (2-4 hours)**
1. Verify all pods running: `kubectl get pods -n matrix`
2. Create first user
3. Login via Element Web
4. Send test message
5. Test voice call
6. Test media upload (check AV scanning)
7. Check Grafana dashboards
8. Test LI instance (see deleted messages)

**Day 12: Production Readiness**
1. Configure DNS for your domains
2. Test federation
3. Create additional users
4. Set up monitoring alerts
5. Document your deployment

### Ongoing: Operations

**Weekly:**
- Check Grafana dashboards
- Review Prometheus alerts
- Monitor disk space

**Monthly:**
- Update ClamAV virus definitions (automatic)
- Review logs for errors
- Check backups

**Quarterly:**
- Rotate secrets (docs/SECRETS-MANAGEMENT.md)
- Update Synapse version (docs/OPERATIONS-UPDATE-GUIDE.md)
- Review resource usage, scale if needed

---

## Summary: The Big Picture

1. **You build a production Matrix homeserver** with HA, LI compliance, monitoring, antivirus
2. **You follow a linear path**: Prepare â†’ Setup â†’ Configure â†’ Deploy (5 phases) â†’ Verify
3. **Configuration is the key**: Generate secrets, update YAML files, configure domains
4. **Deployment is mostly automated**: kubectl apply commands in correct order
5. **Each component has a purpose**: Nothing is optional except LiveKit (group calls)
6. **The system is resilient**: PostgreSQL failover, Redis HA, MinIO erasure coding
7. **Security is built-in**: Zero-trust networking, TLS everywhere, AV scanning
8. **Compliance is guaranteed**: LI instance preserves all deleted data
9. **Observability is complete**: Prometheus, Grafana, Loki for full visibility
10. **You own and control everything**: No vendor lock-in, runs on your infrastructure

**Total time investment**: ~40-60 hours from zero to production-ready homeserver

**Ongoing effort**: ~2-4 hours/month for maintenance

**Result**: Enterprise-grade Matrix deployment serving 100-20,000+ users

---

**Questions or need clarification?** Re-read the relevant sections of this document or consult the specific README files in each directory.
