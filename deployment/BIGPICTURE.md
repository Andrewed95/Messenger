# The Big Picture: Your Complete Matrix/Synapse Deployment Journey

**This document provides the high-level conceptual view of your entire deployment journey from start to finish.**

---

## ğŸ“– Table of Contents

1. [What Are You Building?](#what-are-you-building)
2. [The Complete Journey](#the-complete-journey)
3. [Architecture & Component Diagrams](#architecture--component-diagrams)
4. [Directory Structure Explained](#directory-structure-explained)
5. [Configuration Overview](#configuration-overview)
6. [The Data Flow](#the-data-flow)
7. [Why Each Component Exists](#why-each-component-exists)
8. [Final Topology Diagram](#final-topology-diagram)

---

## What Are You Building?

You're building a **production-grade Matrix homeserver** with these capabilities:

### ğŸ¯ Core Features
- **Secure messaging**: End-to-end encrypted chat
- **Federation**: Connect with other Matrix servers
- **Voice/Video calls**: Built-in calling with LiveKit
- **Real-time sync**: Long-polling via /sync endpoint (push notifications require external servers)
- **Media storage**: Images, videos, files via MinIO S3
- **Web interface**: Element Web client

### ğŸ”’ Enterprise Features
- **Lawful Intercept (LI)**: Separate read-only instance for compliance
- **Message retention**: Deleted messages preserved for legal requirements
- **Key recovery**: E2EE backup key storage
- **Audit trail**: Complete monitoring and logging

### ğŸ—ï¸ Infrastructure Features
- **High Availability**: Automatic failover for database, cache, storage
- **Scalable**: Support for growing concurrent user base
- **Secure**: Zero-trust networking, TLS everywhere, antivirus scanning
- **Observable**: Prometheus metrics, Grafana dashboards, Loki logs

---

## The Complete Journey

Here's your path from zero to a running production Matrix homeserver:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YOUR DEPLOYMENT JOURNEY                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“š PREP 0: UNDERSTAND & PREPARE
   â”œâ”€ Read this document (BIGPICTURE.md)
   â”œâ”€ Understand what you're building
   â””â”€ Gather prerequisites (servers, domains, etc.)
        â†“
ğŸ”§ PREP 1: SETUP FOUNDATION
   â”œâ”€ Determine resource requirements (docs/SCALING-GUIDE.md)
   â”œâ”€ Setup management node (docs/00-WORKSTATION-SETUP.md)
   â””â”€ Deploy Kubernetes cluster (docs/00-KUBERNETES-INSTALLATION-DEBIAN-OVH.md)
        â†“
âš™ï¸ PREP 2: CONFIGURATION
   â”œâ”€ Generate secrets
   â”œâ”€ Update YAML files with secrets
   â”œâ”€ Configure domains
   â”œâ”€ Verify storage class
   â””â”€ Review all parameters
        â†“
ğŸš€ PHASE 1: INFRASTRUCTURE DEPLOYMENT
   â”œâ”€ PostgreSQL (main + LI databases)
   â”œâ”€ Redis Sentinel (caching + workers)
   â”œâ”€ MinIO (S3-compatible object storage)
   â””â”€ Networking (ingress, TLS, network policies)
        â†“
ğŸ’¬ PHASE 2: MAIN INSTANCE DEPLOYMENT
   â”œâ”€ Synapse main process
   â”œâ”€ Synapse workers (8 types + 1 optional)
   â”‚   â”œâ”€ synchrotron (sync requests)
   â”‚   â”œâ”€ generic-worker (client API)
   â”‚   â”œâ”€ media-repository (media handling)
   â”‚   â”œâ”€ event-persister (database writes)
   â”‚   â”œâ”€ typing-writer (typing indicators)
   â”‚   â”œâ”€ todevice-writer (E2EE key exchange)
   â”‚   â”œâ”€ receipts-writer (read receipts)
   â”‚   â”œâ”€ presence-writer (online status)
   â”‚   â””â”€ federation-sender (OPTIONAL - only if federation enabled)
   â”œâ”€ HAProxy (load balancer)
   â”œâ”€ Element Web (chat interface)
   â”œâ”€ coturn (NAT traversal for peer-to-peer calls)
   â””â”€ LiveKit (group video/voice calls via Element Call)
        â†“
ğŸ” PHASE 3: LI INSTANCE DEPLOYMENT
   â”œâ”€ Sync system (pg_dump/pg_restore periodic sync)
   â”œâ”€ Synapse LI (writable instance for password resets)
   â”œâ”€ Element Web LI (shows deleted messages)
   â”œâ”€ Synapse Admin LI (forensics interface)
   â””â”€ key_vault (E2EE recovery - in LI network)
        â†“
ğŸ“Š PHASE 4: MONITORING DEPLOYMENT
   â”œâ”€ Prometheus (metrics collection)
   â”œâ”€ Grafana (dashboards)
   â””â”€ Loki (log aggregation)
        â†“
ğŸ›¡ï¸ PHASE 5: ANTIVIRUS DEPLOYMENT
   â”œâ”€ ClamAV (virus scanner)
   â””â”€ Content Scanner (media proxy with AV)
        â†“
âœ… VERIFY: TESTING & VALIDATION
   â”œâ”€ Verify all pods running
   â”œâ”€ Create first user
   â”œâ”€ Test login via Element Web
   â”œâ”€ Test federation
   â””â”€ Check monitoring dashboards
        â†“
ğŸ‰ PRODUCTION READY!
```

---

## Architecture & Component Diagrams

### 1. **The Foundation Layer** (Phase 1: Infrastructure)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INFRASTRUCTURE LAYER                            â”‚
â”‚                  (Foundation for Everything)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATABASE: PostgreSQL (CloudNativePG)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Main Cluster (HA)   â”‚          â”‚   LI Cluster         â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”â”‚          â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”      â”‚       â”‚
â”‚  â”‚  â”‚ P  â”‚â”€â”‚ R  â”‚â”€â”‚ R  â”‚â”‚          â”‚  â”‚ P  â”‚â”€â”‚ R  â”‚      â”‚       â”‚
â”‚  â”‚  â”‚RI  â”‚ â”‚ EP â”‚ â”‚ EP â”‚â”‚          â”‚  â”‚RI  â”‚ â”‚ EP â”‚      â”‚       â”‚
â”‚  â”‚  â”‚ MA â”‚ â”‚ LI â”‚ â”‚ LI â”‚â”‚          â”‚  â”‚ MA â”‚ â”‚ LI â”‚      â”‚       â”‚
â”‚  â”‚  â”‚ RY â”‚ â”‚ CA â”‚ â”‚ CA â”‚â”‚â”€pg_dumpâ”€â”€â”¤  â”‚ RY â”‚ â”‚ CA â”‚      â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜â”‚ restore  â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚  â”‚  Auto-failover       â”‚          â”‚  Writable (LI only)  â”‚       â”‚
â”‚  â”‚  Sync replication    â”‚          â”‚  Periodic sync       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  Files: infrastructure/01-postgresql/                              â”‚
â”‚  Purpose: Store all messages, users, rooms, state                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CACHE & QUEUE: Redis Sentinel                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚        â”‚
â”‚  â”‚  â”‚ Redis  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Redis  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Redis  â”‚          â”‚        â”‚
â”‚  â”‚  â”‚ Master â”‚      â”‚ Replicaâ”‚      â”‚ Replicaâ”‚          â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚        â”‚
â”‚  â”‚      â”‚                                                 â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚        â”‚
â”‚  â”‚  â”‚  Sentinel (monitors + auto-failover)     â”‚        â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Files: infrastructure/02-redis/                                   â”‚
â”‚  Purpose: Cache hot data, worker communication, presence           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OBJECT STORAGE: MinIO (S3-compatible)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Distributed MinIO - EC:4 (Erasure Coding)            â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”             â”‚        â”‚
â”‚  â”‚  â”‚ Node â”‚  â”‚ Node â”‚  â”‚ Node â”‚  â”‚ Node â”‚             â”‚        â”‚
â”‚  â”‚  â”‚  1   â”‚  â”‚  2   â”‚  â”‚  3   â”‚  â”‚  4   â”‚             â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜             â”‚        â”‚
â”‚  â”‚  Distributed across nodes with fault tolerance        â”‚        â”‚
â”‚  â”‚  Erasure coding provides data redundancy              â”‚        â”‚
â”‚  â”‚  Buckets: synapse-media, postgresql-backups          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Files: infrastructure/03-minio/                                   â”‚
â”‚  Purpose: Store uploaded media (images, videos, files)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NETWORKING: Ingress + TLS + Security                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  NGINX Ingress Controller                             â”‚        â”‚
â”‚  â”‚  â”œâ”€ Routes external traffic                           â”‚        â”‚
â”‚  â”‚  â”œâ”€ TLS termination                                   â”‚        â”‚
â”‚  â”‚  â””â”€ Load balancing                                    â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚  cert-manager                                          â”‚        â”‚
â”‚  â”‚  â”œâ”€ Automatic TLS certificate generation              â”‚        â”‚
â”‚  â”‚  â””â”€ Let's Encrypt integration                         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Files: infrastructure/04-networking/                              â”‚
â”‚  Purpose: Ingress routing and TLS certificate management           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What this phase provides:**
- **Location**: `infrastructure/` directory
- **Purpose**: Deploy databases, cache, storage, networking - the foundation that Synapse builds upon
- **Configuration**: Primarily secrets and storage class configuration (done in Phase 2)
- **Outcome**: A secure, highly-available data platform ready for the Matrix homeserver

---

### 2. **The Main Instance** (Phase 2: Your Production Homeserver)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MAIN INSTANCE                              â”‚
â”‚                   (Your Production Homeserver)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            INTERNET
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  NGINX Ingress       â”‚
                    â”‚  (TLS termination)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HAProxy                                  â”‚
â”‚              (Intelligent Request Router)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Routes by URL pattern:                                â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/client/*/sync      â†’ Synchrotron Workers  â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/client/* (other)   â†’ Generic Workers      â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/media/download     â†’ Content Scanner (AV) â”‚     â”‚
â”‚  â”‚  â€¢ /_matrix/media/upload       â†’ Media Workers        â”‚     â”‚
â”‚  â”‚  â€¢ /_synapse/admin/*           â†’ Synapse Main         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  Files: main-instance/03-haproxy/                               â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚                         â”‚                                  â”‚
   â–¼                         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Synapse     â”‚    â”‚      SCALABLE WORKERS          â”‚   â”‚  STREAM WRITERS  â”‚
â”‚   Main       â”‚    â”‚  (HPA auto-scaling)            â”‚   â”‚  (Fixed replicas)â”‚
â”‚  Process     â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚    â”‚ Synchrotron    â”‚ Generic      â”‚   â”‚ Event Persisters â”‚
â”‚ Handles:     â”‚    â”‚ (4-16 pods)    â”‚ (2-16 pods)  â”‚   â”‚ Federation Senderâ”‚
â”‚â€¢ Config      â”‚    â”‚ â€¢ /sync        â”‚ â€¢ Client API â”‚   â”‚ Typing Writer    â”‚
â”‚â€¢ Background  â”‚    â”‚ â€¢ /events      â”‚ â€¢ Search     â”‚   â”‚ ToDevice Writer  â”‚
â”‚â€¢ Replication â”‚    â”‚ â€¢ Real-time    â”‚ â€¢ Profiles   â”‚   â”‚ Receipts Writer  â”‚
â”‚              â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ Presence Writer  â”‚
â”‚              â”‚    â”‚ Media Workers  â”‚ Content      â”‚   â”‚                  â”‚
â”‚              â”‚    â”‚ (2-8 pods)     â”‚ Scanner      â”‚   â”‚ (StatefulSets -  â”‚
â”‚              â”‚    â”‚ â€¢ Uploads      â”‚ â€¢ AV scan    â”‚   â”‚  require config  â”‚
â”‚              â”‚    â”‚ â€¢ Thumbnails   â”‚ â€¢ Downloads  â”‚   â”‚  changes to scaleâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚                            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Redis Sentinel    â”‚
                     â”‚ (Worker Replication)â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   PostgreSQL       â”‚
                     â”‚   (Main Cluster)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Files: main-instance/01-synapse/ and main-instance/02-workers/
Purpose: Handle all Matrix protocol operations

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SUPPORTING SERVICES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Element Web                  â”‚  Web-based Matrix client           â”‚
â”‚  Files: main-instance/02-element-web/                              â”‚
â”‚  Purpose: User interface for chat, accessible via browser          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  coturn (TURN/STUN)           â”‚  NAT traversal for calls           â”‚
â”‚  Files: main-instance/06-coturn/                                   â”‚
â”‚  Purpose: Enable voice/video calls through firewalls               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NOTE: key_vault is deployed in LI INSTANCE (Phase 5)              â”‚
â”‚  Located in LI network for security (per CLAUDE.md requirements)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LiveKit (REQUIRED)           â”‚  Group video/voice via Element Callâ”‚
â”‚  Files: main-instance/04-livekit/                                  â”‚
â”‚  Purpose: Group calls, screen sharing via Element Call             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What this phase provides:**
- **Location**: `main-instance/` directory
- **Purpose**: Deploy the actual Matrix homeserver with all supporting services
- **Configuration**: Secrets, domains, and service-specific settings (configured in Phase 2)
- **Outcome**: A fully functional Matrix homeserver accepting chat, calls, media uploads

---

### 3. **The LI (Lawful Intercept) Instance** (Phase 3: Compliance)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAWFUL INTERCEPT INSTANCE                       â”‚
â”‚              (Compliance & Legal Requirements)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SYNC SYSTEM                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Component 1: Database Sync (pg_dump/pg_restore)        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚  Main DB       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   LI DB        â”‚          â”‚  â”‚
â”‚  â”‚  â”‚  (Primary)     â”‚ pg_dump â”‚  (Writable     â”‚          â”‚  â”‚
â”‚  â”‚  â”‚                â”‚ restore â”‚   Copy)        â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚  â€¢ Periodic sync via CronJob (configurable interval)    â”‚  â”‚
â”‚  â”‚  â€¢ Manual sync trigger via Synapse Admin LI             â”‚  â”‚
â”‚  â”‚  â€¢ Deleted messages PRESERVED in LI DB                  â”‚  â”‚
â”‚  â”‚  â€¢ LI admin can reset passwords (overwritten on sync)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Component 2: Media Access (Shared MinIO)               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚
â”‚  â”‚  â”‚  Main MinIO    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”‚
â”‚  â”‚  â”‚  Bucket        â”‚          LI Synapse reads directly  â”‚  â”‚
â”‚  â”‚  â”‚  synapse-media â”‚          via S3 API (no sync)       â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚
â”‚  â”‚  â€¢ LI uses main MinIO directly (no separate bucket)     â”‚  â”‚
â”‚  â”‚  â€¢ Real-time access without sync lag                    â”‚  â”‚
â”‚  â”‚  â€¢ WARNING: LI must NOT modify media (affects main)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: Sync built into synapse-li (see synapse-li/sync/)      â”‚
â”‚  Purpose: Ensure LI instance has ALL data including deleted    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SYNAPSE LI INSTANCE                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Writable Synapse instance (for password resets)      â”‚  â”‚
â”‚  â”‚  â€¢ Points to LI database (copy from main)               â”‚  â”‚
â”‚  â”‚  â€¢ Uses main MinIO bucket (shared, read-only access)    â”‚  â”‚
â”‚  â”‚  â€¢ LI admin can reset user passwords for lawful access  â”‚  â”‚
â”‚  â”‚  â€¢ Shows ALL messages (including "deleted" ones)        â”‚  â”‚
â”‚  â”‚  â€¢ Password changes overwritten on next sync            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: li-instance/01-synapse-li/                             â”‚
â”‚  Purpose: Forensics access with admin password reset           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   USER INTERFACES FOR LI                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Element Web LI                                          â”‚  â”‚
â”‚  â”‚  â€¢ Connects to Synapse LI                                â”‚  â”‚
â”‚  â”‚  â€¢ Shows deleted messages in UI                          â”‚  â”‚
â”‚  â”‚  â€¢ Read-only interface                                   â”‚  â”‚
â”‚  â”‚  Files: li-instance/02-element-web-li/                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Synapse Admin LI                                        â”‚  â”‚
â”‚  â”‚  â€¢ Admin interface for forensics                         â”‚  â”‚
â”‚  â”‚  â€¢ User search, room inspection                          â”‚  â”‚
â”‚  â”‚  â€¢ Full audit trail access                               â”‚  â”‚
â”‚  â”‚  Files: li-instance/03-synapse-admin-li/                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KEY_VAULT SERVICE                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  key_vault (E2EE Recovery Key Storage)                   â”‚  â”‚
â”‚  â”‚  â€¢ Stores encrypted recovery keys (RSA 2048-bit)        â”‚  â”‚
â”‚  â”‚  â€¢ SQLite database (low I/O, simple deployment)         â”‚  â”‚
â”‚  â”‚  â€¢ Located in LI network for isolation                  â”‚  â”‚
â”‚  â”‚  â€¢ Cross-network access model:                          â”‚  â”‚
â”‚  â”‚    - Synapse main (main network) â†’ STORE keys           â”‚  â”‚
â”‚  â”‚    - LI admin (LI network) â†’ RETRIEVE keys              â”‚  â”‚
â”‚  â”‚  Files: li-instance/05-key-vault/                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Purpose: Enable E2EE recovery for lawful intercept            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ACCESS MODEL                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  key_vault access:                                       â”‚  â”‚
â”‚  â”‚  â€¢ Synapse main can STORE recovery keys                 â”‚  â”‚
â”‚  â”‚  â€¢ LI admin can RETRIEVE keys for E2EE recovery         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  LI instance:                                            â”‚  â”‚
â”‚  â”‚  â€¢ Uses separate PostgreSQL database (LI)               â”‚  â”‚
â”‚  â”‚  â€¢ Shares main MinIO for media (read-only access)       â”‚  â”‚
â”‚  â”‚  â€¢ Has own Redis instance for caching                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Purpose: LI operates independently with synced data           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What this phase provides:**
- **Location**: `li-instance/` directory
- **Purpose**: Deploy compliance-ready forensics system with complete message history
- **Configuration**: LI-specific credentials and database/storage endpoints (configured in Phase 2)
- **Outcome**: Legal compliance with preserved deleted messages while maintaining E2EE privacy

**Why this exists**:
- Legal requirement for enterprise deployments
- Preserves deleted messages for law enforcement requests
- Cannot access E2EE keys (privacy preserved for encrypted rooms)
- Completely isolated from main production instance

---

### 4. **Monitoring Stack** (Phase 4: Observability)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONITORING STACK                              â”‚
â”‚                 (Observability & Alerting)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROMETHEUS (Metrics Collection)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Scrapes metrics from:                                   â”‚  â”‚
â”‚  â”‚  â€¢ Synapse (/_synapse/metrics)                           â”‚  â”‚
â”‚  â”‚  â€¢ PostgreSQL (CloudNativePG exporter)                   â”‚  â”‚
â”‚  â”‚  â€¢ Redis (redis-exporter)                                â”‚  â”‚
â”‚  â”‚  â€¢ MinIO (built-in metrics)                              â”‚  â”‚
â”‚  â”‚  â€¢ HAProxy (stats endpoint)                              â”‚  â”‚
â”‚  â”‚  â€¢ Kubernetes (node metrics, pod metrics)                â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Stores metrics history for trend analysis               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: monitoring/01-prometheus/                              â”‚
â”‚  Purpose: Collect and store time-series metrics                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GRAFANA (Visualization)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Dashboards:                                             â”‚  â”‚
â”‚  â”‚  â€¢ Synapse Overview (messages, users, rooms)             â”‚  â”‚
â”‚  â”‚  â€¢ Worker Performance (per-worker metrics)               â”‚  â”‚
â”‚  â”‚  â€¢ PostgreSQL Health (connections, replication lag)      â”‚  â”‚
â”‚  â”‚  â€¢ Redis Performance (cache hit rate, memory)            â”‚  â”‚
â”‚  â”‚  â€¢ MinIO Storage (usage, throughput)                     â”‚  â”‚
â”‚  â”‚  â€¢ LI Instance Status (sync checkpoint, last sync time)   â”‚  â”‚
â”‚  â”‚  â€¢ Federation (outbound/inbound federation health)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: monitoring/02-grafana/                                 â”‚
â”‚  Purpose: Visual dashboards for system health                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOKI (Log Aggregation)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Collects logs from:                                     â”‚  â”‚
â”‚  â”‚  â€¢ All Synapse pods (main + workers)                     â”‚  â”‚
â”‚  â”‚  â€¢ PostgreSQL pods                                       â”‚  â”‚
â”‚  â”‚  â€¢ All infrastructure components                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Configurable retention period                           â”‚  â”‚
â”‚  â”‚  Searchable via Grafana Explore                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: monitoring/03-loki/                                    â”‚
â”‚  Purpose: Centralized log search and analysis                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Access via:     â”‚
                    â”‚  Grafana UI      â”‚
                    â”‚  Web interface   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What this phase provides:**
- **Location**: `monitoring/` directory
- **Purpose**: Deploy comprehensive observability stack with metrics, dashboards, and logs
- **Configuration**: Primarily Helm values for Prometheus/Grafana/Loki installation
- **Outcome**: Complete visibility into system health, performance, and troubleshooting capabilities

---

### 5. **Antivirus Protection** (Phase 5: Security)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ANTIVIRUS SYSTEM                              â”‚
â”‚               (Malware Protection for Media)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLIENT UPLOADS MEDIA
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NGINX Ingress                                 â”‚
â”‚            Routes /_matrix/media/* to Content Scanner            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CONTENT SCANNER (Proxy + Scanner)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Receive media upload/download request               â”‚  â”‚
â”‚  â”‚  2. Check cache: Was this file already scanned?         â”‚  â”‚
â”‚  â”‚     â”œâ”€ Yes, Clean â†’ Serve immediately                   â”‚  â”‚
â”‚  â”‚     â”œâ”€ Yes, Infected â†’ Return HTTP 403                  â”‚  â”‚
â”‚  â”‚     â””â”€ No â†’ Continue to step 3                          â”‚  â”‚
â”‚  â”‚  3. Forward request to Synapse                          â”‚  â”‚
â”‚  â”‚  4. Scan file with ClamAV                               â”‚  â”‚
â”‚  â”‚  5. If clean: Serve + cache result                      â”‚  â”‚
â”‚  â”‚     If infected: Return HTTP 403 + cache result         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Replicas: Multiple pods for horizontal scaling                â”‚
â”‚  Files: antivirus/02-scan-workers/                             â”‚
â”‚  Purpose: Intercept all media requests for scanning            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ClamAV DaemonSet                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ ClamAV daemon (clamd) - Virus scanning engine        â”‚  â”‚
â”‚  â”‚  â€¢ FreshClam - Auto-update virus definitions            â”‚  â”‚
â”‚  â”‚  â€¢ Extensive virus signature database                   â”‚  â”‚
â”‚  â”‚  â€¢ Scans: executables, archives, PDFs, Office docs      â”‚  â”‚
â”‚  â”‚  â€¢ Deployed on EVERY application node (DaemonSet)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Files: antivirus/01-clamav/                                   â”‚
â”‚  Purpose: Actual virus scanning engine                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What this phase provides:**
- **Location**: `antivirus/` directory
- **Purpose**: Deploy malware protection for all uploaded media files
- **Configuration**: Minimal configuration (default settings are production-ready)
- **Outcome**: Automatic virus scanning for all media uploads/downloads

**Why this exists**:
- Protect users from malware in uploaded files
- Prevent server from becoming malware distribution point
- Compliance requirement for many organizations

---

## Directory Structure Explained

Here's what each directory contains and WHY it exists:

```
deployment/
â”œâ”€â”€ README.md                    â† YOUR STARTING POINT
â”‚   Purpose: Complete deployment guide with all detailed steps
â”‚   When: Read AFTER 00-WORKSTATION-SETUP and 00-KUBERNETES-INSTALLATION
â”‚
â”œâ”€â”€ BIGPICTURE.md               â† YOU ARE HERE
â”‚   Purpose: Understand the conceptual architecture and journey
â”‚   When: Read FIRST to get oriented
â”‚
â”œâ”€â”€ namespace.yaml              â† Creates "matrix" namespace
â”‚   Purpose: Kubernetes namespace where everything deploys
â”‚   When: First deployment step (or auto-applied by scripts)
â”‚
â”œâ”€â”€ infrastructure/             â† PHASE 1: Foundation
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-postgresql/
â”‚   â”‚   â”œâ”€â”€ main-cluster.yaml       â†’ Main database (HA cluster)
â”‚   â”‚   â””â”€â”€ li-cluster.yaml         â†’ LI database (read-only replicas)
â”‚   â”‚   Purpose: Store messages, users, rooms, events
â”‚   â”‚   Configuration: Secrets, storage class, replica count
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-redis/
â”‚   â”‚   â””â”€â”€ redis-statefulset.yaml  â†’ Redis + Sentinel (HA)
â”‚   â”‚   Purpose: Cache hot data, worker communication
â”‚   â”‚   Configuration: Password, memory limits
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-minio/
â”‚   â”‚   â”œâ”€â”€ tenant.yaml             â†’ MinIO cluster (distributed)
â”‚   â”‚   â””â”€â”€ secrets.yaml            â†’ MinIO credentials
â”‚   â”‚   Purpose: S3-compatible object storage for media
â”‚   â”‚   Configuration: Access keys, storage size
â”‚   â”‚
â”‚   â””â”€â”€ 04-networking/
â”‚       â”œâ”€â”€ ingress-install.yaml      â†’ NGINX Ingress configuration
â”‚       â”œâ”€â”€ cert-manager-install.yaml â†’ TLS certificates
â”‚       Purpose: Ingress routing, TLS management
â”‚       Configuration: Domains, TLS issuers
â”‚       Note: Network isolation is org's responsibility (CLAUDE.md 7.4)
â”‚
â”œâ”€â”€ main-instance/              â† PHASE 2: Your Homeserver
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-synapse/
â”‚   â”‚   â”œâ”€â”€ configmap.yaml          â†’ homeserver.yaml + log.yaml
â”‚   â”‚   â”œâ”€â”€ secrets.yaml            â†’ Synapse secrets
â”‚   â”‚   â”œâ”€â”€ main-statefulset.yaml   â†’ Synapse main process
â”‚   â”‚   â”œâ”€â”€ services.yaml           â†’ Kubernetes services
â”‚   â”‚   â””â”€â”€ README.md               â†’ Technical architecture details
â”‚   â”‚   Purpose: Core Matrix homeserver process
â”‚   â”‚   Configuration: Secrets, domains, federation settings
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-element-web/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Element Web UI
â”‚   â”‚   Purpose: Web-based chat interface
â”‚   â”‚   Configuration: Domain, homeserver URL
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-workers/
â”‚   â”‚   â”œâ”€â”€ synchrotron-deployment.yaml         â†’ /sync workers (HPA)
â”‚   â”‚   â”œâ”€â”€ generic-worker-deployment.yaml      â†’ General APIs (HPA)
â”‚   â”‚   â”œâ”€â”€ media-repository-statefulset.yaml   â†’ Media handling
â”‚   â”‚   â”œâ”€â”€ event-persister-deployment.yaml     â†’ DB writes (StatefulSet)
â”‚   â”‚   â”œâ”€â”€ typing-writer-deployment.yaml       â†’ Typing indicators (StatefulSet)
â”‚   â”‚   â”œâ”€â”€ todevice-writer-deployment.yaml     â†’ E2EE key exchange (StatefulSet)
â”‚   â”‚   â”œâ”€â”€ receipts-writer-deployment.yaml     â†’ Read receipts (StatefulSet)
â”‚   â”‚   â”œâ”€â”€ presence-writer-deployment.yaml     â†’ Online status (StatefulSet)
â”‚   â”‚   â””â”€â”€ federation-sender-deployment.yaml   â†’ OPTIONAL: Outbound federation (only if enabled)
â”‚   â”‚   Purpose: 8 worker types + 1 optional (federation-sender)
â”‚   â”‚   Note: synchrotron and generic-worker have HPA; others are StatefulSets
â”‚   â”‚   Configuration: Inherits from main configmap
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-haproxy/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ HAProxy + routing config
â”‚   â”‚   Purpose: Intelligent routing to workers
â”‚   â”‚   Configuration: Worker endpoints, routing rules
â”‚   â”‚
â”‚   â”œâ”€â”€ 04-livekit/
â”‚   â”‚   â””â”€â”€ README.md               â†’ Helm installation reference
â”‚   â”‚   Purpose: Optional high-quality video/voice calls
â”‚   â”‚   Configuration: values/livekit-values.yaml
â”‚   â”‚
â”‚   â”œâ”€â”€ 06-coturn/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ coturn TURN/STUN server
â”‚   â”‚   Purpose: NAT traversal for voice/video calls
â”‚   â”‚   Configuration: Shared secret, domains, port ranges
â”‚   â”‚
â”‚   # NOTE: key_vault is in li-instance/05-key-vault/ (LI network)
â”‚
â”œâ”€â”€ li-instance/                â† PHASE 3: Compliance
â”‚   â”‚
â”‚   â”œâ”€â”€ 00-redis-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Isolated Redis for LI
â”‚   â”‚   Purpose: LI cache (separate from main, no HA required)
â”‚   â”‚   Configuration: Redis password
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-synapse-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Writable Synapse instance
â”‚   â”‚   Purpose: Forensics access with password reset capability
â”‚   â”‚   Configuration: LI database/MinIO endpoints
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-element-web-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Element Web for LI
â”‚   â”‚   Purpose: UI showing deleted messages
â”‚   â”‚   Configuration: Domain, LI homeserver URL
â”‚   â”‚
â”‚   â”œâ”€â”€ 03-synapse-admin-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Admin interface
â”‚   â”‚   Purpose: Forensics and user management
â”‚   â”‚   Configuration: LI homeserver URL
â”‚   â”‚
â”‚   â”œâ”€â”€ 04-sync-system/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Sync config (built into synapse-li)
â”‚   â”‚   Purpose: Keep LI database synchronized with main
â”‚   â”‚   Configuration: DB credentials (media uses main MinIO directly)
â”‚   â”‚
â”‚   â”œâ”€â”€ 05-key-vault/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ E2EE key backup service
â”‚   â”‚   Purpose: Store encrypted recovery keys (SQLite)
â”‚   â”‚   Configuration: API keys, Django secret, RSA encryption key
â”‚   â”‚   Access: Synapse main (store) + LI admin (retrieve)
â”‚   â”‚
â”‚   â”œâ”€â”€ 06-nginx-li/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Independent LI reverse proxy
â”‚   â”‚   Purpose: Route traffic to LI services (works when main is down)
â”‚   â”‚   Configuration: TLS certificates, upstream services
â”‚   â”‚
â”‚   â””â”€â”€ README.md               â†’ Complete LI architecture guide
â”‚       Purpose: Deep dive into LI design and compliance
â”‚
â”œâ”€â”€ monitoring/                 â† PHASE 4: Observability
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-prometheus/
â”‚   â”‚   â””â”€â”€ servicemonitors.yaml    â†’ Auto-discover metrics endpoints
â”‚   â”‚   Purpose: Metrics collection
â”‚   â”‚   Configuration: Via Helm (values/prometheus-stack-values.yaml)
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-grafana/
â”‚   â”‚   â””â”€â”€ dashboards-configmap.yaml â†’ Pre-built dashboards
â”‚   â”‚   Purpose: Visualization and dashboards
â”‚   â”‚   Configuration: Via Helm values
â”‚   â”‚
â”‚   â””â”€â”€ 03-loki/
â”‚       â””â”€â”€ README.md               â†’ Helm installation reference
â”‚       Purpose: Log aggregation
â”‚       Configuration: values/loki-values.yaml
â”‚
â”œâ”€â”€ antivirus/                  â† PHASE 5: Security
â”‚   â”‚
â”‚   â”œâ”€â”€ 01-clamav/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ ClamAV DaemonSet
â”‚   â”‚   Purpose: Virus scanning engine on every node
â”‚   â”‚   Configuration: Auto-updates, resource limits
â”‚   â”‚
â”‚   â”œâ”€â”€ 02-scan-workers/
â”‚   â”‚   â””â”€â”€ deployment.yaml         â†’ Content Scanner workers
â”‚   â”‚   Purpose: Media proxy with AV scanning
â”‚   â”‚   Configuration: ClamAV endpoint, replica count
â”‚   â”‚
â”‚   â””â”€â”€ README.md               â†’ Antivirus architecture
â”‚       Purpose: Understand AV integration
â”‚
â”œâ”€â”€ values/                     â† Helm Chart Values
â”‚   â”‚   All files here: Configuration for Helm-installed components
â”‚   â”‚
â”‚   â”œâ”€â”€ images.yaml                  â†’ Container image references
â”‚   â”œâ”€â”€ prometheus-stack-values.yaml â†’ Prometheus + Grafana config
â”‚   â”œâ”€â”€ loki-values.yaml             â†’ Loki config
â”‚   â”œâ”€â”€ cloudnativepg-values.yaml    â†’ PostgreSQL operator
â”‚   â”œâ”€â”€ minio-operator-values.yaml   â†’ MinIO operator
â”‚   â”œâ”€â”€ metallb-values.yaml          â†’ Load balancer IPs
â”‚   â”œâ”€â”€ nginx-ingress-values.yaml    â†’ Ingress controller
â”‚   â”œâ”€â”€ cert-manager-values.yaml     â†’ TLS certificate manager
â”‚   â”œâ”€â”€ redis-synapse-values.yaml    â†’ Redis for Synapse
â”‚   â”œâ”€â”€ redis-livekit-values.yaml    â†’ Redis for LiveKit
â”‚   â””â”€â”€ livekit-values.yaml          â†’ LiveKit media server
â”‚
â”œâ”€â”€ scripts/                    â† Automation Scripts
â”‚   â”œâ”€â”€ deploy-all.sh           â†’ Automated multi-phase deployment
â”‚   â”œâ”€â”€ validate-deployment.sh  â†’ Comprehensive health checks
â”‚   â”œâ”€â”€ validate-changeme.sh    â†’ Validate all CHANGEME placeholders replaced
â”‚   â””â”€â”€ README.md               â†’ Script documentation
â”‚
â””â”€â”€ docs/                       â† Reference Documentation
    â”‚
    â”œâ”€â”€ 00-WORKSTATION-SETUP.md        â†’ REQUIRED: Setup kubectl, helm
    â”œâ”€â”€ 00-KUBERNETES-INSTALLATION-DEBIAN-OVH.md â†’ REQUIRED: K8s cluster
    â”œâ”€â”€ SCALING-GUIDE.md               â†’ REQUIRED: Determine resources
    â”‚
    â”œâ”€â”€ PRE-DEPLOYMENT-CHECKLIST.md    â†’ RECOMMENDED: Pre-flight checks
    â”œâ”€â”€ SERVICE-CONFIGURATION-GUIDE.md â†’ Optional: Service config details
    â”œâ”€â”€ WORKER-SCALING-GUIDE.md        â†’ Optional: Synapse worker tuning
    â”œâ”€â”€ CONFIGURATION-REFERENCE.md     â†’ Optional: All parameters explained
    â”œâ”€â”€ OPERATIONS-UPDATE-GUIDE.md     â†’ Optional: Updates and maintenance
    â”œâ”€â”€ SECRETS-MANAGEMENT.md          â†’ Optional: Advanced secrets (Vault)
    â”œâ”€â”€ HAPROXY-ARCHITECTURE.md        â†’ Optional: HAProxy routing details
    â””â”€â”€ MATRIX-AUTHENTICATION-SERVICE.md â†’ Optional: Enterprise SSO
```

---

## Configuration Overview

### High-Level Configuration Areas

During **Phase 2: Configuration**, you'll prepare the deployment by editing specific files. The main README.md provides detailed step-by-step instructions, but here's the conceptual overview:

#### 1. **Secrets Management**

You need to generate and configure secrets across multiple components:

| Component Area | What Needs Configuration | Purpose |
|----------------|-------------------------|---------|
| Synapse | Registration shared secret, macaroon secret key, form secret, signing key | Core homeserver authentication and security |
| PostgreSQL | Database passwords for main and LI clusters | Database access control |
| Redis | Redis password | Cache access control |
| MinIO | Root credentials, application access keys | Object storage authentication |
| coturn | Shared secret for TURN authentication | VoIP relay access control |
| key_vault | API keys, Django secret, encryption key | E2EE backup security |
| LI Instance | Database credentials, sync configuration | Compliance system access |

**Conceptual approach**: Generate strong random secrets and systematically update all `CHANGEME_*` placeholders in YAML files.

#### 2. **Domain Configuration**

Your deployment will be accessed via domain names. You'll need to:

- Configure your primary Matrix server domain (server_name)
- Set up subdomains for various services (Element Web, Grafana, etc.)
- Update Ingress resources with actual domain names
- Configure TLS certificates for each domain
- Update service URLs in homeserver configuration

**Conceptual approach**: Replace all `example.com` references with your actual domain throughout the YAML files.

#### 3. **Storage Configuration**

The deployment uses Kubernetes persistent volumes:

- Verify your cluster has a default `StorageClass`
- Optionally specify custom storage classes for databases, media, etc.
- Configure storage sizes based on your scale requirements

**Conceptual approach**: Ensure storage infrastructure is ready before deployment begins.

#### 4. **Scaling Parameters**

Based on your expected user load (see SCALING-GUIDE.md):

- Adjust replica counts for workers
- Configure resource requests/limits for pods
- Scale database storage sizes
- Tune MinIO node count and storage per node

**Conceptual approach**: Start with baseline configuration, scale up as needed.

---

## The Data Flow

### How a Message Flows Through Your System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MESSAGE SEND FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER SENDS MESSAGE
   â””â”€ Element Web UI (browser)
        â”‚
        â–¼
2. HTTPS REQUEST
   â””â”€ POST /_matrix/client/r0/rooms/{roomId}/send/m.room.message
        â”‚
        â–¼
3. NGINX INGRESS
   â””â”€ TLS termination, forward to HAProxy
        â”‚
        â–¼
4. HAPROXY (Intelligent Request Router)
   â””â”€ Check URL pattern and route to appropriate worker:
      â””â”€ /_matrix/client/*/sync â†’ Synchrotron Workers
      â””â”€ /_matrix/client/* (other) â†’ Generic Workers
      â””â”€ /_matrix/media/download â†’ Content Scanner (AV)
      â””â”€ /_matrix/media/upload â†’ Media Workers
      â””â”€ /_synapse/admin/* â†’ Synapse Main Process
        â”‚
        â–¼
5. WORKER PROCESSES REQUEST
   â””â”€ Generic/Synchrotron validates request
   â””â”€ Check permissions (Redis cache first)
   â””â”€ Events routed to appropriate stream writer:
      â””â”€ Messages â†’ Event Persister Workers
      â””â”€ Typing â†’ Typing Writer Workers
      â””â”€ Read receipts â†’ Receipts Writer Workers
      â””â”€ Presence â†’ Presence Writer Workers
      â””â”€ E2EE keys â†’ ToDevice Writer Workers
        â”‚
        â–¼
6. STREAM WRITER WORKERS
   â””â”€ Batch multiple events
   â””â”€ Write to PostgreSQL (main cluster)
        â”‚
        â–¼
7. POSTGRESQL MAIN
   â””â”€ Store event in events table
   â””â”€ Data synced to LI periodically via pg_dump/pg_restore
        â”‚
        â–¼
8. POSTGRESQL LI DATABASE
   â””â”€ Receives periodic sync (pg_dump/pg_restore)
   â””â”€ Event visible in LI after next sync
   â””â”€ LI admin can trigger manual sync via Synapse Admin LI
        â”‚
        â–¼
9. GENERIC WORKER
   â””â”€ Get event ID from Event Persister
   â””â”€ Return success to client
   â””â”€ Notify other clients via /sync endpoint
        â”‚
        â–¼
10. SYNC WORKERS
    â””â”€ Connected clients receive message update
    â””â”€ Element Web displays message

PARALLEL: If message has media attachment
    â””â”€ Media upload â†’ Content Scanner â†’ ClamAV scan â†’ MinIO storage
    â””â”€ LI accesses same MinIO bucket directly (no replication needed)
```

### How a Voice Call Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VOICE/VIDEO CALL FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER INITIATES CALL
   â””â”€ Element Web requests TURN credentials
        â”‚
        â–¼
2. SYNAPSE MAIN
   â””â”€ Generate TURN credentials using shared secret
   â””â”€ Return credentials to client
        â”‚
        â–¼
3. CLIENTS ESTABLISH PEER CONNECTION
   â””â”€ Try direct connection (STUN)
   â””â”€ If NAT prevents direct: Use TURN relay
        â”‚
        â–¼
4. COTURN (TURN Server)
   â””â”€ Relay media packets between clients
   â””â”€ Authenticate using credentials from step 2
        â”‚
        â–¼
5. MEDIA STREAMING
   â””â”€ WebRTC peer-to-peer (or via TURN)
   â””â”€ Audio/video flows between clients
        â”‚
        â–¼
6. CALL EVENTS
   â””â”€ Call start/end sent as Matrix events
   â””â”€ Follows normal message flow

GROUP CALLS: LiveKit (required)
   â””â”€ Group calls use LiveKit SFU
   â””â”€ Better performance for multi-party calls
   â””â”€ Screen sharing support
```

---

## Why Each Component Exists

### Infrastructure Layer

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **PostgreSQL Main** | Store all messages, users, rooms | Nothing works - Synapse won't start |
| **PostgreSQL LI** | Compliance - preserve deleted data | LI instance won't work, compliance failure |
| **Redis Sentinel** | Cache hot data, worker communication | Slow performance, workers can't coordinate |
| **MinIO** | Store uploaded media (images/videos) | Can't upload files, media won't work |
| **NGINX Ingress** | TLS termination, external access | Can't access from internet |
| **cert-manager** | Automatic TLS certificates | Manual cert management, HTTPS breaks |

### Main Instance

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **Synapse Main** | Core process, config loading | Nothing works |
| **Sync Workers** | Handle /sync (long-polling) | Slow real-time updates, main process overloaded |
| **Generic Workers** | Handle client APIs | Main process overloaded, poor performance |
| **Event Persisters** | Batch DB writes | Slow message sending, DB contention |
| **Federation Senders** | Outbound federation | Can't send to other servers |
| **HAProxy** | Route requests to correct workers | Can't use workers, main process does everything |
| **Element Web** | User interface | Can use other clients, but no web UI |
| **coturn** | NAT traversal for peer-to-peer calls | Peer-to-peer calls won't work through firewalls |
| **LiveKit** | Group video/voice calls | Group calls via Element Call won't work |

### LI Instance

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **Sync System** | Sync data from main to LI | LI instance has no data |
| **Synapse LI** | Access all data + reset passwords | Can't access deleted messages or reset passwords |
| **Element Web LI** | UI for forensics | Can't view LI data easily |
| **Synapse Admin LI** | Admin/forensics + sync trigger | Limited search, no manual sync |
| **key_vault** | E2EE recovery key storage | LI cannot decrypt E2EE messages |

### Monitoring

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **Prometheus** | Metrics collection | No visibility into system health |
| **Grafana** | Dashboards | Can't visualize metrics |
| **Loki** | Log aggregation | Can't search logs across pods |

### Antivirus

| Component | Why It Exists | What Happens If You Remove It |
|-----------|---------------|-------------------------------|
| **ClamAV** | Virus scanning | Malware can be uploaded |
| **Content Scanner** | Intercept media requests | Media goes directly to storage unscanned |

---

## Final Topology Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              THE COMPLETE SYSTEM                                       â”‚
â”‚                         (All Components Connected)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    INTERNET
                                       â”‚
                                       â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                             â”‚
                  [Federation]                   [End Users]
                 (Other Matrix                 (Browsers,
                   Servers)                    Mobile Apps)
                        â”‚                             â”‚
                        â”‚                             â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   NGINX Ingress Controller   â”‚
                        â”‚   (TLS Termination)          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                      â”‚                      â”‚
                â–¼                      â–¼                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Element Web  â”‚      â”‚   HAProxy    â”‚      â”‚Content Scannerâ”‚
        â”‚   (Main)     â”‚      â”‚ (Routing)    â”‚      â”‚   + ClamAV   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                    â”‚
                â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           SYNAPSE MAIN INSTANCE                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Synapse  â”‚  â”‚     Synapse Workers        â”‚ â”‚
    â”‚  â”‚   Main   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚
    â”‚  â”‚ Process  â”‚  â”‚  â”‚Sync â”‚  â”‚Genericâ”‚ â”‚Eventâ”‚ â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚Work â”‚  â”‚Worker â”‚ â”‚Pers â”‚ â”‚ â”‚
    â”‚       â”‚        â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚                                        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                â”‚                â”‚
            â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PostgreSQL  â”‚ â”‚    Redis     â”‚ â”‚    MinIO     â”‚
    â”‚     Main     â”‚ â”‚   Sentinel   â”‚ â”‚ (S3 Storage) â”‚
    â”‚  (HA cluster)â”‚ â”‚  (HA cluster)â”‚ â”‚ (Distributed)â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                  â”‚
           â”‚ pg_dump/pg_restore              â”‚ Direct S3 access
           â”‚ (periodic sync)                  â”‚ (shared bucket)
           â–¼                                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚ PostgreSQL   â”‚                          â”‚
    â”‚     LI       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (Writable)   â”‚  LI Synapse uses main MinIO
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  (no separate LI bucket)
           â”‚
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            LI INSTANCE (Forensics)             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Synapse  â”‚  â”‚ Element  â”‚  â”‚   Synapse    â”‚ â”‚
    â”‚  â”‚    LI    â”‚  â”‚  Web LI  â”‚  â”‚   Admin LI   â”‚ â”‚
    â”‚  â”‚(Writable)â”‚  â”‚(Shows    â”‚  â”‚  (Forensics) â”‚ â”‚
    â”‚  â”‚ Instance)â”‚  â”‚Deleted)  â”‚  â”‚              â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         MONITORING STACK (Separate NS)         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚Prometheusâ”‚  â”‚ Grafana  â”‚  â”‚     Loki     â”‚ â”‚
    â”‚  â”‚ (Metrics)â”‚â”€â–ºâ”‚(Dashboardâ”‚  â”‚    (Logs)    â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚       â”‚                               â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                               â”‚
            â”‚ Scrapes metrics               â”‚ Collects logs
            â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      ALL COMPONENTS (metrics + logs)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          SUPPORTING SERVICES                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
    â”‚  â”‚ coturn   â”‚  (Main Instance)                â”‚
    â”‚  â”‚ (TURN)   â”‚                                 â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
    â”‚  â”‚  key_vault   â”‚  (LI Instance - see above)  â”‚
    â”‚  â”‚  (E2EE Keys) â”‚  Cross-network from main    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
    â”‚  LiveKit + coturn   â”‚  (Call Servers)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SECURITY HIGHLIGHTS:
ğŸ”’ All traffic TLS encrypted (cert-manager + Let's Encrypt)
ğŸ”’ All media scanned for malware (ClamAV)
ğŸ”’ LI instance uses separate database (synced from main)
ğŸ”’ key_vault stores encrypted E2EE recovery keys
```

---

## Summary: The Big Picture

1. **You build a production Matrix homeserver** with HA, LI compliance, monitoring, antivirus
2. **You follow a linear path**: Prepare â†’ Setup â†’ Configure â†’ Deploy (5 phases) â†’ Verify
3. **Configuration is the key**: Generate secrets, update YAML files, configure domains
4. **Deployment follows a sequence**: Infrastructure first, then main instance, then LI, then observability, then security
5. **Each component has a purpose**: All components are required for full functionality
6. **The system is resilient**: PostgreSQL failover, Redis HA, MinIO erasure coding
7. **Security is built-in**: TLS everywhere, antivirus scanning
8. **Compliance is guaranteed**: LI instance preserves all deleted data
9. **Observability is complete**: Prometheus, Grafana, Loki for full visibility
10. **You own and control everything**: No vendor lock-in, runs on your infrastructure

**Result**: Enterprise-grade Matrix deployment for your specified scale requirements

---

**For detailed step-by-step deployment instructions, see the main README.md**

**For specific component details, see the README.md file in each directory**

**Questions or need clarification?** Consult the relevant sections of this document or the specific README files in each directory.
