# ============================================================================
# DEPLOYMENT CONFIGURATION TEMPLATE
# ============================================================================
# Copy this file to config.env and customize for your organization
# DO NOT commit config.env to git (contains org-specific values)
#
# Usage:
#   cp config.env.example config.env
#   nano config.env  # Edit values
#   source config.env
#   ./scripts/deploy-all.sh
#

# ============================================================================
# ORGANIZATION INFORMATION
# ============================================================================

# Organization name (used in labels and monitoring)
ORG_NAME="example-org"

# Deployment environment (prod, staging, dev)
ENVIRONMENT="prod"

# ============================================================================
# DOMAIN CONFIGURATION
# ============================================================================

# Main Matrix homeserver domain
# Users will have IDs like @user:MATRIX_DOMAIN
MATRIX_DOMAIN="matrix.example.com"

# Element Web domain (client interface)
ELEMENT_DOMAIN="chat.example.com"

# Synapse Admin domain (for LI access to admin panel)
ADMIN_DOMAIN="admin.example.com"

# TURN server domain for WebRTC voice/video calls
# CRITICAL: Must be externally reachable by clients (not internal k8s DNS)
# coturn uses hostNetwork:true, so configure DNS for this domain to point to your node IPs
TURN_DOMAIN="turn.matrix.example.com"

# LiveKit domain for video conferencing (WebSocket endpoint)
LIVEKIT_DOMAIN="livekit.matrix.example.com"

# NOTE: Main instance does NOT have Synapse Admin (only LI has it)
# Admin API is available at /_synapse/admin/ on the main Synapse
# See li-instance/ for Synapse Admin LI

# LI Instance domains (lawful intercept environment)
# IMPORTANT: LI uses SAME domains as main instance
# Access control is via network isolation, NOT different domains
# The organization configures separate DNS in LI network to point to LI Ingress
# See li-instance/README.md and docs/PRE-DEPLOYMENT-CHECKLIST.md for details
LI_SYNAPSE_DOMAIN="${MATRIX_DOMAIN}"     # Same as main
LI_ELEMENT_DOMAIN="${ELEMENT_DOMAIN}"     # Same as main
LI_ADMIN_DOMAIN="${ADMIN_DOMAIN}"         # Same as main (admin panel only in LI network)

# ============================================================================
# SCALING PARAMETERS
# ============================================================================

# Expected concurrent users (100, 1000, 5000, 10000, 20000)
# Used to calculate resource allocations and replica counts
EXPECTED_CCU=1000

# Synapse worker replica counts (calculated based on CCU)
# Guidelines:
#   100 CCU: synchrotron=2, generic=2, event-persister=2
#   1K CCU: synchrotron=4, generic=4, event-persister=2
#   5K CCU: synchrotron=8, generic=6, event-persister=3
#   10K CCU: synchrotron=12, generic=8, event-persister=4
#   20K CCU: synchrotron=16, generic=10, event-persister=4

REPLICAS_SYNCHROTRON=4
REPLICAS_GENERIC_WORKER=4
REPLICAS_EVENT_PERSISTER=2
REPLICAS_FEDERATION_SENDER=2
REPLICAS_MEDIA_REPOSITORY=2
REPLICAS_TYPING_WRITER=2
REPLICAS_TODEVICE_WRITER=2
REPLICAS_RECEIPTS_WRITER=2
REPLICAS_PRESENCE_WRITER=2

# PostgreSQL configuration
POSTGRESQL_REPLICAS=3  # HA: 3 replicas (1 primary + 2 replicas)
POSTGRESQL_STORAGE_SIZE="100Gi"  # 100 CCU: 50Gi, 1K: 100Gi, 5K: 200Gi, 10K: 500Gi, 20K: 1Ti

# Redis Sentinel configuration
REDIS_REPLICAS=3  # HA: 3 replicas (1 primary + 2 replicas)
REDIS_SENTINEL_REPLICAS=3  # Sentinel quorum: 3 sentinels

# MinIO distributed storage
MINIO_SERVERS=4  # Minimum 4 for EC:4 erasure coding
MINIO_VOLUMES_PER_SERVER=2  # 2 volumes per server = 8 total drives
MINIO_STORAGE_SIZE="500Gi"  # Per volume. 100 CCU: 200Gi, 1K: 500Gi, 5K: 1Ti, 10K: 2Ti

# ============================================================================
# RESOURCE LIMITS
# ============================================================================

# Synapse main process
SYNAPSE_MAIN_CPU_REQUEST="2000m"
SYNAPSE_MAIN_CPU_LIMIT="4000m"
SYNAPSE_MAIN_MEMORY_REQUEST="4Gi"
SYNAPSE_MAIN_MEMORY_LIMIT="8Gi"

# Synapse workers (per pod)
SYNAPSE_WORKER_CPU_REQUEST="500m"
SYNAPSE_WORKER_CPU_LIMIT="2000m"
SYNAPSE_WORKER_MEMORY_REQUEST="1Gi"
SYNAPSE_WORKER_MEMORY_LIMIT="2Gi"

# PostgreSQL (per pod)
POSTGRESQL_CPU_REQUEST="2000m"
POSTGRESQL_CPU_LIMIT="4000m"
POSTGRESQL_MEMORY_REQUEST="4Gi"
POSTGRESQL_MEMORY_LIMIT="8Gi"

# Redis (per pod)
REDIS_CPU_REQUEST="500m"
REDIS_CPU_LIMIT="1000m"
REDIS_MEMORY_REQUEST="2Gi"
REDIS_MEMORY_LIMIT="4Gi"

# ============================================================================
# KUBERNETES CONFIGURATION
# ============================================================================

# Namespace for main instance
NAMESPACE_MAIN="matrix"

# Namespace for LI instance (same as main, isolation via labels)
NAMESPACE_LI="matrix"  # LI runs in same namespace, isolated by NetworkPolicy labels

# Storage class for persistent volumes
# Use appropriate storage class for your cluster (local-path, nfs, ceph, etc.)
STORAGE_CLASS="local-path"

# ============================================================================
# FEATURE FLAGS
# ============================================================================

# Enable federation (true/false)
# Default: false (per CLAUDE.md Section 12)
ENABLE_FEDERATION="false"

# Enable LI (lawful intercept) instance (true/false)
ENABLE_LI="true"

# Enable monitoring stack (Prometheus, Grafana) (true/false)
ENABLE_MONITORING="true"

# Enable HPA for eligible workers (true/false)
# Only applies to synchrotron and generic-worker (Deployments)
ENABLE_HPA="false"

# ============================================================================
# BACKUP CONFIGURATION
# ============================================================================

# Backup server hostname or IP
BACKUP_SERVER="backup.internal.example.com"

# Backup schedule (cron format)
# Default: Daily at 2 AM UTC
BACKUP_SCHEDULE="0 2 * * *"

# Backup retention days
BACKUP_RETENTION_DAYS=30

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================

# TLS certificate mode (letsencrypt-prod, letsencrypt-staging, selfsigned)
# letsencrypt-prod: Production Let's Encrypt certificates
# letsencrypt-staging: Staging Let's Encrypt (for testing)
# selfsigned: Self-signed certificates (air-gapped deployments)
TLS_MODE="selfsigned"

# Network policies enabled (true/false)
# Enables zero-trust security with NetworkPolicy objects
ENABLE_NETWORK_POLICIES="true"

# ============================================================================
# LI CONFIGURATION (Lawful Intercept)
# ============================================================================

# Maximum concurrent sessions per user
# Applies to ALL users without exception
# Recommended: 5-10 for typical deployments
MAX_SESSIONS_PER_USER=5

# Endpoint protection (prevent users from forgetting rooms or deactivating accounts)
# true: Only admins can forget rooms or deactivate accounts
# false: Users can forget rooms and deactivate their own accounts
LI_ENDPOINT_PROTECTION="true"

# ============================================================================
# ADVANCED CONFIGURATION
# ============================================================================

# PostgreSQL connection pool size per worker
# Total connections = (workers x cp_max) + main process connections
# Must stay under PostgreSQL max_connections (default 500)
# Conservative: 10, Moderate: 20, Aggressive: 30
POSTGRESQL_CP_MAX=10

# Synapse cache factor (multiplier for cache sizes)
# Higher values = more memory usage, better performance
# Default: 2.0 for production
CACHE_FACTOR="2.0"

# Event cache size
# Higher values = more memory, fewer database queries
# Default: 50K for production
EVENT_CACHE_SIZE="50K"

# ============================================================================
# ANTIVIRUS CONFIGURATION
# ============================================================================

# Content scanner pickle key (for encrypted media support)
# Generate with: openssl rand -hex 32
CONTENT_SCANNER_PICKLE_KEY="CHANGEME_CONTENT_SCANNER_PICKLE_KEY"

# ============================================================================
# NOTES
# ============================================================================
# After editing:
# 1. Source this file: source deployment/config.env
# 2. Run deployment: ./deployment/scripts/deploy-all.sh
# 3. Verify: ./deployment/scripts/validate-deployment.sh
#
# IMPORTANT: Add config.env to .gitignore to prevent committing org-specific values
