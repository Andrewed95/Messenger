# cert-manager Helm Values
# Matrix/Synapse Production Deployment (Scalable 100 CCU - 20K+ CCU)

# ============================================================================
# CRITICAL: cert-manager automates TLS certificate management
# - Automatic certificate issuance and renewal
# - Supports Let's Encrypt, self-signed, and custom CAs
# - Integration with Ingress for automatic HTTPS
# ============================================================================

# ============================================================================
# INSTALLATION
# ============================================================================
# helm repo add jetstack https://charts.jetstack.io
# helm install cert-manager jetstack/cert-manager \
#   --namespace cert-manager \
#   --create-namespace \
#   --set installCRDs=true \
#   --values cert-manager-values.yaml

# ============================================================================
# GLOBAL CONFIGURATION
# ============================================================================

global:
  # Pod security policy
  podSecurityPolicy:
    enabled: false  # PSP deprecated in K8s 1.25+

  # Leader election namespace
  leaderElection:
    namespace: cert-manager

# ============================================================================
# INSTALL CRDs
# ============================================================================

installCRDs: true  # Install CustomResourceDefinitions

# ============================================================================
# REPLICA COUNT
# ============================================================================

replicaCount: 2  # HA deployment

# ============================================================================
# RESOURCES
# ============================================================================

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# ============================================================================
# WEBHOOK CONFIGURATION
# ============================================================================

webhook:
  enabled: true

  replicaCount: 2

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ============================================================================
# CAINJECTOR CONFIGURATION
# ============================================================================

cainjector:
  enabled: true

  replicaCount: 2

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ============================================================================
# STARTUPAPICHECK
# ============================================================================

startupapicheck:
  enabled: true

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ============================================================================
# POD ANTI-AFFINITY
# ============================================================================

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - cert-manager
          topologyKey: kubernetes.io/hostname

# ============================================================================
# PROMETHEUS MONITORING
# ============================================================================
# NOTE: ServiceMonitor requires Prometheus Operator CRDs to be installed first.
# During initial installation, use: --set prometheus.servicemonitor.enabled=false
# After Prometheus is installed (Phase 4), upgrade with: helm upgrade cert-manager ...
# without the --set flag to enable ServiceMonitor.

prometheus:
  enabled: true

  servicemonitor:
    enabled: true
    namespace: monitoring
    interval: 60s

# ============================================================================
# CLUSTER ISSUER CONFIGURATION
# ============================================================================
# After cert-manager installation, create ClusterIssuers.
#
# Per CLAUDE.md 4.5: Initial deployment uses Let's Encrypt with cert-manager.
# Certificate renewal after deployment is the organization's responsibility.
#
# Apply the ClusterIssuers from infrastructure/04-networking/cert-manager-install.yaml:
#   kubectl apply -f infrastructure/04-networking/cert-manager-install.yaml
#
# This creates:
#   - letsencrypt-prod: Production certificates (default for initial deployment)
#   - letsencrypt-staging: Staging certificates (for testing, higher rate limits)
#   - selfsigned: Self-signed certificates (fallback only)

# ============================================================================
# CERTIFICATE REQUEST EXAMPLE
# ============================================================================
# Ingress with automatic certificate:
#
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: matrix-ingress
#   annotations:
#     cert-manager.io/cluster-issuer: letsencrypt-prod
#     # OR for staging (higher rate limits during testing):
#     # cert-manager.io/cluster-issuer: letsencrypt-staging
# spec:
#   ingressClassName: nginx
#   tls:
#   - hosts:
#     - chat.example.com
#     secretName: matrix-tls  # cert-manager will create this
#   rules:
#   - host: chat.example.com
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: synapse
#             port:
#               number: 8008

# ============================================================================
# TROUBLESHOOTING
# ============================================================================
# View cert-manager logs:
# kubectl logs -n cert-manager -l app=cert-manager
#
# Check certificate status:
# kubectl get certificate -A
# kubectl describe certificate <name> -n <namespace>
#
# Check certificate requests:
# kubectl get certificaterequest -A
# kubectl describe certificaterequest <name> -n <namespace>
#
# View ClusterIssuers:
# kubectl get clusterissuer
# kubectl describe clusterissuer <name>
#
# Manual certificate renewal:
# kubectl delete certificaterequest <name> -n <namespace>
# Certificate will be automatically recreated
#
# Check certificate expiry:
# kubectl get secret <tls-secret> -n <namespace> -o jsonpath='{.data.tls\.crt}' | base64 -d | openssl x509 -noout -enddate
# ============================================================================
