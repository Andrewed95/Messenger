---
# Network Policies for Zero-Trust Security
# Implements strict access control between components

###############################################################################
# 1. Default Deny All Traffic
#    Foundation policy - denies all ingress/egress by default
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: security
spec:
  podSelector: {}  # Applies to all pods in namespace
  policyTypes:
    - Ingress
    - Egress

---
###############################################################################
# 2. Allow DNS Resolution
#    All pods need DNS for service discovery
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: dns
spec:
  podSelector: {}  # All pods
  policyTypes:
    - Egress
  egress:
    - to:
        # Allow DNS to kube-system namespace (CoreDNS/kube-dns)
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    - to:
        # Alternative: Allow to any pod in kube-system namespace
        # Some clusters use different labels for DNS
        - podSelector: {}
          namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
###############################################################################
# 3. PostgreSQL Main Access Control
#    Only authorized pods can access main PostgreSQL cluster
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-main-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: database
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: matrix-postgresql
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse main instance
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 5432

    # Allow from key_vault
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: key-vault
      ports:
        - protocol: TCP
          port: 5432

    # Allow internal cluster replication
    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

---
###############################################################################
# 4. PostgreSQL LI Access Control
#    Only LI instance components can access LI PostgreSQL
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-li-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: database
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: matrix-postgresql-li
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse LI instance
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 5432

    # Allow from sync system
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sync-system
      ports:
        - protocol: TCP
          port: 5432

    # Allow internal cluster replication
    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 5432

---
###############################################################################
# 5. Redis Access Control
#    Only authorized pods can access Redis/Sentinel
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: cache
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse main instance (all workers)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 26379  # Sentinel

    # Allow from LiveKit
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: livekit
      ports:
        - protocol: TCP
          port: 6379

    # Allow from key_vault
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: key-vault
      ports:
        - protocol: TCP
          port: 6379

    # Allow internal Redis cluster communication
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379

---
###############################################################################
# 6. MinIO Access Control
#    Only authorized pods can access S3 storage
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: minio-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: storage
spec:
  podSelector:
    matchLabels:
      v1.min.io/tenant: matrix-minio
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse main (media storage)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 9000  # S3 API

    # Allow from PostgreSQL for backups
    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 9000

    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 9000

    # Allow from sync system (rclone for LI media sync)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sync-system
      ports:
        - protocol: TCP
          port: 9000

    # Allow internal MinIO cluster communication
    - from:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow access to console (port 9090) from admin pods only
    - from:
        - podSelector:
            matchLabels:
              role: admin
      ports:
        - protocol: TCP
          port: 9090

---
###############################################################################
# 7. KEY_VAULT CRITICAL ISOLATION ⭐⭐⭐
#    MOST IMPORTANT: Only Synapse main can access key_vault
#    LI instance and all other pods MUST NOT access key_vault
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: key-vault-isolation
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: security-critical
  annotations:
    description: "CRITICAL: Ensures only Synapse main can access encrypted recovery keys"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: key-vault
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # ONLY allow from Synapse main instance
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 8000  # Django HTTP

  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow PostgreSQL main access (for key_vault database)
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow Redis access (for Django sessions)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379

---
###############################################################################
# 8. LI Instance Isolation ⭐⭐
#    IMPORTANT: LI instance CANNOT access main instance resources
#    Can only access LI-specific PostgreSQL and MinIO
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: li-instance-isolation
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: security-critical
  annotations:
    description: "Ensures LI instance only accesses LI-specific resources"
spec:
  podSelector:
    matchLabels:
      matrix.instance: li
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow ONLY LI PostgreSQL (NOT main PostgreSQL)
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 5432

    # Allow MinIO access (read-only access to LI bucket)
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

---
###############################################################################
# 9. Synapse Main Egress Policy
#    Synapse main can access required services
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-main-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: application
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: synapse
      matrix.instance: main
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow PostgreSQL main
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379

    # Allow MinIO
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow key_vault
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: key-vault
      ports:
        - protocol: TCP
          port: 8000

    # Allow LiveKit (for MatrixRTC)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: livekit
      ports:
        - protocol: TCP
          port: 7880

    # Allow Sygnal (push notifications)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sygnal
      ports:
        - protocol: TCP
          port: 5000

    # Allow coturn (TURN/STUN)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: coturn
      ports:
        - protocol: TCP
          port: 3478
        - protocol: UDP
          port: 3478

    # Allow federation (port 8448) - outbound to internet
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8448

    # Allow HTTPS for federation (port 443)
    - ports:
        - protocol: TCP
          port: 443

---
###############################################################################
# 10. Allow Traffic from Ingress Controller
#     Ingress controller needs to route traffic to services
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-ingress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: ingress
spec:
  podSelector:
    matchLabels:
      ingress-accessible: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        # Allow from ingress-nginx namespace
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["ingress-nginx"]
        # Also allow from any pod with the ingress controller label
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
          namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8008  # Synapse main
        - protocol: TCP
          port: 8448  # Synapse federation
        - protocol: TCP
          port: 80    # Element Web
        - protocol: TCP
          port: 9090  # MinIO console

---
###############################################################################
# 11. Allow Prometheus Scraping
#     Prometheus needs to scrape metrics from all components
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: monitoring
spec:
  podSelector:
    matchLabels:
      prometheus-scrape: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        # Allow from monitoring namespace
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["monitoring"]
        # Allow from Prometheus pods anywhere
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
          namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 9090  # Synapse metrics
        - protocol: TCP
          port: 9187  # PostgreSQL exporter
        - protocol: TCP
          port: 9121  # Redis exporter
        - protocol: TCP
          port: 9000  # MinIO metrics

---
###############################################################################
# 12. Antivirus Scanner Access
#     ClamAV and scan workers communication
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: antivirus-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: antivirus
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: clamav
  policyTypes:
    - Ingress
  ingress:
    # Allow from scan workers
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: content-scanner
      ports:
        - protocol: TCP
          port: 3310  # ClamAV clamd

    # Allow from Synapse (via spam checker module)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
      ports:
        - protocol: TCP
          port: 8080  # Scan worker HTTP API

---
###############################################################################
# 14. HAProxy Load Balancer Egress
#     HAProxy needs to access Synapse main and all workers
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: haproxy-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: load-balancer
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: haproxy
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow access to all Synapse pods (main and workers)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
      ports:
        - protocol: TCP
          port: 8008  # Synapse HTTP
        - protocol: TCP
          port: 8009  # Synapse replication
        - protocol: TCP
          port: 9000  # Synapse metrics

---
###############################################################################
# 15. Synapse Workers Egress
#     Workers need access to databases, Redis, MinIO, and external federation
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-workers-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: workers
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: synapse
      app.kubernetes.io/type: worker
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow PostgreSQL access
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow Redis access
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379  # Sentinel

    # Allow MinIO access
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow access to Synapse main for replication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: main
      ports:
        - protocol: TCP
          port: 9093  # Replication

    # Allow external federation (if federation sender)
    - to: []  # Allow all external for federation
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8448  # Matrix federation port

---
###############################################################################
# 16. Content Scanner Access
#     Content scanner needs to be accessible by Synapse media workers
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: content-scanner-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: antivirus
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: content-scanner
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Synapse media repository workers
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: media-repository
      ports:
        - protocol: TCP
          port: 8080

    # Allow from Synapse main (if it's handling media)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: main
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow ClamAV access
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: clamav
      ports:
        - protocol: TCP
          port: 3310  # ClamAV daemon port

    # Allow Synapse media repository workers (to proxy media)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: media-repository
      ports:
        - protocol: TCP
          port: 8008

---
###############################################################################
# 17. Sync System Access
#     Sync system needs access to both main and LI PostgreSQL and MinIO
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sync-system-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: sync
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: sync-system
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow main PostgreSQL access
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow LI PostgreSQL access
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 5432

    # Allow MinIO access for rclone sync
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000
