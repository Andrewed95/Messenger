---
# Network Policies for Zero-Trust Security
# Implements strict access control between components

###############################################################################
# 1. Default Deny All Traffic
#    Foundation policy - denies all ingress/egress by default
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: security
spec:
  podSelector: {}  # Applies to all pods in namespace
  policyTypes:
    - Ingress
    - Egress

---
###############################################################################
# 2. Allow DNS Resolution
#    All pods need DNS for service discovery
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: dns
spec:
  podSelector: {}  # All pods
  policyTypes:
    - Egress
  egress:
    - to:
        # Allow DNS to kube-system namespace (CoreDNS/kube-dns)
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    - to:
        # Alternative: Allow to any pod in kube-system namespace
        # Some clusters use different labels for DNS
        - podSelector: {}
          namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
###############################################################################
# 3. PostgreSQL Main Access Control
#    Only authorized pods can access main PostgreSQL cluster
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-main-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: database
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: matrix-postgresql
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse main instance
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 5432

    # key_vault uses SQLite (no PostgreSQL access needed)

    # Allow internal cluster replication
    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

---
###############################################################################
# 4. PostgreSQL LI Access Control
#    Only LI instance components can access LI PostgreSQL
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-li-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: database
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: matrix-postgresql-li
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse LI instance
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 5432

    # Allow from sync system
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sync-system
      ports:
        - protocol: TCP
          port: 5432

    # Allow internal cluster replication
    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 5432

---
###############################################################################
# 5. Redis Access Control
#    Only authorized pods can access Redis/Sentinel
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: cache
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse main instance (all workers)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 26379  # Sentinel

    # Allow from LiveKit
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: livekit
      ports:
        - protocol: TCP
          port: 6379

    # key_vault uses SQLite (no Redis access needed)
    # LI instance uses dedicated Redis LI (see redis-li-access policy)

    # Allow from sync-system
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sync-system
      ports:
        - protocol: TCP
          port: 6379

    # Allow from content-scanner (antivirus scan result cache)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: content-scanner
      ports:
        - protocol: TCP
          port: 6379

    # Allow internal Redis cluster communication
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379

---
###############################################################################
# 6. MinIO Access Control
#    Only authorized pods can access S3 storage
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: minio-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: storage
spec:
  podSelector:
    matchLabels:
      v1.min.io/tenant: matrix-minio
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse main (media storage)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 9000  # S3 API

    # Allow from Synapse LI (media read access - shared bucket)
    # LI uses main MinIO directly for media access
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 9000  # S3 API

    # Allow from PostgreSQL for backups
    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 9000

    - from:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 9000

    # Allow from sync system (for PostgreSQL backup access)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sync-system
      ports:
        - protocol: TCP
          port: 9000

    # Allow internal MinIO cluster communication
    - from:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow access to console (port 9090) from admin pods only
    - from:
        - podSelector:
            matchLabels:
              role: admin
      ports:
        - protocol: TCP
          port: 9090

---
###############################################################################
# 7. KEY_VAULT ACCESS CONTROL ⭐⭐⭐
#    key_vault is located in LI network (per CLAUDE.md requirements)
#
#    ACCESS MODEL:
#    - Synapse main (main network): Can STORE recovery keys when users set up E2EE
#    - LI admin (LI network): Can RETRIEVE recovery keys for lawful intercept
#    - All other access: BLOCKED
#
#    DATABASE: SQLite (local file) - no external database access needed
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: key-vault-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: security-critical
  annotations:
    description: |
      key_vault is in LI network. Access controlled as follows:
      - Synapse main: STORE keys (cross-network, NetworkPolicy allows)
      - LI admin: RETRIEVE keys (within LI network)
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: key-vault
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 1. Allow from Synapse main instance (for STORING recovery keys)
    #    This is cross-network access: main network → LI network
    #    Required when users set up E2EE, Synapse stores encrypted recovery key
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: main
      ports:
        - protocol: TCP
          port: 8000  # Django HTTP API

    # 2. Allow from LI Synapse Admin (for RETRIEVING recovery keys)
    #    LI admin uses this to get encrypted keys for lawful intercept
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse-admin
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 8000

    # 3. Allow from nginx-li (reverse proxy for LI admin access)
    #    nginx-li routes requests from LI administrators to key_vault
    #    CRITICAL: synapse-li must NOT access key_vault (per CLAUDE.md 3.3)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nginx
              app.kubernetes.io/instance: li
      ports:
        - protocol: TCP
          port: 8000

  egress:
    # Allow DNS only - SQLite database requires no external connections
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # NOTE: No PostgreSQL or Redis egress needed - using SQLite

---
###############################################################################
# 7.5. Redis LI Access Control
#     Only LI instance can access Redis LI (isolated from main Redis)
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-li-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: cache
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
      app.kubernetes.io/instance: li
  policyTypes:
    - Ingress
  ingress:
    # Allow from Synapse LI instance ONLY
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 6379

---
###############################################################################
# 8. LI Instance Isolation ⭐⭐
#    IMPORTANT: LI instance accesses LI-specific database and Redis,
#    but uses MAIN MinIO for media (read-only access via S3 credentials)
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: li-instance-isolation
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: security-critical
  annotations:
    description: "Controls LI instance access to shared and LI-specific resources"
spec:
  podSelector:
    matchLabels:
      matrix.instance: li
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow ONLY LI PostgreSQL (NOT main PostgreSQL)
    # Database is separate to allow LI admin to reset passwords
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql-li
      ports:
        - protocol: TCP
          port: 5432

    # Allow MAIN MinIO (LI uses main MinIO directly for media)
    # WARNING: LI admins must NOT modify/delete media - affects main instance!
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow Redis LI ONLY (NOT main Redis - prevents info leakage via pub/sub)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
              app.kubernetes.io/instance: li
      ports:
        - protocol: TCP
          port: 6379

---
###############################################################################
# 9. Synapse Main Egress Policy
#    Synapse main can access required services
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-main-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: application
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: synapse
      matrix.instance: main
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow PostgreSQL main
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379

    # Allow MinIO
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow key_vault
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: key-vault
      ports:
        - protocol: TCP
          port: 8000

    # Allow LiveKit (for MatrixRTC)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: livekit
      ports:
        - protocol: TCP
          port: 7880

    # NOTE: Sygnal (push notifications) intentionally NOT included
    # Per CLAUDE.md Rule 4.3: No external services (air-gapped deployment)
    # Push notifications require Apple/Google server connectivity

    # Allow coturn (TURN/STUN)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: coturn
      ports:
        - protocol: TCP
          port: 3478
        - protocol: UDP
          port: 3478

    # Allow federation (port 8448) - outbound to internet
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8448

    # Allow HTTPS for federation (port 443)
    - ports:
        - protocol: TCP
          port: 443

---
###############################################################################
# 10. Allow Traffic from Ingress Controller
#     Ingress controller needs to route traffic to services
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-ingress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: ingress
spec:
  podSelector:
    matchLabels:
      ingress-accessible: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        # Allow from ingress-nginx namespace
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["ingress-nginx"]
        # Also allow from any pod with the ingress controller label
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
          namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8008  # Synapse main
        - protocol: TCP
          port: 8448  # Synapse federation
        - protocol: TCP
          port: 80    # Element Web
        - protocol: TCP
          port: 9090  # MinIO console

---
###############################################################################
# 11. Allow Prometheus Scraping
#     Prometheus needs to scrape metrics from all components
#     This policy allows monitoring namespace to scrape metrics ports on ALL pods
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: monitoring
spec:
  # Apply to ALL pods in matrix namespace (not just labeled ones)
  # This ensures Prometheus can scrape all metrics endpoints
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        # Allow from monitoring namespace
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["monitoring"]
        # Allow from Prometheus pods anywhere
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
          namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 9090  # Synapse metrics
        - protocol: TCP
          port: 9187  # PostgreSQL exporter
        - protocol: TCP
          port: 9121  # Redis exporter
        - protocol: TCP
          port: 9000  # MinIO metrics
        - protocol: TCP
          port: 9810  # ClamAV exporter
        - protocol: TCP
          port: 8404  # HAProxy stats

---
###############################################################################
# 12. Antivirus Scanner Access
#     ClamAV and scan workers communication
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: antivirus-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: antivirus
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: clamav
  policyTypes:
    - Ingress
  ingress:
    # Allow from content scanner workers (virus scanning)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: content-scanner
      ports:
        - protocol: TCP
          port: 3310  # ClamAV clamd port

---
###############################################################################
# 14. HAProxy Load Balancer Egress
#     HAProxy needs to access Synapse main and all workers
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: haproxy-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: load-balancer
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: haproxy
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow access to all Synapse pods (main and workers)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
      ports:
        - protocol: TCP
          port: 8008  # Synapse HTTP API
        - protocol: TCP
          port: 9090  # Synapse metrics (for stats backend)

    # Allow access to content scanner (antivirus proxy for media downloads)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: content-scanner
      ports:
        - protocol: TCP
          port: 8080  # Content scanner HTTP API

---
###############################################################################
# 15. Synapse Workers Egress
#     Workers need access to databases, Redis, MinIO, and external federation
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: synapse-workers-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: workers
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: synapse
      app.kubernetes.io/type: worker
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow PostgreSQL access
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: matrix-postgresql
      ports:
        - protocol: TCP
          port: 5432

    # Allow Redis access
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379  # Sentinel

    # Allow MinIO access
    - to:
        - podSelector:
            matchLabels:
              v1.min.io/tenant: matrix-minio
      ports:
        - protocol: TCP
          port: 9000

    # Allow access to Synapse main for replication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: homeserver
      ports:
        - protocol: TCP
          port: 9093  # Replication

    # Allow external federation (if federation sender)
    - to: []  # Allow all external for federation
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8448  # Matrix federation port

---
###############################################################################
# 16. Content Scanner Access
#     Content scanner needs to be accessible by Synapse media workers
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: content-scanner-access
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: antivirus
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: content-scanner
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from HAProxy (routes media downloads through scanner)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: haproxy
      ports:
        - protocol: TCP
          port: 8080

    # Allow from Synapse media repository workers
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: media-repository
      ports:
        - protocol: TCP
          port: 8080

    # Allow from Synapse main (if it's handling media)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: homeserver
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow ClamAV access
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: clamav
      ports:
        - protocol: TCP
          port: 3310  # ClamAV daemon port

    # Allow Synapse media repository workers (to proxy media)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: media-repository
      ports:
        - protocol: TCP
          port: 8008

# NOTE: Sync System NetworkPolicy is defined in sync-system-networkpolicy.yaml
# That file contains the complete sync-system-access policy with Redis access

---
###############################################################################
# 17. nginx-li Reverse Proxy (LI Instance)
#     Independent reverse proxy for LI - operates separately from main ingress
#     CRITICAL: Required for LI independence from main instance
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nginx-li-egress
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: li-reverse-proxy
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nginx
      app.kubernetes.io/instance: li
  policyTypes:
    - Egress
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values: ["kube-system"]
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # Allow access to Synapse LI (homeserver)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse
              app.kubernetes.io/component: homeserver
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 8008

    # Allow access to Element Web LI
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: element-web
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 80

    # Allow access to Synapse Admin LI
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: synapse-admin
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 80

    # Allow access to key_vault
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: key-vault
              matrix.instance: li
      ports:
        - protocol: TCP
          port: 8000

---
###############################################################################
# 18. Allow LI Services to Receive Traffic from nginx-li
#     All LI services need to accept ingress from nginx-li reverse proxy
###############################################################################
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-nginx-li
  namespace: matrix
  labels:
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/component: li-reverse-proxy
spec:
  podSelector:
    matchLabels:
      matrix.instance: li
  policyTypes:
    - Ingress
  ingress:
    # From nginx-li reverse proxy
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: nginx
              app.kubernetes.io/instance: li
      ports:
        - protocol: TCP
          port: 8008  # Synapse LI
        - protocol: TCP
          port: 80    # Element Web LI, Synapse Admin LI
        - protocol: TCP
          port: 8000  # key_vault
